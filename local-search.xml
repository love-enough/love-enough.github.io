<?xml version="1.0" encoding="utf-8"?>
<search>
  
  
  
  <entry>
    <title>å¸¸è§çš„è´Ÿè½½å‡è¡¡ç®—æ³•å®ç°</title>
    <link href="/2024/07/23/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/"/>
    <url>/2024/07/23/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/</url>
    
    <content type="html"><![CDATA[<h1 id="è´Ÿè½½å‡è¡¡ç®—æ³•"><a href="#è´Ÿè½½å‡è¡¡ç®—æ³•" class="headerlink" title="è´Ÿè½½å‡è¡¡ç®—æ³•"></a>è´Ÿè½½å‡è¡¡ç®—æ³•</h1><blockquote><p><strong>è´Ÿè½½å‡è¡¡</strong> æŒ‡çš„æ˜¯å°†ç”¨æˆ·è¯·æ±‚åˆ†æ‘Šåˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Šå¤„ç†ï¼Œä»¥æé«˜ç³»ç»Ÿæ•´ä½“çš„å¹¶å‘å¤„ç†èƒ½åŠ›ä»¥åŠå¯é æ€§ã€‚è´Ÿè½½å‡è¡¡æœåŠ¡å¯ä»¥æœ‰ç”±ä¸“é—¨çš„è½¯ä»¶æˆ–è€…ç¡¬ä»¶æ¥å®Œæˆï¼Œä¸€èˆ¬æƒ…å†µä¸‹ï¼Œç¡¬ä»¶çš„æ€§èƒ½æ›´å¥½ï¼Œè½¯ä»¶çš„ä»·æ ¼æ›´ä¾¿å®œ</p><p>å½“è¯·æ±‚é‡è¿‡å¤§æ—¶ï¼Œå•èŠ‚ç‚¹ä¼šæ— æ³•æ‰¿è½½åºå¤§çš„æµé‡ä»è€Œå´©æºƒã€‚</p><p>æ‰€ä»¥åœ¨ä¸€äº›æµé‡è¾ƒå¤§çš„æœåŠ¡ä¸Šï¼Œæˆ‘ä»¬ä¼šè®¾ç½®å¤šä¸ªèŠ‚ç‚¹æœåŠ¡å™¨å¤„ç†è¯·æ±‚ï¼Œå¹¶ä½¿ç”¨è´Ÿè½½å‡è¡¡çš„æ€æƒ³ å°†è¯·æ±‚åˆ†æ‘Šåˆ°æ¯ä¸ªèŠ‚ç‚¹ä¸Š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/*</span><br><span class="hljs-comment">è´Ÿè½½å‡è¡¡ç®—æ³•æ¥å£</span><br><span class="hljs-comment">*/</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-comment">//è·å–æœåŠ¡å™¨åœ°å€</span><br>    String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span>;<br>    <span class="hljs-comment">//å¢åŠ æœåŠ¡å™¨èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> ;<br>    <span class="hljs-comment">//åˆ é™¤æœåŠ¡å™¨èŠ‚ç‚¹</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="éšæœºç®—æ³•"><a href="#éšæœºç®—æ³•" class="headerlink" title="éšæœºç®—æ³•"></a>éšæœºç®—æ³•</h2><blockquote><p>é€šè¿‡ç³»ç»Ÿçš„éšæœºç®—æ³•ï¼Œæ ¹æ®åç«¯æœåŠ¡å™¨çš„åˆ—è¡¨å¤§å°å€¼æ¥éšæœºé€‰å–å…¶ä¸­çš„ä¸€å°æœåŠ¡å™¨è¿›è¡Œè®¿é—®ã€‚ç”±æ¦‚ç‡ç»Ÿè®¡ç†è®ºå¯ä»¥å¾—çŸ¥ï¼Œéšç€å®¢æˆ·ç«¯è°ƒç”¨æœåŠ¡ç«¯çš„æ¬¡æ•°å¢å¤šï¼Œå…¶å®é™…æ•ˆæœè¶Šæ¥è¶Šæ¥è¿‘äºå¹³å‡åˆ†é…è°ƒç”¨é‡åˆ°åç«¯çš„æ¯ä¸€å°æœåŠ¡å™¨ï¼Œä¹Ÿå°±æ˜¯è½®è¯¢çš„ç»“æœã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RandomLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        Random random=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">choose</span> <span class="hljs-operator">=</span> random.nextInt(addressList.size());<br>        System.out.println(<span class="hljs-string">&quot;è´Ÿè½½å‡è¡¡é€‰æ‹©äº†&quot;</span>+choose+<span class="hljs-string">&quot;æœåŠ¡å™¨&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span>&#123;&#125; ;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span>&#123;&#125;;<br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŸç†</strong>ï¼šéšæœºæ³•å°†è¯·æ±‚éšæœºåˆ†é…åˆ°å„ä¸ªæœåŠ¡å™¨ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>åˆ†é…è¾ƒä¸ºå‡åŒ€ï¼Œé¿å…äº†è½®è¯¢æ³•å¯èƒ½å‡ºç°çš„è¿ç»­è¯·æ±‚åˆ†é…ç»™åŒä¸€å°æœåŠ¡å™¨çš„é—®é¢˜ã€‚</li><li>ä½¿ç”¨ç®€å•ï¼Œä¸éœ€è¦å¤æ‚çš„é…ç½®ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>éšæœºæ€§å¯èƒ½å¯¼è‡´æŸäº›æœåŠ¡å™¨è¢«é¢‘ç¹è®¿é—®ï¼Œè€Œå¦ä¸€äº›æœåŠ¡å™¨åˆ™ç›¸å¯¹è¾ƒå°‘ï¼Œè¿™å–å†³äºéšæœºæ•°çš„ç”Ÿæˆæƒ…å†µã€‚</li><li>å¦‚æœæœåŠ¡å™¨é…ç½®ä¸åŒï¼Œéšæœºæ³•å¯èƒ½å¯¼è‡´è´Ÿè½½ä¸å‡è¡¡ï¼Œå½±å“æ•´ä½“æ€§èƒ½ã€‚</li></ul><h2 id="è½®è¯¢ç®—æ³•"><a href="#è½®è¯¢ç®—æ³•" class="headerlink" title="è½®è¯¢ç®—æ³•"></a>è½®è¯¢ç®—æ³•</h2><blockquote><p>æ ¸å¿ƒæ€æƒ³ï¼š æŠŠæ¥è‡ªè¯·æ±‚è½®æµåˆ†é…ç»™å†…éƒ¨ä¸­çš„æœåŠ¡å™¨ï¼Œä»1å¼€å§‹ï¼Œç›´åˆ°N(å†…éƒ¨æœåŠ¡å™¨ä¸ªæ•°)ï¼Œç„¶åé‡æ–°å¼€å§‹å¾ªç¯ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RoundLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> choose=-<span class="hljs-number">1</span>;<br>    <span class="hljs-comment">//ä¸åŠ é”</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        choose++;<br>        choose=choose%addressList.size();<br>        System.out.println(<span class="hljs-string">&quot;è´Ÿè½½å‡è¡¡é€‰æ‹©äº†&quot;</span>+choose+<span class="hljs-string">&quot;æœåŠ¡å™¨&quot;</span>);<br>        <span class="hljs-keyword">return</span> addressList.get(choose);<br>    &#125;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> &#123;&#125;;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span>&#123;&#125;;<br><br>    <span class="hljs-comment">//åŠ é”</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">balanceWithLock</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        choose++;<br>        <span class="hljs-keyword">if</span>(choose == addressList.size())<br>            choose = <span class="hljs-number">0</span>;<br>        System.out.println(<span class="hljs-string">&quot;è´Ÿè½½å‡è¡¡é€‰æ‹©äº†&quot;</span> + choose + <span class="hljs-string">&quot;æœåŠ¡å™¨&quot;</span>);<br>        <span class="hljs-keyword">return</span> addressList.get(choose);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŸç†</strong>ï¼šè½®è¯¢æ³•å°†æ‰€æœ‰è¯·æ±‚æŒ‰é¡ºåºè½®æµåˆ†é…ç»™åç«¯æœåŠ¡å™¨ï¼Œä¾æ¬¡å¾ªç¯ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>ç®€å•æ˜“å®ç°ã€‚</li><li>æ— çŠ¶æ€ï¼Œä¸ä¿å­˜ä»»ä½•ä¿¡æ¯ï¼Œå› æ­¤å®ç°æˆæœ¬ä½ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>å½“åç«¯æœåŠ¡å™¨æ€§èƒ½å·®å¼‚å¤§æ—¶ï¼Œæ— æ³•æ ¹æ®æœåŠ¡å™¨çš„è´Ÿè½½æƒ…å†µè¿›è¡ŒåŠ¨æ€è°ƒæ•´ï¼Œå¯èƒ½å¯¼è‡´æŸäº›æœåŠ¡å™¨è´Ÿè½½è¿‡å¤§æˆ–è¿‡å°ã€‚</li><li>å¦‚æœæœåŠ¡å™¨é…ç½®ä¸ä¸€æ ·ï¼Œä¸é€‚åˆä½¿ç”¨è½®è¯¢æ³•ã€‚</li></ul><h2 id="IP-Hashç®—æ³•"><a href="#IP-Hashç®—æ³•" class="headerlink" title="IP_Hashç®—æ³•"></a>IP_Hashç®—æ³•</h2><blockquote><p>hash(ip)%Nç®—æ³•ï¼Œé€šè¿‡ä¸€ç§æ•£åˆ—ç®—æ³•æŠŠå®¢æˆ·ç«¯æ¥æºIPæ ¹æ®æ•£åˆ—å–æ¨¡ç®—æ³•å°†è¯·æ±‚åˆ†é…åˆ°ä¸åŒçš„æœåŠ¡å™¨ä¸Š</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IPHashBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        <span class="hljs-comment">//æ­¤ä¸ºå®¢æˆ·ç«¯IPåœ°å€ï¼Œæ¨¡æ‹Ÿæ“ä½œ</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">clientIP</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;127.0.0.1&quot;</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hashCode</span> <span class="hljs-operator">=</span> clientIP.hashCode();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> hashCode % addressList.size();<br>        <span class="hljs-keyword">return</span> addressList.get(index);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> &#123;&#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span> &#123;&#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åŠ æƒè½®è¯¢ç®—æ³•"><a href="#åŠ æƒè½®è¯¢ç®—æ³•" class="headerlink" title="åŠ æƒè½®è¯¢ç®—æ³•"></a>åŠ æƒè½®è¯¢ç®—æ³•</h2><blockquote><p>è¯¥ç®—æ³•ä¸­ï¼Œæ¯ä¸ªæœºå™¨æ¥å—çš„è¿æ¥æ•°é‡æ˜¯æŒ‰æƒé‡æ¯”ä¾‹åˆ†é…çš„ã€‚è¿™æ˜¯å¯¹æ™®é€šè½®è¯¢ç®—æ³•çš„æ”¹è¿›ï¼Œæ¯”å¦‚ä½ å¯ä»¥è®¾å®šï¼šç¬¬ä¸‰å°æœºå™¨çš„å¤„ç†èƒ½åŠ›æ˜¯ç¬¬ä¸€å°æœºå™¨çš„ä¸¤å€ï¼Œé‚£ä¹ˆè´Ÿè½½å‡è¡¡å™¨ä¼šæŠŠä¸¤å€çš„è¿æ¥æ•°é‡åˆ†é…ç»™ç¬¬3å°æœºå™¨ï¼Œè½®è¯¢å¯ä»¥å°†è¯·æ±‚é¡ºåºæŒ‰ç…§æƒé‡åˆ†é…åˆ°åç«¯ã€‚åªæ˜¯åœ¨è·å–æœåŠ¡å™¨åœ°å€ä¹‹å‰å¢åŠ äº†ä¸€æ®µæƒé‡è®¡ç®—çš„ä»£ç ï¼Œæ ¹æ®æƒé‡çš„å¤§å°ï¼Œå°†åœ°å€é‡å¤åœ°å¢åŠ åˆ°æœåŠ¡å™¨åœ°å€åˆ—è¡¨ä¸­ï¼Œæƒé‡è¶Šå¤§ï¼Œè¯¥æœåŠ¡å™¨æ¯è½®æ‰€è·å¾—çš„è¯·æ±‚æ•°é‡è¶Šå¤šã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> åŠ æƒè½®è¯¢ç®—æ³•</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 18:22 2024/7/23</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeightRoundLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">Integer</span> <span class="hljs-variable">choose</span> <span class="hljs-operator">=</span> -<span class="hljs-number">1</span>;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//æ¨¡æ‹Ÿåˆå§‹åŒ–æƒé‡map</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; addressList.size(); ++i) &#123;<br>            map.put(addressList.get(i), i + <span class="hljs-number">1</span>);<br>        &#125;<br>        List&lt;String&gt; serverList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> entry.getKey();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">weight</span> <span class="hljs-operator">=</span> entry.getValue();<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; weight; ++i) &#123;<br>                serverList.add(address);<br>            &#125;<br>        &#125;<br>        choose++;<br>        <span class="hljs-keyword">if</span>(choose &gt;= serverList.size())<br>            choose = <span class="hljs-number">0</span>;<br>        System.out.println(<span class="hljs-string">&quot;åŠ æƒè½®è¯¢ç®—æ³•é€‰æ‹©äº†&quot;</span> + choose + <span class="hljs-string">&quot;æœåŠ¡å™¨&quot;</span>);<br>        <span class="hljs-keyword">return</span> serverList.get(choose);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åŠ æƒéšæœºç®—æ³•"><a href="#åŠ æƒéšæœºç®—æ³•" class="headerlink" title="åŠ æƒéšæœºç®—æ³•"></a>åŠ æƒéšæœºç®—æ³•</h2><blockquote><p>åŠ æƒéšæœºæ³•ä¹Ÿæ ¹æ®åç«¯æœºå™¨çš„é…ç½®ï¼Œç³»ç»Ÿçš„è´Ÿè½½åˆ†é…ä¸åŒçš„æƒé‡ã€‚ä¸åŒçš„æ˜¯ï¼Œå®ƒæ˜¯æŒ‰ç…§æƒé‡éšæœºè¯·æ±‚åç«¯æœåŠ¡å™¨ï¼Œè€Œéé¡ºåºã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WeightRandomLoadBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">synchronized</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        Map&lt;String, Integer&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-comment">//æ¨¡æ‹Ÿåˆå§‹åŒ–æƒé‡map</span><br>        <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; addressList.size(); ++i) &#123;<br>            map.put(addressList.get(i), i + <span class="hljs-number">1</span>);<br>        &#125;<br>        List&lt;String&gt; serverList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">for</span>(Map.Entry&lt;String, Integer&gt; entry : map.entrySet()) &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">address</span> <span class="hljs-operator">=</span> entry.getKey();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">weight</span> <span class="hljs-operator">=</span> entry.getValue();<br>            <span class="hljs-keyword">for</span>(<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; weight; ++i) &#123;<br>                serverList.add(address);<br>            &#125;<br>        &#125;<br>        Random random=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">int</span> <span class="hljs-variable">choose</span> <span class="hljs-operator">=</span> random.nextInt(addressList.size());<br>        System.out.println(<span class="hljs-string">&quot;è´Ÿè½½å‡è¡¡é€‰æ‹©äº†&quot;</span>+choose+<span class="hljs-string">&quot;æœåŠ¡å™¨&quot;</span>);<br>        <span class="hljs-keyword">return</span> addressList.get(choose);<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> &#123;<br><br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span> &#123;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"><a href="#ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•" class="headerlink" title="ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•"></a>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•</h2><h3 id="ä¼ ç»ŸHashç®—æ³•æ€è·¯"><a href="#ä¼ ç»ŸHashç®—æ³•æ€è·¯" class="headerlink" title="ä¼ ç»ŸHashç®—æ³•æ€è·¯"></a>ä¼ ç»ŸHashç®—æ³•æ€è·¯</h3><p>ä¼ ç»Ÿhashç®—æ³•æ€è·¯ï¼š</p><ul><li><strong>å…ˆè®¡ç®— key å¯¹åº”çš„ hash å€¼</strong></li><li><strong>å°† hash å€¼å’ŒæœåŠ¡èŠ‚ç‚¹çš„æ•°é‡å–æ¨¡ï¼Œç®—å‡ºå¯¹åº”èŠ‚ç‚¹çš„ä¸‹æ ‡ï¼Œå³ Hash(Key) % NodeSize</strong></li></ul><p><img src="/2024/07/23/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/image-20240724091122119.png" alt="ä¼ ç»Ÿhashç®—æ³•"></p><p>å¯èƒ½å‡ºç°çš„é—®é¢˜ï¼š</p><ul><li><strong>å¦‚æœ Node-C èŠ‚ç‚¹å®•æœºäº†ï¼ŒHash(Key) % NodeSize å…¬å¼çš„å–æ¨¡å¯¹è±¡å‘ç”Ÿå˜åŒ–ï¼Œæœ€ç»ˆå¯èƒ½å¯¼è‡´ Key1ï¼ŒKey2 çš„æ˜ å°„åˆ°çš„æœåŠ¡èŠ‚ç‚¹éƒ½å‘ç”Ÿå˜åŒ–ï¼ˆKey3 è‚¯å®šä¼šæ”¹å˜ï¼‰ã€‚</strong></li><li><strong>åŸæœ¬ Key1 æ˜ å°„åˆ° Node-A å˜ä¸ºæ˜ å°„åˆ° Node-Bï¼Œå› ä¸ºæ•°æ®ä¹‹å‰å­˜å‚¨åœ¨ Node-Aï¼Œåˆ™å¯¼è‡´ Key1 æ— æ³•æ­£å¸¸å‘½ä¸­æ•°æ®ï¼›Key2ï¼ŒKey3 â€¦ KeyN éƒ½å¯èƒ½å‡ºç°è¿™ç§æƒ…å†µã€‚</strong></li></ul><p><img src="/2024/07/23/%E5%B8%B8%E8%A7%81%E7%9A%84%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1%E7%AE%97%E6%B3%95%E5%AE%9E%E7%8E%B0/image-20240724091258531.png" alt="å®•æœºå¼•èµ·æ˜ å°„å‘ç”Ÿå˜åŒ–"></p><p> ä¼ ç»Ÿ hashç®—æ³•çš„å±€é™æ€§ä¸»è¦ä½“ç°åœ¨ï¼š</p><ul><li><strong>èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´ key -&gt; èŠ‚ç‚¹çš„æ˜ å°„å…³ç³»å‘ç”Ÿå˜åŒ–ï¼Œæœ€ç»ˆå¯¼è‡´æ•°æ®å­˜å‚¨æœåŠ¡ä¸å¯ç”¨ï¼ˆä¹‹å‰å­˜å‚¨çš„ key æ— æ³•æ­£å¸¸å‘½ä¸­æ•°æ®ï¼‰ã€‚</strong></li><li><strong>èŠ‚ç‚¹æ•°é‡å‘ç”Ÿå˜åŒ–ï¼Œæ•´ä½“æ•°æ® Rehash çš„æˆæœ¬è¾ƒé«˜ã€‚</strong></li></ul><h3 id="ä¸€è‡´æ€§Hashç®—æ³•æ€è·¯"><a href="#ä¸€è‡´æ€§Hashç®—æ³•æ€è·¯" class="headerlink" title="ä¸€è‡´æ€§Hashç®—æ³•æ€è·¯"></a>ä¸€è‡´æ€§Hashç®—æ³•æ€è·¯</h3><p>ä¸€è‡´æ€§hashç®—æ³•ä¸€å…±åˆ†ä¸‰æ­¥ï¼š</p><ul><li>ä¸€è‡´æ€§å“ˆå¸Œç®—æ³•å°†æ•´ä¸ªå“ˆå¸Œå€¼ç©ºé—´æŒ‰ç…§é¡ºæ—¶é’ˆæ–¹å‘ç»„ç»‡æˆä¸€ä¸ªè™šæ‹Ÿçš„åœ†ç¯ï¼Œç§°ä¸º Hash ç¯ã€‚</li><li>æ¥ç€å°†å„ä¸ªæœåŠ¡å™¨ä½¿ç”¨ Hash å‡½æ•°è¿›è¡Œå“ˆå¸Œï¼Œå…·ä½“å¯ä»¥é€‰æ‹©æœåŠ¡å™¨çš„IPæˆ–ä¸»æœºåä½œä¸ºå…³é”®å­—è¿›è¡Œå“ˆå¸Œï¼Œä»è€Œç¡®å®šæ¯å°æœºå™¨åœ¨å“ˆå¸Œç¯ä¸Šçš„ä½ç½®ã€‚</li><li>æœ€åä½¿ç”¨ç®—æ³•å®šä½æ•°æ®è®¿é—®åˆ°ç›¸åº”æœåŠ¡å™¨ï¼šå°†æ•°æ®keyä½¿ç”¨ç›¸åŒçš„å‡½æ•°Hashè®¡ç®—å‡ºå“ˆå¸Œå€¼ï¼Œå¹¶ç¡®å®šæ­¤æ•°æ®åœ¨ç¯ä¸Šçš„ä½ç½®ï¼Œä»æ­¤ä½ç½®æ²¿ç¯é¡ºæ—¶é’ˆå¯»æ‰¾ï¼Œç¬¬ä¸€å°é‡åˆ°çš„æœåŠ¡å™¨å°±æ˜¯å…¶åº”è¯¥å®šä½åˆ°çš„æœåŠ¡å™¨ã€‚</li></ul><h3 id="Hashç¯åæ–œ"><a href="#Hashç¯åæ–œ" class="headerlink" title="Hashç¯åæ–œ"></a>Hashç¯åæ–œ</h3><h4 id="é—®é¢˜æè¿°"><a href="#é—®é¢˜æè¿°" class="headerlink" title="é—®é¢˜æè¿°"></a>é—®é¢˜æè¿°</h4><blockquote><p>é¦–å…ˆåœ¨èŠ‚ç‚¹è¾ƒå°‘çš„æƒ…å†µä¸‹æ•°æ®çš„åˆ†å¸ƒå¯èƒ½æ˜¯ä¸å¹³è¡¡çš„æƒ…å†µã€‚</p><p>ä¸€ä¸ªèŠ‚ç‚¹å®•æœºä¹‹åï¼Œæ•°æ®éœ€è¦è½åˆ°è·ç¦»ä»–æœ€è¿‘çš„èŠ‚ç‚¹ä¸Šï¼Œä¼šå¯¼è‡´ä¸‹ä¸ªèŠ‚ç‚¹çš„å‹åŠ›çªç„¶å¢å¤§ï¼Œå¯èƒ½å¯¼è‡´é›ªå´©ï¼Œæ•´ä¸ªæœåŠ¡æŒ‚æ‰ã€‚</p></blockquote><h4 id="è§£å†³æ–¹æ¡ˆ"><a href="#è§£å†³æ–¹æ¡ˆ" class="headerlink" title="è§£å†³æ–¹æ¡ˆ"></a>è§£å†³æ–¹æ¡ˆ</h4><blockquote><p>é€šè¿‡å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ï¼Œä½¿èŠ‚ç‚¹æœ€å¤§ç¨‹åº¦çš„åˆ†å¸ƒå‡åŒ€ï¼Œè§£å†³æ•°æ®å€¾æ–œçš„é—®é¢˜ã€‚</p><p> <strong>â€œè™šæ‹ŸèŠ‚ç‚¹â€( virtual node )æ˜¯å®é™…èŠ‚ç‚¹(æœºå™¨)åœ¨ hash ç©ºé—´çš„å¤åˆ¶å“( replica )ï¼Œä¸€å®é™…ä¸ªèŠ‚ç‚¹(æœºå™¨)å¯¹åº”äº†è‹¥å¹²ä¸ªâ€œè™šæ‹ŸèŠ‚ç‚¹â€ï¼Œè¿™ä¸ªå¯¹åº”ä¸ªæ•°ä¹Ÿæˆä¸ºâ€œå¤åˆ¶ä¸ªæ•°â€ï¼Œâ€œè™šæ‹ŸèŠ‚ç‚¹â€åœ¨ hash ç©ºé—´ä¸­ä»¥hashå€¼æ’åˆ—ã€‚</strong>   </p><p>è¿™æ ·å°±æˆåŠŸçš„å°†æ‰€æœ‰æ•°æ®è¾ƒä¸ºå‡åŒ€çš„åˆ†ä¸åˆ°äº†æ‰€æœ‰çš„èŠ‚ç‚¹ä¸Šï¼Œå³ä½¿å‘ç”Ÿäº†æŸä¸ªèŠ‚ç‚¹å®•æœºçš„æƒ…å†µï¼Œä¹Ÿä¸ä¼šå¯¹ä¸‹æ¸¸èŠ‚ç‚¹çªç„¶é€ æˆå·¨å¤§è´Ÿè½½ã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ConsistencyHashBalance</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">LoadBalance</span> &#123;<br>    <span class="hljs-comment">// è™šæ‹ŸèŠ‚ç‚¹çš„ä¸ªæ•°</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">VIRTUAL_NUM</span> <span class="hljs-operator">=</span> <span class="hljs-number">5</span>;<br><br>    <span class="hljs-comment">// è™šæ‹ŸèŠ‚ç‚¹åˆ†é…ï¼Œkeyæ˜¯hashå€¼ï¼Œvalueæ˜¯è™šæ‹ŸèŠ‚ç‚¹æœåŠ¡å™¨åç§°</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> SortedMap&lt;Integer, String&gt; shards = <span class="hljs-keyword">new</span> <span class="hljs-title class_">TreeMap</span>&lt;Integer, String&gt;();<br><br>    <span class="hljs-comment">// çœŸå®èŠ‚ç‚¹åˆ—è¡¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> List&lt;String&gt; realNodes = <span class="hljs-keyword">new</span> <span class="hljs-title class_">LinkedList</span>&lt;String&gt;();<br><br>    <span class="hljs-comment">//æ¨¡æ‹Ÿåˆå§‹æœåŠ¡å™¨</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> String[] servers =<span class="hljs-literal">null</span>;<br><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">init</span><span class="hljs-params">(List&lt;String&gt; serviceList)</span> &#123;<br>        <span class="hljs-keyword">for</span> (String server :serviceList) &#123;<br>            realNodes.add(server);<br>            System.out.println(<span class="hljs-string">&quot;çœŸå®èŠ‚ç‚¹[&quot;</span> + server + <span class="hljs-string">&quot;] è¢«æ·»åŠ &quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; VIRTUAL_NUM; i++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">virtualNode</span> <span class="hljs-operator">=</span> server + <span class="hljs-string">&quot;&amp;&amp;VN&quot;</span> + i;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> getHash(virtualNode);<br>                shards.put(hash, virtualNode);<br>                System.out.println(<span class="hljs-string">&quot;è™šæ‹ŸèŠ‚ç‚¹[&quot;</span> + virtualNode + <span class="hljs-string">&quot;] hash:&quot;</span> + hash + <span class="hljs-string">&quot;ï¼Œè¢«æ·»åŠ &quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * è·å–è¢«åˆ†é…çš„èŠ‚ç‚¹å</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> node</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@return</span></span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getServer</span><span class="hljs-params">(String node,List&lt;String&gt; serviceList)</span> &#123;<br>        init(serviceList);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> getHash(node);<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">key</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        SortedMap&lt;Integer, String&gt; subMap = shards.tailMap(hash);<br>        <span class="hljs-keyword">if</span> (subMap.isEmpty()) &#123;<br>            key = shards.lastKey();<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            key = subMap.firstKey();<br>        &#125;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">virtualNode</span> <span class="hljs-operator">=</span> shards.get(key);<br>        <span class="hljs-keyword">return</span> virtualNode.substring(<span class="hljs-number">0</span>, virtualNode.indexOf(<span class="hljs-string">&quot;&amp;&amp;&quot;</span>));<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * æ·»åŠ èŠ‚ç‚¹</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> node</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">addNode</span><span class="hljs-params">(String node)</span> &#123;<br>        <span class="hljs-keyword">if</span> (!realNodes.contains(node)) &#123;<br>            realNodes.add(node);<br>            System.out.println(<span class="hljs-string">&quot;çœŸå®èŠ‚ç‚¹[&quot;</span> + node + <span class="hljs-string">&quot;] ä¸Šçº¿æ·»åŠ &quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; VIRTUAL_NUM; i++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">virtualNode</span> <span class="hljs-operator">=</span> node + <span class="hljs-string">&quot;&amp;&amp;VN&quot;</span> + i;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> getHash(virtualNode);<br>                shards.put(hash, virtualNode);<br>                System.out.println(<span class="hljs-string">&quot;è™šæ‹ŸèŠ‚ç‚¹[&quot;</span> + virtualNode + <span class="hljs-string">&quot;] hash:&quot;</span> + hash + <span class="hljs-string">&quot;ï¼Œè¢«æ·»åŠ &quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * åˆ é™¤èŠ‚ç‚¹</span><br><span class="hljs-comment">     *</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@param</span> node</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">public</span>  <span class="hljs-keyword">void</span> <span class="hljs-title function_">delNode</span><span class="hljs-params">(String node)</span> &#123;<br>        <span class="hljs-keyword">if</span> (realNodes.contains(node)) &#123;<br>            realNodes.remove(node);<br>            System.out.println(<span class="hljs-string">&quot;çœŸå®èŠ‚ç‚¹[&quot;</span> + node + <span class="hljs-string">&quot;] ä¸‹çº¿ç§»é™¤&quot;</span>);<br>            <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; VIRTUAL_NUM; i++) &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">virtualNode</span> <span class="hljs-operator">=</span> node + <span class="hljs-string">&quot;&amp;&amp;VN&quot;</span> + i;<br>                <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> getHash(virtualNode);<br>                shards.remove(hash);<br>                System.out.println(<span class="hljs-string">&quot;è™šæ‹ŸèŠ‚ç‚¹[&quot;</span> + virtualNode + <span class="hljs-string">&quot;] hash:&quot;</span> + hash + <span class="hljs-string">&quot;ï¼Œè¢«ç§»é™¤&quot;</span>);<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * FNV1_32_HASHç®—æ³•</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getHash</span><span class="hljs-params">(String str)</span> &#123;<br>        <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> <span class="hljs-variable">p</span> <span class="hljs-operator">=</span> <span class="hljs-number">16777619</span>;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">hash</span> <span class="hljs-operator">=</span> (<span class="hljs-type">int</span>) <span class="hljs-number">2166136261L</span>;<br>        <span class="hljs-keyword">for</span> (<span class="hljs-type">int</span> <span class="hljs-variable">i</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>; i &lt; str.length(); i++)<br>            hash = (hash ^ str.charAt(i)) * p;<br>        hash += hash &lt;&lt; <span class="hljs-number">13</span>;<br>        hash ^= hash &gt;&gt; <span class="hljs-number">7</span>;<br>        hash += hash &lt;&lt; <span class="hljs-number">3</span>;<br>        hash ^= hash &gt;&gt; <span class="hljs-number">17</span>;<br>        hash += hash &lt;&lt; <span class="hljs-number">5</span>;<br>        <span class="hljs-comment">// å¦‚æœç®—å‡ºæ¥çš„å€¼ä¸ºè´Ÿæ•°åˆ™å–å…¶ç»å¯¹å€¼</span><br>        <span class="hljs-keyword">if</span> (hash &lt; <span class="hljs-number">0</span>)<br>            hash = Math.abs(hash);<br>        <span class="hljs-keyword">return</span> hash;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">balance</span><span class="hljs-params">(List&lt;String&gt; addressList)</span> &#123;<br>        String random= UUID.randomUUID().toString();<br>        <span class="hljs-keyword">return</span> getServer(random,addressList);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure><p><strong>åŸç†</strong>ï¼šä¸€è‡´æ€§å“ˆå¸Œæ³•å°†è¾“å…¥ï¼ˆå¦‚å®¢æˆ·ç«¯IPåœ°å€ï¼‰é€šè¿‡å“ˆå¸Œå‡½æ•°æ˜ å°„åˆ°ä¸€ä¸ªå›ºå®šå¤§å°çš„ç¯å½¢ç©ºé—´ï¼ˆå“ˆå¸Œç¯ï¼‰ä¸Šï¼Œæ¯ä¸ªæœåŠ¡å™¨ä¹Ÿæ˜ å°„åˆ°è¿™ä¸ªå“ˆå¸Œç¯ä¸Šã€‚å®¢æˆ·ç«¯çš„è¯·æ±‚ä¼šæ ¹æ®å“ˆå¸Œå€¼åœ¨å“ˆå¸Œç¯ä¸Šé¡ºæ—¶é’ˆæŸ¥æ‰¾ï¼Œé‡åˆ°çš„ç¬¬ä¸€ä¸ªæœåŠ¡å™¨å°±æ˜¯è¯¥è¯·æ±‚çš„ç›®æ ‡æœåŠ¡å™¨ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>å½“æœåŠ¡å™¨æ•°é‡å‘ç”Ÿå˜åŒ–æ—¶ï¼Œåªæœ‰å°‘æ•°é”®éœ€è¦è¢«é‡æ–°æ˜ å°„åˆ°æ–°çš„æœåŠ¡å™¨ä¸Šï¼Œè¿™å¤§å¤§å‡å°‘äº†ç¼“å­˜å¤±æ•ˆçš„æ•°é‡ï¼Œæé«˜äº†ç³»ç»Ÿçš„å¯ç”¨æ€§ã€‚</li><li>å…·æœ‰è‰¯å¥½çš„å¯æ‰©å±•æ€§ï¼Œå¯ä»¥åŠ¨æ€åœ°æ·»åŠ æˆ–åˆ é™¤æœåŠ¡å™¨ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>åœ¨å“ˆå¸Œç¯åæ–œçš„æƒ…å†µä¸‹ï¼Œå¤§éƒ¨åˆ†çš„ç¼“å­˜å¯¹è±¡å¾ˆæœ‰å¯èƒ½ä¼šç¼“å­˜åˆ°ä¸€å°æœåŠ¡å™¨ä¸Šï¼Œå¯¼è‡´ç¼“å­˜åˆ†å¸ƒæåº¦ä¸å‡åŒ€ã€‚</li><li>å®ç°è¾ƒä¸ºå¤æ‚ï¼Œéœ€è¦å¼•å…¥è™šæ‹ŸèŠ‚ç‚¹ç­‰æŠ€æœ¯æ¥è§£å†³å“ˆå¸Œåæ–œé—®é¢˜ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>æ‰‹æ’•RPCæ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å…«è‚¡</tag>
      
      <tag>è´Ÿè½½å‡è¡¡ç®—æ³•</tag>
      
      <tag>å“ˆå¸Œ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹æ’•httpæœåŠ¡å™¨â€”â€”å¼•å…¥Netty</title>
    <link href="/2024/07/11/%E6%89%8B%E6%92%95http%E6%9C%8D%E5%8A%A1%E5%99%A8%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/"/>
    <url>/2024/07/11/%E6%89%8B%E6%92%95http%E6%9C%8D%E5%8A%A1%E5%99%A8%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/</url>
    
    <content type="html"><![CDATA[<h1 id="ç†è®ºå‚¨å¤‡"><a href="#ç†è®ºå‚¨å¤‡" class="headerlink" title="ç†è®ºå‚¨å¤‡"></a>ç†è®ºå‚¨å¤‡</h1><p>ç›¸å…³NettyçŸ¥è¯†è¯·è§æ–‡ç« ï¼š<a href="https://love-enough.github.io/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/">æ‰‹æ’•RPCæ¡†æ¶â€”â€”å¼•å…¥Netty</a></p><p>æ›´åŠ æ·±å…¥çš„å…«è‚¡çŸ¥è¯†ï¼Œå¾…åšä¸»é˜…è¯»å®ŒNettyå®æˆ˜åè¿›è¡Œæ›´æ–°ğŸ˜€</p><h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><h2 id="åˆ›å»ºæµ‹è¯•é¡µé¢"><a href="#åˆ›å»ºæµ‹è¯•é¡µé¢" class="headerlink" title="åˆ›å»ºæµ‹è¯•é¡µé¢"></a>åˆ›å»ºæµ‹è¯•é¡µé¢</h2><p>404.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>404<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>404 not found<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><p>index.html</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-meta">&lt;!DOCTYPE <span class="hljs-keyword">html</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">head</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">meta</span> <span class="hljs-attr">charset</span>=<span class="hljs-string">&quot;UTF-8&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">title</span>&gt;</span>é¦–é¡µ<span class="hljs-tag">&lt;/<span class="hljs-name">title</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">head</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">h3</span>&gt;</span>helloï¼Œhttp server<span class="hljs-tag">&lt;/<span class="hljs-name">h3</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">html</span>&gt;</span><br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºæœåŠ¡å™¨æ¥å£"><a href="#åˆ›å»ºæœåŠ¡å™¨æ¥å£" class="headerlink" title="åˆ›å»ºæœåŠ¡å™¨æ¥å£"></a>åˆ›å»ºæœåŠ¡å™¨æ¥å£</h2><blockquote><p>ç›®å‰æ­¤æ¥å£è¿˜æ²¡æ·»åŠ å‡½æ•°ï¼Œä¸ºäº†ä¹‹åçš„æ‰©å±•æ€§ï¼Œå…ˆè¡Œå®šä¹‰ï¼Œä¹‹ååœ¨åˆ›å»ºæœåŠ¡å™¨ç›´æ¥å®ç°è¯¥æ¥å£å³å¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">HttpServer</span> &#123;<br><br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åˆå§‹åŒ–Nettyé…ç½®"><a href="#åˆå§‹åŒ–Nettyé…ç½®" class="headerlink" title="åˆå§‹åŒ–Nettyé…ç½®"></a>åˆå§‹åŒ–Nettyé…ç½®</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyHttpServerInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel socketChannel)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//è§£ç å™¨</span><br>        socketChannel.pipeline().addLast(<span class="hljs-string">&quot;http-decoder&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpRequestDecoder</span>());<br>        <span class="hljs-comment">//èšåˆå™¨</span><br>        socketChannel.pipeline().addLast(<span class="hljs-string">&quot;http-aggregator&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpObjectAggregator</span>(<span class="hljs-number">1024</span> * <span class="hljs-number">1024</span>));<br>        <span class="hljs-comment">//ç¼–ç å™¨</span><br>        socketChannel.pipeline().addLast(<span class="hljs-string">&quot;http-encoder&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpResponseEncoder</span>());<br>        <span class="hljs-comment">//è§£å†³å¤§ç æµé—®é¢˜</span><br>        socketChannel.pipeline().addLast(<span class="hljs-string">&quot;http-chunked&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">ChunkedWriteHandler</span>());<br>        <span class="hljs-comment">//è‡ªå®šä¹‰å¤„ç†handler</span><br>        socketChannel.pipeline().addLast(<span class="hljs-string">&quot;http-server&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyHttpServerHandler</span>());<br>    &#125;<br>&#125;<br><br></code></pre></td></tr></table></figure><h2 id="å®ç°Nettyå¤„ç†å™¨"><a href="#å®ç°Nettyå¤„ç†å™¨" class="headerlink" title="å®ç°Nettyå¤„ç†å™¨"></a>å®ç°Nettyå¤„ç†å™¨</h2><blockquote><p>æ­¤éƒ¨åˆ†å¯¹å®¢æˆ·ç«¯å‘æ¥çš„è¯·æ±‚è¿›è¡Œå¤„ç†ï¼Œå¹¶å°è£…responseè¿›è¡Œè¿”å›</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@Description</span> è‡ªå®šä¹‰handlerå¤„ç†å™¨</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment"> * <span class="hljs-doctag">@date</span> 22:50 2024/7/11</span><br><span class="hljs-comment"> */</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyHttpServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;FullHttpRequest&gt; &#123;<br><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext channelHandlerContext, FullHttpRequest fullHttpRequest)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//æ‰“å°è¯·æ±‚ä¿¡æ¯</span><br>        System.out.println(fullHttpRequest);<br><br>        <span class="hljs-type">FullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">str</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;/index.html&quot;</span>;<br><br>        <span class="hljs-type">InputStream</span> <span class="hljs-variable">is</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>        <span class="hljs-comment">//å¤„ç†GETè¯·æ±‚</span><br>        <span class="hljs-keyword">if</span>(fullHttpRequest.getMethod().equals(HttpMethod.GET)) &#123;<br>            <span class="hljs-comment">//è·å–è¯·æ±‚é™„å¸¦å‚æ•°</span><br>            System.out.println(getGetParamsFromChannel(fullHttpRequest));<br>            <span class="hljs-comment">//åˆ¤æ–­èµ„æºæ˜¯å¦å­˜åœ¨</span><br>            System.out.println(<span class="hljs-string">&quot;uri-------&quot;</span> +  fullHttpRequest.getUri());<br>            <span class="hljs-type">String</span> <span class="hljs-variable">origin</span> <span class="hljs-operator">=</span> fullHttpRequest.uri();<br>            <span class="hljs-type">int</span> <span class="hljs-variable">index</span> <span class="hljs-operator">=</span> fullHttpRequest.getUri().indexOf(<span class="hljs-string">&#x27;?&#x27;</span>);<br>            <span class="hljs-keyword">if</span>(index != -<span class="hljs-number">1</span>)<br>                str = origin.substring(<span class="hljs-number">0</span>, index);<br>            System.out.println(<span class="hljs-string">&quot;real--------&quot;</span> + str);<br>            <span class="hljs-keyword">if</span>(fullHttpRequest.getUri().equals(<span class="hljs-string">&quot;/&quot;</span>) || str.equals(fullHttpRequest.getUri())) &#123;<br>                <span class="hljs-comment">//å­˜åœ¨</span><br>                is = <span class="hljs-built_in">this</span>.getClass().getResourceAsStream(<span class="hljs-string">&quot;/index.html&quot;</span>);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//404</span><br>                is = <span class="hljs-built_in">this</span>.getClass().getResourceAsStream(<span class="hljs-string">&quot;/404.html&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(is).useDelimiter(<span class="hljs-string">&quot;\\Z&quot;</span>).next();<br>            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> copiedBuffer(resource, CharsetUtil.UTF_8);<br>            <span class="hljs-comment">//ç»“æœè¿”å›ç»™å®¢æˆ·ç«¯</span><br>            response = responseOK(HttpResponseStatus.OK, buf);<br>        &#125;<br>        <span class="hljs-comment">//POSTè¯·æ±‚</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (fullHttpRequest.getMethod().equals(HttpMethod.POST)) &#123;<br>            System.out.println(getPostParamsFromChannel(fullHttpRequest));<br>            <span class="hljs-comment">//åˆ¤æ–­èµ„æº æ˜¯å¦å­˜åœ¨</span><br>            <span class="hljs-keyword">if</span> (str.equals(fullHttpRequest.getUri())) &#123;<br>                <span class="hljs-comment">//å­˜åœ¨</span><br>                is = <span class="hljs-built_in">this</span>.getClass().getResourceAsStream(<span class="hljs-string">&quot;/index.html&quot;</span>);<br><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-comment">//404</span><br>                is = <span class="hljs-built_in">this</span>.getClass().getResourceAsStream(<span class="hljs-string">&quot;/404.html&quot;</span>);<br>            &#125;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">resource</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Scanner</span>(is).useDelimiter(<span class="hljs-string">&quot;\\Z&quot;</span>).next();<br>            <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">buf</span> <span class="hljs-operator">=</span> copiedBuffer(resource, CharsetUtil.UTF_8);<br>            <span class="hljs-comment">//ç»“æœè¿”å›å®¢æˆ·ç«¯</span><br>            response = responseOK(HttpResponseStatus.OK, buf);<br>        &#125;<br>        <span class="hljs-keyword">else</span> &#123;<br>            response = responseOK(HttpResponseStatus.INTERNAL_SERVER_ERROR, <span class="hljs-literal">null</span>);<br>        &#125;<br><br>        <span class="hljs-comment">//å“åº”å®¢æˆ·ç«¯</span><br>        channelHandlerContext.writeAndFlush(response).addListener(ChannelFutureListener.CLOSE);<br><br>    &#125;<br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> è·å–GETè¯·æ±‚ä¼ é€’çš„å‚æ•°</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 22:59 2024/7/11</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getGetParamsFromChannel</span><span class="hljs-params">(FullHttpRequest fullHttpRequest)</span> &#123;<br>        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br><br>        <span class="hljs-keyword">if</span>(fullHttpRequest.getMethod().equals(HttpMethod.GET)) &#123;<br>            <span class="hljs-type">QueryStringDecoder</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">QueryStringDecoder</span>(fullHttpRequest.getUri());<br>            Map&lt;String, List&lt;String&gt;&gt; paramList = decoder.parameters();<br>            <span class="hljs-comment">//å°†å‚æ•°å­˜å‚¨å†paramsä¸­</span><br>            <span class="hljs-keyword">for</span>(Map.Entry&lt;String, List&lt;String&gt;&gt; entry : paramList.entrySet()) &#123;<br>                params.put(entry.getKey(), entry.getValue().get(<span class="hljs-number">0</span>));<br>            &#125;<br>            <span class="hljs-keyword">return</span> params;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span>  <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> è·å–POSTè¯·æ±‚ä¼ é€’çš„å‚æ•°</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 23:10 2024/7/11</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getPostParamsFromChannel</span><span class="hljs-params">(FullHttpRequest fullHttpRequest)</span> &#123;<br>        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br><br>        <span class="hljs-keyword">if</span>(fullHttpRequest.getMethod().equals(HttpMethod.POST)) &#123;<br>            <span class="hljs-comment">// å¤„ç†POSTè¯·æ±‚</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">strContentType</span> <span class="hljs-operator">=</span> fullHttpRequest.headers().get(<span class="hljs-string">&quot;Content-Type&quot;</span>).trim();<br>            <span class="hljs-keyword">if</span>(strContentType.contains(<span class="hljs-string">&quot;x-www-form-urlencoded&quot;</span>)) &#123;<br>                <span class="hljs-comment">//formè¡¨å•</span><br>            &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (strContentType.contains(<span class="hljs-string">&quot;application/json&quot;</span>)) &#123;<br>                <span class="hljs-comment">//jsonæ•°æ®</span><br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>            &#125;<br>            <span class="hljs-keyword">return</span> params;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> è§£æformè¡¨å•æ•°æ®</span><br><span class="hljs-comment">     * Content-Type = x-www-form-urlencoded</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 23:14 2024/7/11</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getFormParams</span><span class="hljs-params">(FullHttpRequest fullHttpRequest)</span> &#123;<br>        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br><br>        <span class="hljs-type">HttpPostRequestDecoder</span> <span class="hljs-variable">decoder</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">HttpPostRequestDecoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultHttpDataFactory</span>(<span class="hljs-literal">false</span>), fullHttpRequest);<br>        List&lt;InterfaceHttpData&gt; postData = decoder.getBodyHttpDatas();<br><br>        <span class="hljs-keyword">for</span>(InterfaceHttpData data : postData) &#123;<br>            <span class="hljs-keyword">if</span>(data.getHttpDataType() == InterfaceHttpData.HttpDataType.Attribute) &#123;<br>                <span class="hljs-type">MemoryAttribute</span> <span class="hljs-variable">attribute</span> <span class="hljs-operator">=</span> (MemoryAttribute) data;<br>                params.put(attribute.getName(), attribute.getValue());<br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> params;<br>    &#125;<br><br>    <span class="hljs-comment">/**</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@Description</span> è§£æjsonæ•°æ®</span><br><span class="hljs-comment">     * Content-Type = application/json</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@author</span> GuoZihan</span><br><span class="hljs-comment">     * <span class="hljs-doctag">@date</span> 23:18 2024/7/11</span><br><span class="hljs-comment">     */</span><br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getJsonParams</span><span class="hljs-params">(FullHttpRequest fullHttpRequest)</span> &#123;<br>        Map&lt;String, Object&gt; params = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;String, Object&gt;();<br><br>        <span class="hljs-type">ByteBuf</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> fullHttpRequest.content();<br>        <span class="hljs-type">byte</span>[] reqContent = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[content.readableBytes()];<br>        content.readBytes(reqContent);<br>        <span class="hljs-type">String</span> <span class="hljs-variable">strContent</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">String</span>(reqContent, StandardCharsets.UTF_8);<br><br>        <span class="hljs-type">JSONObject</span> <span class="hljs-variable">jsonParams</span> <span class="hljs-operator">=</span> JSONObject.fromObject(strContent);<br>        <span class="hljs-keyword">for</span> (Object key : jsonParams.keySet())<br>            params.put(key.toString(), jsonParams.get(key));<br><br>        <span class="hljs-keyword">return</span> params;<br>    &#125;<br><br>    <span class="hljs-comment">//å°è£…å“åº”-200</span><br>    <span class="hljs-keyword">private</span> FullHttpResponse <span class="hljs-title function_">responseOK</span><span class="hljs-params">(HttpResponseStatus status, ByteBuf content)</span> &#123;<br>        <span class="hljs-type">FullHttpResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultFullHttpResponse</span>(HttpVersion.HTTP_1_1, status, content);<br>        <span class="hljs-keyword">if</span>(content != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">//åŠ å…¥å†…å®¹ä¿¡æ¯</span><br>            response.headers().set(<span class="hljs-string">&quot;Content-Type&quot;</span>, <span class="hljs-string">&quot;text/plain;charset=UTF-8&quot;</span>);<br>            response.headers().set(<span class="hljs-string">&quot;Content_Length&quot;</span>, response.content().readableBytes());<br>        &#125;<br>        <span class="hljs-keyword">return</span> response;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="åˆ›å»ºNettyæœåŠ¡å™¨"><a href="#åˆ›å»ºNettyæœåŠ¡å™¨" class="headerlink" title="åˆ›å»ºNettyæœåŠ¡å™¨"></a>åˆ›å»ºNettyæœåŠ¡å™¨</h2><blockquote><p>æœ‰äº†åˆå§‹åŒ–ä»¥åŠå®šä¹‰äº†å¤„ç†å™¨ï¼Œé‚£ä¹ˆåˆ›å»ºNettyServerå³å¯</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyHttpServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HttpServer</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-comment">//äº‹ä»¶å¾ªç¯ç»„ï¼Œå¤„ç†å®¢æˆ·ç«¯è¿æ¥</span><br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        <span class="hljs-comment">//å¤„ç†ä¸šåŠ¡</span><br>        <span class="hljs-type">EventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();<br>            server.group(bossGroup, workGroup)<br>                    .channel(NioServerSocketChannel.class)<br>                    .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyHttpServerInitializer</span>());<br><br>            <span class="hljs-comment">//ç›‘å¬ç«¯å£portï¼ŒåŒæ­¥è¿”å›</span><br>            <span class="hljs-type">ChannelFuture</span> <span class="hljs-variable">future</span> <span class="hljs-operator">=</span> server.bind(<span class="hljs-built_in">this</span>.port).sync();<br>            System.out.println(<span class="hljs-string">&quot;The web server has been started at the addressï¼šhttp://localhost:&quot;</span>+ <span class="hljs-built_in">this</span>.port);<br>            <span class="hljs-comment">//é€šé“å…³é—­æ—¶ç»§ç»­å‘åæ‰§è¡Œ</span><br>            future.channel().closeFuture().sync();<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(e);<br>        &#125; <span class="hljs-keyword">finally</span> &#123;<br>            workGroup.shutdownGracefully();<br>            bossGroup.shutdownGracefully();<br>        &#125;<br><br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="ä¸»å‡½æ•°"><a href="#ä¸»å‡½æ•°" class="headerlink" title="ä¸»å‡½æ•°"></a>ä¸»å‡½æ•°</h2><blockquote><p>å¯åŠ¨æœåŠ¡å™¨ï¼Œæ‰“å¼€æµè§ˆå™¨è¾“å…¥ç½‘å€è¿›è¡Œæµ‹è¯•ï¼Œæˆ–è€…ç”¨postmanå·¥å…·è¿›è¡Œæµ‹è¯•ï¼ˆæ¨èï¼‰</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestHttp</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        <span class="hljs-type">NettyHttpServer</span> <span class="hljs-variable">server</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyHttpServer</span>(<span class="hljs-number">9000</span>);<br>        server.run();<br>        System.out.println(<span class="hljs-string">&quot;server close!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><div class="note note-success">            <p>ä¸‹æœŸé¢„å‘Šï¼š</p><ul><li>è‡ªå®šä¹‰å°è£…requestå’Œresponse</li><li>å®ç°è‡ªå®šä¹‰ç¼–ç å™¨å’Œè§£ç å™¨</li></ul>          </div>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>æ‰‹æ’•httpæœåŠ¡å™¨</category>
      
    </categories>
    
    
    <tags>
      
      <tag>Http</tag>
      
      <tag>Netty</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>ZABåè®®è¯¦è§£</title>
    <link href="/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/"/>
    <url>/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/</url>
    
    <content type="html"><![CDATA[<h1 id="æµ…è¯†ZooKeeper"><a href="#æµ…è¯†ZooKeeper" class="headerlink" title="æµ…è¯†ZooKeeper"></a>æµ…è¯†ZooKeeper</h1><blockquote><p>ZooKeeperæ˜¯ä¸€ä¸ªå¼€æ”¾æºä»£ç çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ï¼Œç”±çŸ¥åäº’è”ç½‘å…¬å¸é›…è™åˆ›å»ºï¼Œæ˜¯Google Chubbyçš„å¼€æºå®ç°ã€‚ZooKeeperçš„è®¾è®¡ç›®æ ‡æ˜¯å°†é‚£äº›å¤æ‚ä¸”å®¹æ˜“å‡ºé”™çš„åˆ†å¸ƒå¼ä¸€è‡´æ€§æœåŠ¡å°è£…èµ·æ¥ï¼Œæ„æˆä¸€ä¸ªé«˜æ•ˆå¯é çš„åŸè¯­é›†ï¼Œå¹¶ä»¥ä¸€ç³»åˆ—ç®€å•æ˜“ç”¨çš„æ¥å£æä¾›ç»™ç”¨æˆ·ä½¿ç”¨ã€‚</p></blockquote><h2 id="ZooKeeperæ˜¯ä»€ä¹ˆ"><a href="#ZooKeeperæ˜¯ä»€ä¹ˆ" class="headerlink" title="ZooKeeperæ˜¯ä»€ä¹ˆ"></a>ZooKeeperæ˜¯ä»€ä¹ˆ</h2><p>ZooKeeperæ˜¯ä¸€ä¸ªå…¸å‹çš„åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§çš„è§£å†³æ–¹æ¡ˆï¼Œåˆ†å¸ƒå¼åº”ç”¨ç¨‹åºå¯ä»¥åŸºäºå®ƒå®ç°è¯¸å¦‚æ•°æ®å‘å¸ƒ&#x2F;è®¢é˜…ã€è´Ÿè½½å‡è¡¡ã€å‘½åæœåŠ¡ã€åˆ†å¸ƒå¼åè°ƒ&#x2F;é€šçŸ¥ã€é›†ç¾¤ç®¡ç†ã€Masteré€‰ä¸¾ã€åˆ†å¸ƒå¼é”å’Œåˆ†å¸ƒå¼é˜Ÿåˆ—ç­‰åŠŸèƒ½ã€‚</p><p>ZooKeeperå¯ä»¥ä¿è¯å¦‚ä¸‹åˆ†å¸ƒå¼ä¸€è‡´æ€§ç‰¹æ€§</p><ul><li><strong>é¡ºåºä¸€è‡´æ€§</strong>ï¼šä»åŒä¸€ä¸ªå®¢æˆ·ç«¯å‘èµ·çš„äº‹åŠ¡è¯·æ±‚ï¼Œæœ€ç»ˆå°†ä¼šä¸¥æ ¼åœ°æŒ‰ç…§å…¶å‘èµ·é¡ºåºè¢«åº”ç”¨åˆ°ZooKeeper ä¸­å»ã€‚</li><li><strong>åŸå­æ€§</strong>ï¼šæ‰€æœ‰äº‹åŠ¡è¯·æ±‚çš„å¤„ç†ç»“æœåœ¨æ•´ä¸ªé›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨ä¸Šçš„åº”ç”¨æƒ…å†µæ˜¯ä¸€è‡´çš„ï¼Œä¹Ÿå°±æ˜¯è¯´è¦ä¹ˆæ•´ä¸ªé›†ç¾¤æ‰€æœ‰æœºå™¨éƒ½æˆåŠŸåº”ç”¨äº†æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè¦ä¹ˆéƒ½æ²¡æœ‰åº”ç”¨ï¼Œä¸€å®šä¸ä¼šå‡ºç°é›†ç¾¤ä¸­éƒ¨åˆ†æœºå™¨åº”ç”¨äº†è¯¥äº‹åŠ¡ï¼Œè€Œå¦å¤–ä¸€éƒ¨åˆ†æ²¡æœ‰åº”ç”¨çš„æƒ…å†µã€‚</li><li><strong>å•ä¸€è§†å›¾</strong>ï¼šæ— è®ºå®¢æˆ·ç«¯è¿æ¥çš„æ˜¯å“ªä¸ªZooKeeperæœåŠ¡å™¨ï¼Œå…¶çœ‹åˆ°çš„æœåŠ¡ç«¯æ•°æ®æ¨¡å‹éƒ½æ˜¯ä¸€è‡´çš„ã€‚</li><li><strong>å¯é æ€§</strong>ï¼šä¸€æ—¦æœåŠ¡ç«¯æˆåŠŸåœ°åº”ç”¨äº†ä¸€ä¸ªäº‹åŠ¡ï¼Œå¹¶å®Œæˆå¯¹å®¢æˆ·ç«¯çš„å“åº”ï¼Œé‚£ä¹ˆè¯¥äº‹åŠ¡æ‰€å¼•èµ·çš„æœåŠ¡ç«¯çŠ¶æ€å˜æ›´å°†ä¼šè¢«ä¸€ç›´ä¿ç•™ä¸‹æ¥ï¼Œé™¤éæœ‰å¦ä¸€ä¸ªäº‹åŠ¡åˆå¯¹å…¶è¿›è¡Œäº†å˜æ›´ã€‚</li><li><strong>å®æ—¶æ€§</strong>ï¼šé€šå¸¸äººä»¬çœ‹åˆ°å®æ—¶æ€§çš„ç¬¬ä¸€ååº”æ˜¯ï¼Œä¸€æ—¦ä¸€ä¸ªäº‹åŠ¡è¢«æˆåŠŸåº”ç”¨ï¼Œé‚£ä¹ˆå®¢æˆ·ç«¯èƒ½å¤Ÿç«‹å³ä»æœåŠ¡ç«¯ä¸Šè¯»å–åˆ°è¿™ä¸ªäº‹åŠ¡å˜æ›´åçš„æœ€æ–°æ•°æ®çŠ¶æ€ã€‚&#x3D;&#x3D;è¿™é‡Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼ŒZooKeeperä»…ä»…ä¿è¯åœ¨ä¸€å®šçš„æ—¶é—´æ®µå†…ï¼Œå®¢æˆ·ç«¯æœ€ç»ˆä¸€å®šèƒ½å¤Ÿä»æœåŠ¡ç«¯ä¸Šè¯»å–åˆ°æœ€æ–°çš„æ•°æ®çŠ¶æ€&#x3D;&#x3D;ã€‚</li></ul><h2 id="ZooKeeperçš„è®¾è®¡ç›®æ ‡"><a href="#ZooKeeperçš„è®¾è®¡ç›®æ ‡" class="headerlink" title="ZooKeeperçš„è®¾è®¡ç›®æ ‡"></a>ZooKeeperçš„è®¾è®¡ç›®æ ‡</h2><blockquote><p>ZooKeeper è‡´åŠ›äºæä¾›ä¸€ä¸ªé«˜æ€§èƒ½ã€é«˜å¯ç”¨ï¼Œä¸”å…·æœ‰ä¸¥æ ¼çš„é¡ºåºè®¿é—®æ§åˆ¶èƒ½åŠ›(ä¸»è¦æ˜¯å†™æ“ä½œçš„ä¸¥æ ¼é¡ºåºæ€§)çš„åˆ†å¸ƒå¼åè°ƒæœåŠ¡ã€‚</p><p>é«˜æ€§èƒ½ â†’ ä½¿å¾—ZooKeeperèƒ½å¤Ÿåº”ç”¨äºé‚£äº›å¯¹ç³»ç»Ÿååæœ‰æ˜ç¡®è¦æ±‚çš„å¤§å‹åˆ†å¸ƒå¼ç³»ç»Ÿä¸­</p><p>é«˜å¯ç”¨ â†’ ä½¿å¾—åˆ†å¸ƒå¼çš„å•ç‚¹é—®é¢˜å¾—åˆ°äº†å¾ˆå¥½çš„è§£å†³</p><p>ä¸¥æ ¼çš„é¡ºåºè®¿é—® â†’ ä½¿å¾—å®¢æˆ·ç«¯èƒ½å¤ŸåŸºäºZooKeeperå®ç°ä¸€äº›å¤æ‚çš„åŒæ­¥åŸè¯­</p></blockquote><h3 id="ç›®æ ‡ä¸€ï¼šç®€å•çš„æ•°æ®æ¨¡å‹"><a href="#ç›®æ ‡ä¸€ï¼šç®€å•çš„æ•°æ®æ¨¡å‹" class="headerlink" title="ç›®æ ‡ä¸€ï¼šç®€å•çš„æ•°æ®æ¨¡å‹"></a>ç›®æ ‡ä¸€ï¼šç®€å•çš„æ•°æ®æ¨¡å‹</h3><p>ZooKeeperä½¿å¾—åˆ†å¸ƒå¼ç¨‹åºèƒ½å¤Ÿé€šè¿‡ä¸€ä¸ªå…±äº«çš„ã€æ ‘å‹ç»“æ„çš„åå­—ç©ºé—´æ¥è¿›è¡Œç›¸äº’åè°ƒã€‚è¿™é‡Œæ‰€è¯´çš„æ ‘å‹ç»“æ„çš„åå­—ç©ºé—´ï¼Œæ˜¯æŒ‡ZooKeeper æœåŠ¡å™¨å†…å­˜ä¸­çš„ä¸€ä¸ªæ•°æ®æ¨¡å‹ï¼Œå…¶ç”±ä¸€ç³»åˆ—è¢«ç§°ä¸ºZNodeçš„æ•°æ®èŠ‚ç‚¹ç»„æˆï¼Œæ€»çš„æ¥è¯´ï¼Œå…¶æ•°æ®æ¨¡å‹ç±»ä¼¼äºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿï¼Œè€ŒZNode ä¹‹é—´çš„å±‚çº§å…³ç³»ï¼Œå°±åƒæ–‡ä»¶ç³»ç»Ÿçš„ç›®å½•ç»“æ„ä¸€æ ·ã€‚ä¸è¿‡å’Œä¼ ç»Ÿçš„ç£ç›˜æ–‡ä»¶ç³»ç»Ÿä¸åŒçš„æ˜¯ï¼Œ<strong>ZooKeeperå°†å…¨é‡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œä»¥æ­¤æ¥å®ç°æé«˜æœåŠ¡å™¨ååã€å‡å°‘å»¶è¿Ÿçš„ç›®çš„</strong>ã€‚</p><h3 id="ç›®æ ‡äºŒï¼šå¯ä»¥æ„å»ºé›†ç¾¤"><a href="#ç›®æ ‡äºŒï¼šå¯ä»¥æ„å»ºé›†ç¾¤" class="headerlink" title="ç›®æ ‡äºŒï¼šå¯ä»¥æ„å»ºé›†ç¾¤"></a>ç›®æ ‡äºŒï¼šå¯ä»¥æ„å»ºé›†ç¾¤</h3><p>ä¸€ä¸ªZooKeeper é›†ç¾¤é€šå¸¸ç”±ä¸€ç»„æœºå™¨ç»„æˆï¼Œä¸€èˆ¬3~5å°æœºå™¨å°±å¯ä»¥ç»„æˆä¸€ä¸ªå¯ç”¨çš„ZooKeeper é›†ç¾¤ã€‚</p><p><img src="/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/image-20240707215914393.png" alt="ZooKeeperçš„é›†ç¾¤æ¨¡å¼"></p><p>ç»„æˆZooKeeperé›†ç¾¤çš„æ¯å°æœºå™¨éƒ½ä¼šåœ¨å†…å­˜ä¸­ç»´æŠ¤å½“å‰çš„æœåŠ¡å™¨çŠ¶æ€ï¼Œå¹¶ä¸”æ¯å°æœºå™¨ä¹‹é—´éƒ½äº’ç›¸ä¿æŒç€é€šä¿¡ã€‚<strong>å€¼å¾—ä¸€æçš„æ˜¯ï¼Œåªè¦é›†ç¾¤ä¸­å­˜åœ¨è¶…è¿‡ä¸€åŠçš„æœºå™¨èƒ½å¤Ÿæ­£å¸¸å·¥ä½œï¼Œé‚£ä¹ˆæ•´ä¸ªé›†ç¾¤å°±èƒ½å¤Ÿæ­£å¸¸å¯¹å¤–æœåŠ¡</strong>ã€‚</p><p>ZooKeeperçš„å®¢æˆ·ç«¯ç¨‹åºä¼šé€‰æ‹©å’Œé›†ç¾¤ä¸­ä»»æ„ä¸€å°æœºå™¨å…±åŒæ¥åˆ›å»ºä¸€ä¸ªTCPè¿æ¥,è€Œæ—¦<strong>å®¢æˆ·ç«¯å’ŒæŸå° ZooKeeper æœåŠ¡å™¨ä¹‹é—´çš„è¿æ¥æ–­å¼€å,å®¢æˆ·ç«¯ä¼šè‡ªåŠ¨è¿æ¥åˆ°é›†ç¾¤ä¸­çš„å…¶ä»–æœºå™¨</strong>ã€‚</p><h3 id="ç›®æ ‡ä¸‰ï¼šé¡ºåºè®¿é—®"><a href="#ç›®æ ‡ä¸‰ï¼šé¡ºåºè®¿é—®" class="headerlink" title="ç›®æ ‡ä¸‰ï¼šé¡ºåºè®¿é—®"></a>ç›®æ ‡ä¸‰ï¼šé¡ºåºè®¿é—®</h3><p>å¯¹äºæ¥è‡ªå®¢æˆ·ç«¯çš„æ¯ä¸ªæ›´æ–°è¯·æ±‚ï¼ŒZooKeeperéƒ½ä¼šåˆ†é…ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„é€’å¢ç¼–å·ï¼Œè¿™ä¸ªç¼–å·åæ˜ äº†æ‰€æœ‰äº‹åŠ¡æ“ä½œçš„å…ˆåé¡ºåºï¼Œåº”ç”¨ç¨‹åºå¯ä»¥ä½¿ç”¨ZooKeeperçš„è¿™ä¸ªç‰¹æ€§æ¥å®ç°æ›´é«˜å±‚æ¬¡çš„åŒæ­¥åŸè¯­ã€‚</p><h3 id="ç›®æ ‡å››ï¼šé«˜æ€§èƒ½"><a href="#ç›®æ ‡å››ï¼šé«˜æ€§èƒ½" class="headerlink" title="ç›®æ ‡å››ï¼šé«˜æ€§èƒ½"></a>ç›®æ ‡å››ï¼šé«˜æ€§èƒ½</h3><p>ç”±äº<strong>ZooKeeper å°†å…¨é‡æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œå¹¶ç›´æ¥æœåŠ¡äºå®¢æˆ·ç«¯çš„æ‰€æœ‰éäº‹åŠ¡è¯·æ±‚ï¼Œå› æ­¤å®ƒå°¤å…¶é€‚ç”¨äºä»¥è¯»æ“ä½œä¸ºä¸»çš„åº”ç”¨åœºæ™¯</strong>ã€‚ä½œè€…æ›¾ç»ä»¥3å°3.4.3ç‰ˆæœ¬çš„ZooKeeperæœåŠ¡å™¨ç»„æˆé›†ç¾¤è¿›è¡Œæ€§èƒ½å‹æµ‹ï¼Œ100%è¯»è¯·æ±‚çš„åœºæ™¯ä¸‹å‹æµ‹ç»“æœæ˜¯12~13Wçš„QPSã€‚</p><h2 id="ZooKeeperçš„åŸºæœ¬æ¦‚å¿µ"><a href="#ZooKeeperçš„åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="ZooKeeperçš„åŸºæœ¬æ¦‚å¿µ"></a>ZooKeeperçš„åŸºæœ¬æ¦‚å¿µ</h2><blockquote><p>è¿™é‡Œå…ˆå¯¹ZooKeeperçš„å‡ ä¸ªæ¦‚å¿µåšä¸€ä¸‹äº†è§£ï¼Œæ–¹ä¾¿åé¢æ·±å…¥ZABåè®®</p></blockquote><h3 id="é›†ç¾¤è§’è‰²"><a href="#é›†ç¾¤è§’è‰²" class="headerlink" title="é›†ç¾¤è§’è‰²"></a>é›†ç¾¤è§’è‰²</h3><p>ä¼ ç»Ÿçš„é›†ç¾¤æ¨¡å¼ï¼šMaster&#x2F;Slaveæ¨¡å¼(ä¸»å¤‡æ¨¡å¼)ã€‚åœ¨è¿™ç§æ¨¡å¼ä¸­ï¼Œæˆ‘ä»¬æŠŠèƒ½å¤Ÿå¤„ç†æ‰€æœ‰å†™æ“ä½œçš„æœºå™¨ç§°ä¸ºMasteræœºå™¨,æŠŠæ‰€æœ‰é€šè¿‡å¼‚æ­¥å¤åˆ¶æ–¹å¼è·å–æœ€æ–°æ•°æ®,å¹¶æä¾›è¯»æœåŠ¡çš„æœºå™¨ç§°ä¸ºSlave æœºå™¨ã€‚</p><p> ZooKeeperä¸­ï¼Œè¿™äº›æ¦‚å¿µè¢«é¢ è¦†äº†ã€‚å®ƒæ²¡æœ‰æ²¿ç”¨ä¼ ç»Ÿçš„Master&#x2F;Slave æ¦‚å¿µï¼Œè€Œæ˜¯<strong>å¼•å…¥äº†Leaderã€Followerå’ŒObserver ä¸‰ç§è§’è‰²</strong>ã€‚</p><p>ZooKeeper é›†ç¾¤ä¸­çš„æ‰€æœ‰æœºå™¨é€šè¿‡ä¸€ä¸ªLeader é€‰ä¸¾è¿‡ç¨‹æ¥é€‰å®šä¸€å°è¢«ç§°ä¸ºâ€œLeaderâ€çš„æœºå™¨ï¼ŒLeader æœåŠ¡å™¨ä¸ºå®¢æˆ·ç«¯æä¾›è¯»å’Œå†™æœåŠ¡ã€‚é™¤Leaderå¤–ï¼Œå…¶ä»–æœºå™¨åŒ…æ‹¬Followerå’ŒObserverã€‚</p><p>Followerå’Œ Observer éƒ½èƒ½å¤Ÿæä¾›è¯»æœåŠ¡ï¼Œå”¯ä¸€çš„åŒºåˆ«åœ¨äºï¼ŒObserveræœºå™¨ä¸å‚ä¸Leaderé€‰ä¸¾è¿‡ç¨‹ï¼Œä¹Ÿä¸å‚ä¸å†™æ“ä½œçš„â€œè¿‡åŠå†™æˆåŠŸâ€ç­–ç•¥ï¼Œå› æ­¤Observer å¯ä»¥åœ¨ä¸å½±å“å†™æ€§èƒ½çš„æƒ…å†µä¸‹æå‡é›†ç¾¤çš„è¯»æ€§èƒ½ã€‚</p><h3 id="ä¼šè¯-Session"><a href="#ä¼šè¯-Session" class="headerlink" title="ä¼šè¯(Session)"></a>ä¼šè¯(Session)</h3><p>Sessionæ˜¯æŒ‡å®¢æˆ·ç«¯ä¼šè¯ï¼Œåœ¨ZooKeeper ä¸­,ä¸€ä¸ªå®¢æˆ·ç«¯è¿æ¥æ˜¯æŒ‡å®¢æˆ·ç«¯å’ŒæœåŠ¡å™¨ä¹‹é—´çš„ä¸€ä¸ªTCPé•¿è¿æ¥ã€‚ZooKeeperå¯¹å¤–çš„æœåŠ¡ç«¯å£é»˜è®¤æ˜¯ 2181,å®¢æˆ·ç«¯å¯åŠ¨çš„æ—¶å€™,é¦–å…ˆä¼šä¸æœåŠ¡å™¨å»ºç«‹ä¸€ä¸ªTCPè¿æ¥,ä»ç¬¬ä¸€æ¬¡è¿æ¥å»ºç«‹å¼€å§‹ï¼Œå®¢æˆ·ç«¯ä¼šè¯çš„ç”Ÿå‘½å‘¨æœŸä¹Ÿå¼€å§‹äº†ï¼Œé€šè¿‡è¿™ä¸ªè¿æ¥ï¼Œå®¢æˆ·ç«¯èƒ½å¤Ÿé€šè¿‡å¿ƒè·³æ£€æµ‹ä¸æœåŠ¡å™¨ä¿æŒæœ‰æ•ˆçš„ä¼šè¯ï¼Œä¹Ÿèƒ½å¤Ÿå‘ZooKeeperæœåŠ¡å™¨å‘é€è¯·æ±‚å¹¶æ¥å—å“åº”,åŒæ—¶è¿˜èƒ½å¤Ÿé€šè¿‡è¯¥è¿æ¥æ¥æ”¶æ¥è‡ªæœåŠ¡å™¨çš„Watchäº‹ä»¶é€šçŸ¥ã€‚</p><p>Sessionçš„sessionTimeoutå€¼ç”¨æ¥è®¾ç½®ä¸€ä¸ªå®¢æˆ·ç«¯ä¼šè¯çš„è¶…æ—¶æ—¶é—´ã€‚å½“ç”±äºæœåŠ¡å™¨å‹åŠ›å¤ªå¤§ã€ç½‘ç»œæ•…éšœæˆ–æ˜¯å®¢æˆ·ç«¯ä¸»åŠ¨æ–­å¼€è¿æ¥ç­‰å„ç§åŸå› å¯¼è‡´å®¢æˆ·ç«¯è¿æ¥æ–­å¼€æ—¶ï¼Œ<strong>åªè¦åœ¨sessionTimeoutè§„å®šçš„æ—¶é—´å†…èƒ½å¤Ÿé‡æ–°è¿æ¥ä¸Šé›†ç¾¤ä¸­ä»»æ„ä¸€å°æœåŠ¡å™¨,é‚£ä¹ˆä¹‹å‰åˆ›å»ºçš„ä¼šè¯ä»ç„¶æœ‰æ•ˆ</strong>ã€‚</p><h3 id="æ•°æ®èŠ‚ç‚¹-Znode"><a href="#æ•°æ®èŠ‚ç‚¹-Znode" class="headerlink" title="æ•°æ®èŠ‚ç‚¹(Znode)"></a>æ•°æ®èŠ‚ç‚¹(Znode)</h3><p>åœ¨è°ˆåˆ°åˆ†å¸ƒå¼çš„æ—¶å€™ï¼Œæˆ‘ä»¬é€šå¸¸è¯´çš„â€œèŠ‚ç‚¹â€æ˜¯æŒ‡ç»„æˆé›†ç¾¤çš„æ¯ä¸€å°æœºå™¨ã€‚ç„¶è€Œï¼Œåœ¨ZooKeeperä¸­,â€œèŠ‚ç‚¹â€åˆ†ä¸ºä¸¤ç±»ã€‚</p><ul><li><strong>ç¬¬ä¸€ç±»åŒæ ·æ˜¯æŒ‡æ„æˆé›†ç¾¤çš„æœºå™¨ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæœºå™¨èŠ‚ç‚¹ã€‚</strong></li><li><strong>ç¬¬äºŒç±»åˆ™æ˜¯æŒ‡æ•°æ®æ¨¡å‹ä¸­çš„æ•°æ®å•å…ƒï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæ•°æ®èŠ‚ç‚¹â€”â€”ZNode</strong>ã€‚</li></ul><p>ZooKeeperå°†æ‰€æœ‰æ•°æ®å­˜å‚¨åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®æ¨¡å‹æ˜¯ä¸€æ£µæ ‘(ZNodeTree)ï¼Œç”±æ–œæ (&#x2F;)è¿›è¡Œåˆ†å‰²çš„è·¯å¾„ï¼Œå°±æ˜¯ä¸€ä¸ªZnodeï¼Œä¾‹å¦‚*&#x2F;foo&#x2F;path1*ã€‚æ¯ä¸ªZNode ä¸Šéƒ½ä¼šä¿å­˜è‡ªå·±çš„æ•°æ®å†…å®¹ï¼ŒåŒæ—¶è¿˜ä¼šä¿å­˜ä¸€ç³»åˆ—å±æ€§ä¿¡æ¯ã€‚</p><p>åœ¨ZooKeeperä¸­ï¼Œ<strong>ZNodeå¯ä»¥åˆ†ä¸ºæŒä¹…èŠ‚ç‚¹å’Œä¸´æ—¶èŠ‚ç‚¹ä¸¤ç±»</strong>ã€‚</p><ul><li>æŒä¹…èŠ‚ç‚¹æ˜¯æŒ‡ä¸€æ—¦è¿™ä¸ªZNode è¢«åˆ›å»ºäº†ï¼Œé™¤éä¸»åŠ¨è¿›è¡ŒZNodeçš„ç§»é™¤æ“ä½œï¼Œå¦åˆ™è¿™ä¸ªZNode å°†ä¸€ç›´ä¿å­˜åœ¨ZooKeeperä¸Šã€‚</li><li>ä¸´æ—¶èŠ‚ç‚¹å°±ä¸ä¸€æ ·äº†ï¼Œå®ƒçš„ç”Ÿå‘½å‘¨æœŸå’Œå®¢æˆ·ç«¯ä¼šè¯ç»‘å®šï¼Œä¸€æ—¦å®¢æˆ·ç«¯ä¼šè¯å¤±æ•ˆï¼Œé‚£ä¹ˆè¿™ä¸ªå®¢æˆ·ç«¯åˆ›å»ºçš„æ‰€æœ‰ä¸´æ—¶èŠ‚ç‚¹éƒ½ä¼šè¢«ç§»é™¤ã€‚</li></ul><p>ZooKeeperè¿˜å…è®¸ç”¨æˆ·ä¸ºæ¯ä¸ªèŠ‚ç‚¹æ·»åŠ ä¸€ä¸ªç‰¹æ®Šçš„å±æ€§:SEQUENTIALã€‚ä¸€æ—¦èŠ‚ç‚¹è¢«æ ‡è®°ä¸Šè¿™ä¸ªå±æ€§ï¼Œé‚£ä¹ˆåœ¨è¿™ä¸ªèŠ‚ç‚¹è¢«åˆ›å»ºçš„æ—¶å€™ï¼ŒZooKeeperä¼šè‡ªåŠ¨åœ¨å…¶èŠ‚ç‚¹ååé¢è¿½åŠ ä¸Šä¸€ä¸ªæ•´å‹æ•°å­—ï¼Œè¿™ä¸ªæ•´å‹æ•°å­—æ˜¯ä¸€ä¸ªç”±çˆ¶èŠ‚ç‚¹ç»´æŠ¤çš„è‡ªå¢æ•°å­—ã€‚</p><h3 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h3><p>ZooKeeperçš„æ¯ä¸ªZNodeä¸Šéƒ½ä¼šå­˜å‚¨æ•°æ®ï¼Œå¯¹åº”äºæ¯ä¸ªZNodeï¼ŒZooKeeper éƒ½ä¼šä¸ºå…¶<strong>ç»´æŠ¤ä¸€ä¸ªå«ä½œStatçš„æ•°æ®ç»“æ„</strong>ï¼ŒStatä¸­è®°å½•äº†è¿™ä¸ªZNode çš„ä¸‰ä¸ªæ•°æ®ç‰ˆæœ¬</p><ul><li>version(å½“å‰ZNodeçš„ç‰ˆæœ¬)</li><li>cversion(å½“å‰ZNode å­èŠ‚ç‚¹çš„ç‰ˆæœ¬)</li><li>aversion(å½“å‰ ZNodeçš„ ACL ç‰ˆæœ¬)</li></ul><h3 id="Watcher"><a href="#Watcher" class="headerlink" title="Watcher"></a>Watcher</h3><p>Watcher(äº‹ä»¶ç›‘å¬å™¨)ï¼Œæ˜¯ZooKeeperä¸­çš„ä¸€ä¸ªå¾ˆé‡è¦çš„ç‰¹æ€§ã€‚ZooKeeperå…è®¸ç”¨æˆ·åœ¨æŒ‡å®šèŠ‚ç‚¹ä¸Šæ³¨å†Œä¸€äº› Watcherï¼Œå¹¶ä¸”åœ¨ä¸€äº›ç‰¹å®šäº‹ä»¶è§¦å‘çš„æ—¶å€™ï¼ŒZooKeeper æœåŠ¡ç«¯ä¼šå°†äº‹ä»¶é€šçŸ¥åˆ°æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯ä¸Šå»ï¼Œè¯¥æœºåˆ¶æ˜¯ZooKeeperå®ç°åˆ†å¸ƒå¼åè°ƒæœåŠ¡çš„é‡è¦ç‰¹æ€§ã€‚</p><h3 id="ACL"><a href="#ACL" class="headerlink" title="ACL"></a>ACL</h3><p>ZooKeeperé‡‡ç”¨ACL(Access Control Lists)ç­–ç•¥æ¥è¿›è¡Œæƒé™æ§åˆ¶ï¼Œç±»ä¼¼äº UNIX æ–‡ä»¶ç³»ç»Ÿçš„æƒé™æ§åˆ¶ã€‚</p><p>ZooKeeperå®šä¹‰äº†å¦‚ä¸‹5ç§æƒé™ï¼š</p><ul><li><strong>CREATE</strong>ï¼šåˆ›å»ºå­èŠ‚ç‚¹çš„æƒé™ã€‚</li><li><strong>READ</strong>ï¼šè·å–èŠ‚ç‚¹æ•°æ®å’Œå­èŠ‚ç‚¹åˆ—è¡¨çš„æƒé™ã€‚</li><li><strong>WRITE</strong>ï¼šæ›´æ–°èŠ‚ç‚¹æ•°æ®çš„æƒé™ã€‚</li><li><strong>DELETE</strong>ï¼šåˆ é™¤å­èŠ‚ç‚¹çš„æƒé™ã€‚</li><li><strong>ADMIN</strong>ï¼šè®¾ç½®èŠ‚ç‚¹ACLçš„æƒé™ã€‚</li></ul><p>CREATE å’Œ DELETE è¿™ä¸¤ç§æƒé™éƒ½æ˜¯é’ˆå¯¹å­èŠ‚ç‚¹çš„æƒé™æ§åˆ¶ã€‚</p><h2 id="ä¸ºä»€ä¹ˆè¦é€‰æ‹©ZooKeeper"><a href="#ä¸ºä»€ä¹ˆè¦é€‰æ‹©ZooKeeper" class="headerlink" title="ä¸ºä»€ä¹ˆè¦é€‰æ‹©ZooKeeper"></a>ä¸ºä»€ä¹ˆè¦é€‰æ‹©ZooKeeper</h2><ul><li>åœ¨è§£å†³åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§ä¸Šï¼Œé™¤äº†ZooKeeper ä¹‹å¤–ï¼Œç›®å‰è¿˜æ²¡æœ‰ä¸€ä¸ªæˆç†Ÿç¨³å®šä¸”è¢«å¤§è§„æ¨¡åº”ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚ZooKeeperæ— è®ºä»æ€§èƒ½ã€æ˜“ç”¨æ€§è¿˜æ˜¯ç¨³å®šæ€§ä¸Šæ¥è¯´ï¼Œéƒ½å·²ç»è¾¾åˆ°äº†ä¸€ä¸ªå·¥ä¸šçº§äº§å“çš„æ ‡å‡†ã€‚</li><li>ZooKeeperæ˜¯å¼€æ”¾æºä»£ç çš„ï¼Œæ‰€æœ‰äººéƒ½åœ¨å…³æ³¨å®ƒçš„å‘å±•ï¼Œéƒ½æœ‰æƒåˆ©æ¥è´¡çŒ®è‡ªå·±çš„åŠ›é‡ï¼Œä½ å¯ä»¥å’Œå…¨ä¸–ç•Œæˆåƒä¸Šä¸‡çš„ZooKeeper å¼€å‘è€…ä»¬ä¸€èµ·äº¤æµä½¿ç”¨ç»éªŒï¼Œå…±åŒè§£å†³é—®é¢˜ã€‚</li><li>ZooKeeperæ˜¯å…è´¹çš„ï¼Œä½ æ— é¡»ä¸ºå®ƒæ”¯ä»˜ä»»ä½•è´¹ç”¨ã€‚è¿™ç‚¹å¯¹äºä¸€ä¸ªå°å‹å…¬å¸ï¼Œå°¤å…¶æ˜¯åˆåˆ›å›¢é˜Ÿæ¥è¯´ï¼Œæ— ç–‘æ˜¯éå¸¸é‡è¦çš„ã€‚</li><li>ZooKeeperå·²ç»å¾—åˆ°äº†å¹¿æ³›çš„åº”ç”¨ã€‚è¶Šæ¥è¶Šå¤šçš„å¤§å‹åˆ†å¸ƒå¼é¡¹ç›®éƒ½å·²ç»å°†ZooKeeperä½œä¸ºå…¶æ ¸å¿ƒç»„ä»¶ï¼Œç”¨äºåˆ†å¸ƒå¼åè°ƒã€‚</li></ul><h1 id="ZABåè®®ç®€ä»‹"><a href="#ZABåè®®ç®€ä»‹" class="headerlink" title="ZABåè®®ç®€ä»‹"></a>ZABåè®®ç®€ä»‹</h1><p>ZooKeeper Atomic Broadcast(ZABï¼ŒZooKeeperåŸå­æ¶ˆæ¯å¹¿æ’­åè®®)ï¼ŒZABåè®®æ˜¯ä¸ºåˆ†å¸ƒå¼åè°ƒæœåŠ¡ZooKeeperä¸“é—¨è®¾è®¡çš„ä¸€ç§æ”¯æŒå´©æºƒæ¢å¤çš„åŸå­å¹¿æ’­åè®®ã€‚å®ƒæ˜¯ä¸€ç§ç‰¹åˆ«ä¸ºZooKeeper è®¾è®¡çš„å´©æºƒå¯æ¢å¤çš„åŸå­æ¶ˆæ¯å¹¿æ’­ç®—æ³•ã€‚</p><p>åœ¨ZooKeeperä¸­,ä¸»è¦ä¾èµ–ZABåè®®æ¥å®ç°åˆ†å¸ƒå¼æ•°æ®ä¸€è‡´æ€§,åŸºäºè¯¥åè®®,ZooKeeperå®ç°äº†ä¸€ç§ä¸»å¤‡æ¨¡å¼çš„ç³»ç»Ÿæ¶æ„æ¥ä¿æŒé›†ç¾¤ä¸­å„å‰¯æœ¬ä¹‹é—´æ•°æ®çš„ä¸€è‡´æ€§ã€‚</p><p><strong>ZABåè®®åŒ…æ‹¬ä¸¤ç§åŸºæœ¬çš„æ¨¡å¼ï¼Œåˆ†åˆ«æ˜¯å´©æºƒæ¢å¤å’Œæ¶ˆæ¯å¹¿æ’­</strong></p><p><strong>ZABåè®®çš„æ ¸å¿ƒæ˜¯å®šä¹‰äº†å¯¹äºé‚£äº›ä¼šæ”¹å˜ZoKeeperæœåŠ¡å™¨æ•°æ®çŠ¶æ€çš„äº‹åŠ¡è¯·æ±‚çš„å¤„ç†æ–¹å¼</strong>ï¼Œå³ï¼š</p><p><em>æ‰€æœ‰äº‹åŠ¡è¯·æ±‚å¿…é¡»ç”±ä¸€ä¸ªå…¨å±€å”¯ä¸€çš„æœåŠ¡å™¨æ¥åè°ƒå¤„ç†ï¼Œè¿™æ ·çš„æœåŠ¡å™¨è¢«ç§°ä¸ºLeaderæœåŠ¡å™¨ï¼Œè€Œä½™ä¸‹çš„å…¶ä»–æœåŠ¡å™¨åˆ™æˆä¸º Follower æœåŠ¡å™¨ã€‚Leader æœåŠ¡å™¨è´Ÿè´£å°†ä¸€ä¸ªå®¢æˆ·ç«¯äº‹åŠ¡è¯·æ±‚è½¬æ¢æˆä¸€ä¸ªäº‹åŠ¡ Proposal(æè®®)ï¼Œå¹¶å°†è¯¥Proposalåˆ†å‘ç»™é›†ç¾¤ä¸­æ‰€æœ‰çš„Follower æœåŠ¡å™¨ã€‚ä¹‹å Leader æœåŠ¡å™¨éœ€è¦ç­‰å¾…æ‰€æœ‰ Follower æœåŠ¡å™¨çš„åé¦ˆï¼Œä¸€æ—¦è¶…è¿‡åŠæ•°çš„ Follower æœåŠ¡å™¨è¿›è¡Œäº†æ­£ç¡®çš„åé¦ˆåï¼Œé‚£ä¹ˆ Leader å°±ä¼šå†æ¬¡å‘æ‰€æœ‰çš„ FolloweræœåŠ¡å™¨åˆ†å‘Commitæ¶ˆæ¯ï¼Œè¦æ±‚å…¶å°†å‰ä¸€ä¸ªProposalè¿›è¡Œæäº¤ã€‚</em></p><h1 id="æ¶ˆæ¯å¹¿æ’­"><a href="#æ¶ˆæ¯å¹¿æ’­" class="headerlink" title="æ¶ˆæ¯å¹¿æ’­"></a>æ¶ˆæ¯å¹¿æ’­</h1><p>ZABåè®®çš„æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä½¿ç”¨çš„æ˜¯ä¸€ä¸ªåŸå­å¹¿æ’­åè®®ï¼Œç±»ä¼¼äºä¸€ä¸ªäºŒé˜¶æ®µæäº¤è¿‡ç¨‹ã€‚é’ˆå¯¹å®¢æˆ·ç«¯çš„äº‹åŠ¡è¯·æ±‚ï¼ŒLeaderæœåŠ¡å™¨ä¼šä¸ºå…¶ç”Ÿæˆå¯¹åº”çš„äº‹åŠ¡Proposalï¼Œå¹¶å°†å…¶å‘é€ç»™é›†ç¾¤ä¸­å…¶ä½™æ‰€æœ‰çš„æœºå™¨ï¼Œç„¶åå†åˆ†åˆ«æ”¶é›†å„è‡ªçš„é€‰ç¥¨ï¼Œæœ€åè¿›è¡Œäº‹åŠ¡æäº¤ã€‚</p><p><img src="/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/image-20240707214541670.png" alt="ZABåè®®æ¶ˆæ¯å¹¿æ’­æµç¨‹ç¤ºæ„å›¾"></p><p>æ•´ä¸ªæ¶ˆæ¯å¹¿æ’­åè®®æ˜¯åŸºäºå…·æœ‰FIFOç‰¹æ€§çš„TCPåè®®æ¥è¿›è¡Œç½‘ç»œé€šä¿¡çš„ï¼Œå› æ­¤èƒ½å¤Ÿå¾ˆå®¹æ˜“åœ°ä¿è¯æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä¸­æ¶ˆæ¯æ¥æ”¶ä¸å‘é€çš„é¡ºåºæ€§ã€‚</p><p>åœ¨æ•´ä¸ªæ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä¸­ï¼ŒLeaderæœåŠ¡å™¨ä¼šä¸ºæ¯ä¸ªäº‹åŠ¡è¯·æ±‚ç”Ÿæˆå¯¹åº”çš„Proposalæ¥è¿›è¡Œå¹¿æ’­ï¼Œå¹¶ä¸”åœ¨å¹¿æ’­äº‹åŠ¡Proposalä¹‹å‰ï¼Œ<strong>LeaderæœåŠ¡å™¨ä¼šé¦–å…ˆä¸ºè¿™ä¸ªäº‹åŠ¡Proposalåˆ†é…ä¸€ä¸ªå…¨å±€å•è°ƒé€’å¢çš„å”¯ä¸€ID</strong>ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºäº‹åŠ¡ID(å³ZXID)ã€‚ç”±äºZABåè®®éœ€è¦ä¿è¯æ¯ä¸€ä¸ªæ¶ˆæ¯ä¸¥æ ¼çš„å› æœå…³ç³»ï¼Œå› æ­¤å¿…é¡»å°†æ¯ä¸€ä¸ªäº‹åŠ¡ProposalæŒ‰ç…§å…¶ZXIDçš„å…ˆåé¡ºåºæ¥è¿›è¡Œæ’åºä¸å¤„ç†ã€‚</p><blockquote><p>åœ¨æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ä¸­ï¼ŒLeaderæœåŠ¡å™¨ä¼šä¸ºæ¯ä¸€ä¸ªFolloweræœåŠ¡å™¨éƒ½å„è‡ªåˆ†é…ä¸€ä¸ªå•ç‹¬çš„é˜Ÿåˆ—ï¼Œç„¶åå°†éœ€è¦å¹¿æ’­çš„äº‹åŠ¡Proposalä¾æ¬¡æ”¾å…¥è¿™äº›é˜Ÿåˆ—ä¸­å»ï¼Œå¹¶ä¸”æ ¹æ®FIFOç­–ç•¥è¿›è¡Œæ¶ˆæ¯å‘é€ã€‚æ¯ä¸€ä¸ªFolloweræœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°è¿™ä¸ªäº‹åŠ¡Proposalä¹‹åï¼Œéƒ½ä¼šé¦–å…ˆå°†å…¶ä»¥äº‹åŠ¡æ—¥å¿—çš„å½¢å¼å†™å…¥åˆ°æœ¬åœ°ç£ç›˜ä¸­å»,å¹¶ä¸”åœ¨æˆåŠŸå†™å…¥ååé¦ˆç»™LeaderæœåŠ¡å™¨ä¸€ä¸ªAck å“åº”ã€‚å½“LeaderæœåŠ¡å™¨æ¥æ”¶åˆ°è¶…è¿‡åŠæ•°Followerçš„Ack å“åº”åï¼Œå°±ä¼šå¹¿æ’­ä¸€ä¸ªCommit æ¶ˆæ¯ç»™æ‰€æœ‰çš„Follower æœåŠ¡å™¨ä»¥é€šçŸ¥å…¶è¿›è¡Œäº‹åŠ¡æäº¤ï¼ŒåŒæ—¶Leader è‡ªèº«ä¹Ÿä¼šå®Œæˆå¯¹äº‹åŠ¡çš„æäº¤ï¼Œè€Œæ¯ä¸€ä¸ªFolloweræœåŠ¡å™¨åœ¨æ¥æ”¶åˆ°Commitæ¶ˆæ¯åï¼Œä¹Ÿä¼šå®Œæˆå¯¹äº‹åŠ¡çš„æäº¤ã€‚</p></blockquote><h1 id="å´©æºƒæ¢å¤"><a href="#å´©æºƒæ¢å¤" class="headerlink" title="å´©æºƒæ¢å¤"></a>å´©æºƒæ¢å¤</h1><p>ZABåè®®çš„è¿™ä¸ªåŸºäºåŸå­å¹¿æ’­åè®®çš„æ¶ˆæ¯å¹¿æ’­è¿‡ç¨‹ï¼Œåœ¨æ­£å¸¸æƒ…å†µä¸‹è¿è¡Œéå¸¸è‰¯å¥½ï¼Œä½†æ˜¯<strong>ä¸€æ—¦LeaderæœåŠ¡å™¨å‡ºç°å´©æºƒï¼Œæˆ–è€…è¯´ç”±äºç½‘ç»œåŸå› å¯¼è‡´LeaderæœåŠ¡å™¨å¤±å»äº†ä¸è¿‡åŠFollowerçš„è”ç³»ï¼Œé‚£ä¹ˆå°±ä¼šè¿›å…¥å´©æºƒæ¢å¤æ¨¡å¼</strong>ã€‚</p><p>åœ¨ZABåè®®ä¸­ï¼Œä¸ºäº†ä¿è¯ç¨‹åºçš„æ­£ç¡®è¿è¡Œï¼Œæ•´ä¸ªæ¢å¤è¿‡ç¨‹ç»“æŸåéœ€è¦é€‰ä¸¾å‡ºä¸€ä¸ªæ–°çš„Leader æœåŠ¡å™¨ã€‚å› æ­¤ï¼ŒZABåè®®éœ€è¦ä¸€ä¸ªé«˜æ•ˆä¸”å¯é çš„Leader é€‰ä¸¾ç®—æ³•ä»è€Œç¡®ä¿èƒ½å¤Ÿå¿«é€Ÿåœ°é€‰ä¸¾å‡ºæ–°çš„Leaderã€‚åŒæ—¶ï¼ŒLeader é€‰ä¸¾ç®—æ³•ä¸ä»…ä»…éœ€è¦è®©Leaderè‡ªå·±çŸ¥é“å…¶è‡ªèº«å·²ç»è¢«é€‰ä¸¾ä¸ºLeader,åŒæ—¶è¿˜éœ€è¦è®©é›†ç¾¤ä¸­çš„æ‰€æœ‰å…¶ä»–æœºå™¨ä¹Ÿèƒ½å¤Ÿå¿«é€Ÿåœ°æ„ŸçŸ¥åˆ°é€‰ä¸¾äº§ç”Ÿçš„æ–°çš„Leader æœåŠ¡å™¨ã€‚</p><h3 id="åŸºæœ¬ç‰¹æ€§"><a href="#åŸºæœ¬ç‰¹æ€§" class="headerlink" title="åŸºæœ¬ç‰¹æ€§"></a>åŸºæœ¬ç‰¹æ€§</h3><p><em><strong>ZAB åè®®éœ€è¦ç¡®ä¿é‚£äº›å·²ç»åœ¨ LeaderæœåŠ¡å™¨ä¸Šæäº¤çš„äº‹åŠ¡æœ€ç»ˆè¢«æ‰€æœ‰æœåŠ¡å™¨éƒ½æäº¤</strong></em></p><p>å‡è®¾ä¸€ä¸ªäº‹åŠ¡åœ¨LeaderæœåŠ¡å™¨ä¸Šè¢«æäº¤äº†ï¼Œå¹¶ä¸”å·²ç»å¾—åˆ°è¿‡åŠFollower æœåŠ¡å™¨çš„Ackåé¦ˆï¼Œä½†æ˜¯åœ¨å®ƒå°†Commitæ¶ˆæ¯å‘é€ç»™æ‰€æœ‰Followeræœºå™¨ä¹‹å‰ï¼ŒLeaderæœåŠ¡å™¨æŒ‚äº†ã€‚</p><p><img src="/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/image-20240707223258016.png" alt="Leaderå‡ºç°æ•…éšœ"></p><p>C2å°±æ˜¯ä¸€ä¸ªå…¸å‹çš„ä¾‹å­:åœ¨é›†ç¾¤æ­£å¸¸è¿è¡Œè¿‡ç¨‹ä¸­çš„æŸä¸€ä¸ªæ—¶åˆ»ï¼ŒServer1æ˜¯ Leader æœåŠ¡å™¨ï¼Œå…¶å…ˆåå¹¿æ’­äº†æ¶ˆæ¯P1ã€P2ã€C1ã€P3å’ŒC2ï¼Œå…¶ä¸­ï¼Œå½“Leader æœåŠ¡å™¨å°†æ¶ˆæ¯C2å‘å‡ºåå°±ç«‹å³å´©æºƒé€€å‡ºäº†ã€‚é’ˆå¯¹è¿™ç§æƒ…å†µï¼ŒZABåè®®å°±éœ€è¦ç¡®ä¿äº‹åŠ¡Proposal2æœ€ç»ˆèƒ½å¤Ÿåœ¨æ‰€æœ‰çš„æœåŠ¡å™¨ä¸Šéƒ½è¢«æäº¤æˆåŠŸï¼Œå¦åˆ™å°†å‡ºç°ä¸ä¸€è‡´ã€‚</p><p><em><strong>ZAB åè®®éœ€è¦ç¡®ä¿ä¸¢å¼ƒé‚£äº›åªåœ¨LeaderæœåŠ¡å™¨ä¸Šè¢«æå‡ºçš„äº‹åŠ¡</strong></em></p><p>å¦‚æœåœ¨å´©æºƒæ¢å¤è¿‡ç¨‹ä¸­å‡ºç°ä¸€ä¸ªéœ€è¦è¢«ä¸¢å¼ƒçš„ææ¡ˆ,é‚£ä¹ˆåœ¨å´©æºƒæ¢å¤ç»“æŸåéœ€è¦è·³è¿‡è¯¥äº‹åŠ¡Proposalã€‚</p><p><img src="/2024/07/07/ZAB%E5%8D%8F%E8%AE%AE%E8%AF%A6%E8%A7%A3/image-20240707223529070.png" alt="éœ€ä¸¢å¼ƒäº‹åŠ¡ç¤ºä¾‹å›¾"></p><p>å‡è®¾åˆå§‹çš„LeaderæœåŠ¡å™¨Server1åœ¨æå‡ºäº†ä¸€ä¸ªäº‹åŠ¡Proposal3ä¹‹åå°±å´©æºƒé€€å‡ºäº†ï¼Œä»è€Œå¯¼è‡´é›†ç¾¤ä¸­çš„å…¶ä»–æœåŠ¡å™¨éƒ½æ²¡æœ‰æ”¶åˆ°è¿™ä¸ªäº‹åŠ¡Proposalã€‚äºæ˜¯ï¼Œå½“Serverlæ¢å¤è¿‡æ¥å†æ¬¡åŠ å…¥åˆ°é›†ç¾¤ä¸­çš„æ—¶å€™ï¼ŒZABåè®®éœ€è¦ç¡®ä¿ä¸¢å¼ƒProposal3è¿™ä¸ªäº‹åŠ¡ã€‚</p><p>ç»“åˆä¸Šé¢åˆ†æï¼Œ<strong>Leaderé€‰ä¸¾ç®—æ³•å¿…é¡»éµä»ï¼šèƒ½å¤Ÿç¡®ä¿æäº¤å·²ç»è¢«Leaderæäº¤çš„äº‹åŠ¡Proposalï¼ŒåŒæ—¶ä¸¢å¼ƒå·²ç»è¢«è·³è¿‡çš„äº‹åŠ¡Proposalã€‚</strong></p><blockquote><p>å¦‚æœè®©Leaderé€‰ä¸¾ç®—æ³•èƒ½å¤Ÿä¿è¯æ–°é€‰ä¸¾å‡ºæ¥çš„LeaderæœåŠ¡å™¨æ‹¥æœ‰é›†ç¾¤ä¸­æ‰€æœ‰æœºå™¨æœ€é«˜ç¼–å·(å³ZXIDæœ€å¤§)çš„äº‹åŠ¡Proposalé‚£ä¹ˆå°±å¯ä»¥ä¿è¯è¿™ä¸ªæ–°é€‰ä¸¾å‡ºæ¥çš„Leader ä¸€å®šå…·æœ‰æ‰€æœ‰å·²ç»æäº¤çš„ææ¡ˆã€‚æ›´ä¸ºé‡è¦çš„æ˜¯å¦‚æœè®©å…·æœ‰æœ€é«˜ç¼–å·äº‹åŠ¡Proposalçš„æœºå™¨æ¥æˆä¸ºLeaderï¼Œå°±å¯ä»¥çœå»LeaderæœåŠ¡å™¨æ£€æŸ¥Proposalçš„æäº¤å’Œä¸¢å¼ƒå·¥ä½œçš„è¿™ä¸€æ­¥æ“ä½œäº†ã€‚</p></blockquote><div class="note note-success">            <p>ä¸‹æœŸé¢„å‘Šï¼š</p><ul><li>æ›´åŠ æ·±å…¥çš„ç†è§£ZABåè®®</li></ul>          </div>]]></content>
    
    
    <categories>
      
      <category>è¯»ä¹¦éšè®°</category>
      
      <category>ä»Paxosåˆ°Zookeeperï¼šåˆ†å¸ƒå¼ä¸€è‡´æ€§åŸç†ä¸å®è·µ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>ZooKeeper</tag>
      
      <tag>ZABåè®®</tag>
      
      <tag>åŸç†</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>äºŒåˆ†æŸ¥æ‰¾æ¨¡æ¿</title>
    <link href="/2024/07/07/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%A8%A1%E6%9D%BF/"/>
    <url>/2024/07/07/%E4%BA%8C%E5%88%86%E6%9F%A5%E6%89%BE%E6%A8%A1%E6%9D%BF/</url>
    
    <content type="html"><![CDATA[<h1 id="äºŒåˆ†æŸ¥æ‰¾"><a href="#äºŒåˆ†æŸ¥æ‰¾" class="headerlink" title="äºŒåˆ†æŸ¥æ‰¾"></a>äºŒåˆ†æŸ¥æ‰¾</h1><blockquote><p>æ•°ç»„å¿…é¡»æœ‰åºï¼Œå¦åˆ™äºŒåˆ†æŸ¥æ‰¾ç®—æ³•å°±ä¼šå¤±æ•ˆ</p></blockquote><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs c"><span class="hljs-type">int</span> <span class="hljs-title function_">search</span><span class="hljs-params">(<span class="hljs-type">int</span>* nums, <span class="hljs-type">int</span> numsSize, <span class="hljs-type">int</span> target)</span>&#123;<br>    <span class="hljs-type">int</span> left = <span class="hljs-number">0</span>;<br>    <span class="hljs-type">int</span> right = numsSize<span class="hljs-number">-1</span>;<br>    <span class="hljs-type">int</span> middle = <span class="hljs-number">0</span>;<br>    <span class="hljs-comment">//è‹¥leftå°äºç­‰äºrightï¼Œè¯´æ˜åŒºé—´ä¸­å…ƒç´ ä¸ä¸º0</span><br>    <span class="hljs-keyword">while</span>(left&lt;=right) &#123;<br>        <span class="hljs-comment">//æ›´æ–°æŸ¥æ‰¾ä¸‹æ ‡middleçš„å€¼</span><br>        middle = (left+right)/<span class="hljs-number">2</span>;<br>        <span class="hljs-comment">//æ­¤æ—¶targetå¯èƒ½ä¼šåœ¨[left,middle-1]åŒºé—´ä¸­</span><br>        <span class="hljs-keyword">if</span>(nums[middle] &gt; target) &#123;<br>            right = middle<span class="hljs-number">-1</span>;<br>        &#125; <br>        <span class="hljs-comment">//æ­¤æ—¶targetå¯èƒ½ä¼šåœ¨[middle+1,right]åŒºé—´ä¸­</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums[middle] &lt; target) &#123;<br>            left = middle+<span class="hljs-number">1</span>;<br>        &#125; <br>        <span class="hljs-comment">//å½“å‰ä¸‹æ ‡å…ƒç´ ç­‰äºtargetå€¼æ—¶ï¼Œè¿”å›middle</span><br>        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span>(nums[middle] == target)&#123;<br>            <span class="hljs-keyword">return</span> middle;<br>        &#125;<br>    &#125;<br>    <span class="hljs-comment">//è‹¥æœªæ‰¾åˆ°targetå…ƒç´ ï¼Œè¿”å›-1</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>ç®—æ³•</category>
      
      <category>å¤‡è€ƒ</category>
      
    </categories>
    
    
    <tags>
      
      <tag>C</tag>
      
      <tag>864</tag>
      
      <tag>å¤‡è€ƒ</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹æ’•RPCæ¡†æ¶â€”â€”å¼•å…¥Netty</title>
    <link href="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/"/>
    <url>/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/</url>
    
    <content type="html"><![CDATA[<blockquote><p>ä¸Šç¯‡æ–‡ç« ä¸­æˆ‘ä»¬ä½¿ç”¨äº†Socketç¼–ç¨‹å®ç°äº†ä¸€ä¸ªç®€å•çš„RPCè°ƒç”¨çš„demoï¼Œæ­¤ç¯‡æ–‡ç« ï¼Œå¼•å…¥Nettyæ¡†æ¶æ¥è¿›ä¸€æ­¥æå‡æ¡†æ¶æ€§èƒ½ã€‚æ¯ç¯‡æ–‡ç« å¯¹åº”çš„å…«è‚¡çŸ¥è¯†æˆ‘ä¼šåœ¨æ”¶é›†æ•´ç†ç›¸å…³èµ„æ–™åå‘å‡ºï¼Œæ•¬è¯·æœŸå¾…ï¼ğŸ˜Š</p><p>é¡¹ç›®åœ°å€ï¼š<a href="https://github.com/youngyangyang04/RPC-Java">ã€ä»£ç éšæƒ³å½•çŸ¥è¯†æ˜Ÿçƒã€‘é¡¹ç›®åˆ†äº«-æ‰‹æ’•RPCæ¡†æ¶</a></p></blockquote><h1 id="ç›¸å…³ç†è®ºåŸºç¡€"><a href="#ç›¸å…³ç†è®ºåŸºç¡€" class="headerlink" title="ç›¸å…³ç†è®ºåŸºç¡€"></a>ç›¸å…³ç†è®ºåŸºç¡€</h1><blockquote><p>ç®€å•ä»‹ç»ä¸€ä¸‹Nettyï¼Œå¯¹æ¯”Socketç¼–ç¨‹Nettyæœ‰å“ªäº›ä¼˜åŠ¿ï¼</p></blockquote><p>Netty æ˜¯ä¸€ä¸ª NIO å®¢æˆ·ç«¯æœåŠ¡å™¨æ¡†æ¶ï¼Œå¯å¿«é€Ÿè½»æ¾åœ°å¼€å‘ç½‘ç»œåº”ç”¨ç¨‹åºï¼Œä¾‹å¦‚åè®®æœåŠ¡å™¨å’Œå®¢æˆ·ç«¯ã€‚å®ƒæå¤§åœ°ç®€åŒ–å’Œç®€åŒ–äº†ç½‘ç»œç¼–ç¨‹ï¼Œä¾‹å¦‚ TCP å’Œ UDP å¥—æ¥å­—æœåŠ¡å™¨ã€‚</p><h2 id="Nettyæ ¸å¿ƒç»„ä»¶"><a href="#Nettyæ ¸å¿ƒç»„ä»¶" class="headerlink" title="Nettyæ ¸å¿ƒç»„ä»¶"></a>Nettyæ ¸å¿ƒç»„ä»¶</h2><h3 id="Channel"><a href="#Channel" class="headerlink" title="Channel"></a>Channel</h3><p>Channelæ˜¯ Java NIO çš„ä¸€ä¸ªåŸºæœ¬æ„é€ ã€‚å¯ä»¥çœ‹ä½œæ˜¯ä¼ å…¥æˆ–ä¼ å‡ºæ•°æ®çš„è½½ä½“ã€‚å› æ­¤ï¼Œå®ƒå¯ä»¥è¢«æ‰“å¼€æˆ–å…³é—­ï¼Œè¿æ¥æˆ–è€…æ–­å¼€è¿æ¥ã€‚</p><h3 id="EventLoop-ä¸-EventLoopGroup"><a href="#EventLoop-ä¸-EventLoopGroup" class="headerlink" title="EventLoop ä¸ EventLoopGroup"></a>EventLoop ä¸ EventLoopGroup</h3><p>EventLoop å®šä¹‰äº†Nettyçš„æ ¸å¿ƒæŠ½è±¡ï¼Œç”¨æ¥å¤„ç†è¿æ¥çš„ç”Ÿå‘½å‘¨æœŸä¸­æ‰€å‘ç”Ÿçš„äº‹ä»¶ï¼Œåœ¨å†…éƒ¨ï¼Œå°†ä¼šä¸ºæ¯ä¸ªChannelåˆ†é…ä¸€ä¸ªEventLoopã€‚</p><p>EventLoopGroup æ˜¯ä¸€ä¸ª EventLoop æ± ï¼ŒåŒ…å«å¾ˆå¤šçš„ EventLoopã€‚</p><p> Netty ä¸ºæ¯ä¸ª Channel åˆ†é…äº†ä¸€ä¸ª EventLoopï¼Œç”¨äºå¤„ç†ç”¨æˆ·è¿æ¥è¯·æ±‚ã€å¯¹ç”¨æˆ·è¯·æ±‚çš„å¤„ç†ç­‰æ‰€æœ‰äº‹ä»¶ã€‚EventLoop æœ¬èº«åªæ˜¯ä¸€ä¸ªçº¿ç¨‹é©±åŠ¨ï¼Œåœ¨å…¶ç”Ÿå‘½å‘¨æœŸå†…åªä¼šç»‘å®šä¸€ä¸ªçº¿ç¨‹ï¼Œè®©è¯¥çº¿ç¨‹å¤„ç†ä¸€ä¸ª Channel çš„æ‰€æœ‰ IO äº‹ä»¶ã€‚</p><p>ä¸€ä¸ª Channel ä¸€æ—¦ä¸ä¸€ä¸ª EventLoop ç›¸ç»‘å®šï¼Œé‚£ä¹ˆåœ¨ Channel çš„æ•´ä¸ªç”Ÿå‘½å‘¨æœŸå†…æ˜¯ä¸èƒ½æ”¹å˜çš„ã€‚ä¸€ä¸ª EventLoop å¯ä»¥ä¸å¤šä¸ª Channel ç»‘å®šã€‚å³ Channel ä¸ EventLoop çš„å…³ç³»æ˜¯ n:1ï¼Œè€Œ EventLoop ä¸çº¿ç¨‹çš„å…³ç³»æ˜¯ 1:1ã€‚</p><h3 id="ServerBootstrap-ä¸-Bootstrap"><a href="#ServerBootstrap-ä¸-Bootstrap" class="headerlink" title="ServerBootstrap ä¸ Bootstrap"></a>ServerBootstrap ä¸ Bootstrap</h3><p>Bootstarp å’Œ ServerBootstrap è¢«ç§°ä¸ºå¼•å¯¼ç±»ï¼ŒæŒ‡å¯¹åº”ç”¨ç¨‹åºè¿›è¡Œé…ç½®ï¼Œå¹¶ä½¿ä»–è¿è¡Œèµ·æ¥çš„è¿‡ç¨‹ã€‚Nettyå¤„ç†å¼•å¯¼çš„æ–¹å¼æ˜¯ä½¿ä½ çš„åº”ç”¨ç¨‹åºå’Œç½‘ç»œå±‚ç›¸éš”ç¦»ã€‚</p><p>Bootstrap æ˜¯å®¢æˆ·ç«¯çš„å¼•å¯¼ç±»ï¼ŒBootstrap åœ¨è°ƒç”¨ bind()ï¼ˆè¿æ¥UDPï¼‰å’Œ connect()ï¼ˆè¿æ¥TCPï¼‰æ–¹æ³•æ—¶ï¼Œä¼šæ–°åˆ›å»ºä¸€ä¸ª Channelï¼Œä»…åˆ›å»ºä¸€ä¸ªå•ç‹¬çš„ã€æ²¡æœ‰çˆ¶ Channel çš„ Channel æ¥å®ç°æ‰€æœ‰çš„ç½‘ç»œäº¤æ¢ã€‚</p><p>ServerBootstrap æ˜¯æœåŠ¡ç«¯çš„å¼•å¯¼ç±»ï¼ŒServerBootstarp åœ¨è°ƒç”¨ bind() æ–¹æ³•æ—¶ä¼šåˆ›å»ºä¸€ä¸ª ServerChannel æ¥æ¥å—æ¥è‡ªå®¢æˆ·ç«¯çš„è¿æ¥ï¼Œå¹¶ä¸”è¯¥ ServerChannel ç®¡ç†äº†å¤šä¸ªå­ Channel ç”¨äºåŒå®¢æˆ·ç«¯ä¹‹é—´çš„é€šä¿¡ã€‚</p><h3 id="ChannelHandler-ä¸-ChannelPipeline"><a href="#ChannelHandler-ä¸-ChannelPipeline" class="headerlink" title="ChannelHandler ä¸ ChannelPipeline"></a>ChannelHandler ä¸ ChannelPipeline</h3><p>ChannelHandler æ˜¯å¯¹ Channel ä¸­æ•°æ®çš„å¤„ç†å™¨ï¼Œè¿™äº›å¤„ç†å™¨å¯ä»¥æ˜¯ç³»ç»Ÿæœ¬èº«å®šä¹‰å¥½çš„ç¼–è§£ç å™¨ï¼Œä¹Ÿå¯ä»¥æ˜¯ç”¨æˆ·è‡ªå®šä¹‰çš„ã€‚è¿™äº›å¤„ç†å™¨ä¼šè¢«ç»Ÿä¸€æ·»åŠ åˆ°ä¸€ä¸ª ChannelPipeline çš„å¯¹è±¡ä¸­ï¼Œç„¶åæŒ‰ç…§æ·»åŠ çš„é¡ºåºå¯¹ Channel ä¸­çš„æ•°æ®è¿›è¡Œä¾æ¬¡å¤„ç†ã€‚</p><h3 id="ChannelFuture"><a href="#ChannelFuture" class="headerlink" title="ChannelFuture"></a>ChannelFuture</h3><p>Netty ä¸­æ‰€æœ‰çš„ I&#x2F;O æ“ä½œéƒ½æ˜¯å¼‚æ­¥çš„ï¼Œå³æ“ä½œä¸ä¼šç«‹å³å¾—åˆ°è¿”å›ç»“æœï¼Œæ‰€ä»¥ Netty ä¸­å®šä¹‰äº†ä¸€ä¸ª ChannelFuture å¯¹è±¡ä½œä¸ºè¿™ä¸ªå¼‚æ­¥æ“ä½œçš„â€œä»£è¨€äººâ€ï¼Œè¡¨ç¤ºå¼‚æ­¥æ“ä½œæœ¬èº«ã€‚å¦‚æœæƒ³è·å–åˆ°è¯¥å¼‚æ­¥æ“ä½œçš„è¿”å›å€¼ï¼Œå¯ä»¥é€šè¿‡è¯¥å¼‚æ­¥æ“ä½œå¯¹è±¡çš„addListener() æ–¹æ³•ä¸ºè¯¥å¼‚æ­¥æ“ä½œæ·»åŠ ç›‘ NIO ç½‘ç»œç¼–ç¨‹æ¡†æ¶ Netty å¬å™¨ï¼Œä¸ºå…¶æ³¨å†Œå›è°ƒï¼šå½“ç»“æœå‡ºæ¥åé©¬ä¸Šè°ƒç”¨æ‰§è¡Œã€‚</p><h2 id="ä¸Socektç›¸æ¯”ä¼˜åŠ¿"><a href="#ä¸Socektç›¸æ¯”ä¼˜åŠ¿" class="headerlink" title="ä¸Socektç›¸æ¯”ä¼˜åŠ¿"></a>ä¸Socektç›¸æ¯”ä¼˜åŠ¿</h2><ul><li><p>ç”±BIOè½¬æ¢ä¸ºNIO</p><ul><li>é˜»å¡(Block)ï¼šå¾€å¾€éœ€è¦ç­‰å¾…ç¼“å†²åŒºä¸­çš„æ•°æ®å‡†å¤‡å¥½è¿‡åæ‰å¤„ç†å…¶ä»–çš„äº‹æƒ…ï¼Œå¦åˆ™&#x3D;&#x3D;ä¸€ç›´ç­‰å¾…åœ¨é‚£é‡Œ&#x3D;&#x3D;ã€‚<br><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/d708f66ee8a201f8edefc55265a7b0a6.jpeg" alt="é˜»å¡IO"></li><li>éé˜»å¡(Non-Block)ï¼šå½“æˆ‘ä»¬çš„è¿›ç¨‹è®¿é—®æˆ‘ä»¬çš„æ•°æ®ç¼“å†²åŒºçš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®æ²¡æœ‰å‡†å¤‡å¥½åˆ™ç›´æ¥è¿”å›ï¼Œ&#x3D;&#x3D;ä¸ä¼šç­‰å¾…&#x3D;&#x3D;ã€‚å¦‚æœæ•°æ®å·²ç»å‡†å¤‡å¥½ï¼Œä¹Ÿç›´æ¥è¿”å›ã€‚<br><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/c6a30bf0145c5cefb8f3c63f7891c579.jpeg" alt="éé˜»å¡IO"></li></ul></li><li><p>å¯ä»¥è‡ªä¸»ç¼–å†™ ç¼–ç &#x2F;è§£ç å™¨ï¼Œåºåˆ—åŒ–å™¨ç­‰ç­‰ï¼Œå¯æ‹“å±•æ€§å’Œçµæ´»æ€§é«˜</p></li><li><p>æ”¯æŒTCP,UDPå¤šç§ä¼ è¾“åè®®ï¼›æ”¯æŒå µå¡è¿”å›å’Œå¼‚æ­¥è¿”å›</p></li></ul><h1 id="å®ç°æ€è·¯"><a href="#å®ç°æ€è·¯" class="headerlink" title="å®ç°æ€è·¯"></a>å®ç°æ€è·¯</h1><p><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/FnzgTn3TXtUxV0ao_sHtxSQm3CjA.png" alt="Nettyæ‰€èµ·åˆ°çš„ä½œç”¨"></p><ul><li>å®¢æˆ·ç«¯è°ƒç”¨RpcClient.sendRequestæ–¹æ³• â†’ NettyClientInitializer â†’ Encoderç¼–ç  â†’ å‘é€request</li><li>æœåŠ¡ç«¯RpcServeræ¥æ”¶ â†’ NettyServerInitializer â†’ Decoderè§£ç  â†’ NettyRPCServerHandler â†’ getResponseè°ƒç”¨ â†’ è¿”å›response</li><li>å®¢æˆ·ç«¯æ¥æ”¶ â†’ NettyServerInitializer â†’ Decoderè§£ç  â†’ NettyRPCServerHandlerå¤„ç†ç»“æœå¹¶è¿”å›ç»™ä¸Šå±‚</li></ul><h1 id="ä»£ç å®ç°"><a href="#ä»£ç å®ç°" class="headerlink" title="ä»£ç å®ç°"></a>ä»£ç å®ç°</h1><blockquote><p>åœ¨æ­¤éƒ¨åˆ†æˆ‘ä»¬å°†ç†è®ºè½¬åŒ–ä¸ºä»£ç ï¼Œåˆ†åˆ«å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚</p></blockquote><p><strong>é¡¹ç›®ç›®å½•ç»“æ„</strong></p><p><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/image-20240707182803978.png" alt="é¡¹ç›®ç›®å½•ç»“æ„"></p><h2 id="å®šä¹‰RpcClientæ¥å£"><a href="#å®šä¹‰RpcClientæ¥å£" class="headerlink" title="å®šä¹‰RpcClientæ¥å£"></a>å®šä¹‰RpcClientæ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RpcClient</span> &#123;<br><br>    <span class="hljs-comment">//å®šä¹‰åº•å±‚é€šä¿¡çš„æ–¹æ³•</span><br>    RpcResponse <span class="hljs-title function_">sendRequest</span><span class="hljs-params">(RpcRequest request)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="é…ç½®nettyå¯¹æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶"><a href="#é…ç½®nettyå¯¹æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶" class="headerlink" title="é…ç½®nettyå¯¹æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶"></a>é…ç½®nettyå¯¹æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyClientInitializer</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">ChannelInitializer</span>&lt;SocketChannel&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">initChannel</span><span class="hljs-params">(SocketChannel ch)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">ChannelPipeline</span> <span class="hljs-variable">pipeline</span> <span class="hljs-operator">=</span> ch.pipeline();<br>        <span class="hljs-comment">//ä½¿ç”¨é•¿åº¦å­—æ®µè§£ç å™¨ æ¶ˆæ¯æ ¼å¼ ã€é•¿åº¦ã€‘ã€æ¶ˆæ¯ä½“ã€‘ï¼Œè§£å†³æ²¾åŒ…é—®é¢˜</span><br>        pipeline.addLast(<br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldBasedFrameDecoder</span>(Integer.MAX_VALUE,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>,<span class="hljs-number">0</span>,<span class="hljs-number">4</span>));<br>        <span class="hljs-comment">//è®¡ç®—å½“å‰å¾…å‘é€æ¶ˆæ¯çš„é•¿åº¦ï¼Œå†™å…¥åˆ°å‰4ä¸ªå­—èŠ‚ä¸­</span><br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">LengthFieldPrepender</span>(<span class="hljs-number">4</span>));<br>â€‹<br>        <span class="hljs-comment">//ä½¿ç”¨Javaåºåˆ—åŒ–æ–¹å¼ï¼Œnettyçš„è‡ªå¸¦çš„è§£ç ç¼–ç æ”¯æŒä¼ è¾“è¿™ç§ç»“æ„</span><br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectEncoder</span>());<br>        <span class="hljs-comment">//ä½¿ç”¨äº†Nettyä¸­çš„ObjectDecoderï¼Œå®ƒç”¨äºå°†å­—èŠ‚æµè§£ç ä¸º Java å¯¹è±¡ã€‚</span><br>        <span class="hljs-comment">//åœ¨ObjectDecoderçš„æ„é€ å‡½æ•°ä¸­ä¼ å…¥äº†ä¸€ä¸ªClassResolver å¯¹è±¡ï¼Œç”¨äºè§£æç±»åå¹¶åŠ è½½ç›¸åº”çš„ç±»ã€‚</span><br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectDecoder</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClassResolver</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Class&lt;?&gt; resolve(String className) <span class="hljs-keyword">throws</span> ClassNotFoundException &#123;<br>                <span class="hljs-keyword">return</span> Class.forName(className);<br>            &#125;<br>        &#125;));<br>        <br>        pipeline.addLast(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyClientHandler</span>());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h3 id="Nettyç²˜åŒ…é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆ"><a href="#Nettyç²˜åŒ…é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆ" class="headerlink" title="Nettyç²˜åŒ…é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆ"></a>Nettyç²˜åŒ…é—®é¢˜çš„å¸¸è§è§£å†³æ–¹æ¡ˆ</h3><blockquote><p>ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ä¹Ÿå«åšç²˜åŒ…å’ŒåŠåŒ…é—®é¢˜,å®ƒæ˜¯æŒ‡åœ¨æ•°æ®ä¼ è¾“æ—¶,æ¥æ”¶æ–¹æœªèƒ½æ­£å¸¸è¯»å–åˆ°ä¸€æ¡å®Œæ•´æ•°æ®çš„æƒ…å†µï¼ˆåªè¯»å–äº†éƒ¨åˆ†æ•°æ®,æˆ–å¤šè¯»å–åˆ°äº†å¦ä¸€æ¡æ•°æ®çš„æƒ…å†µï¼‰å°±å«åšç²˜åŒ…æˆ–æ‹†åŒ…é—®é¢˜ã€‚</p></blockquote><h4 id="ç²˜åŒ…é—®é¢˜"><a href="#ç²˜åŒ…é—®é¢˜" class="headerlink" title="ç²˜åŒ…é—®é¢˜"></a>ç²˜åŒ…é—®é¢˜</h4><p>ç²˜åŒ…é—®é¢˜æ˜¯æŒ‡åœ¨ç½‘ç»œé€šä¿¡ä¸­ï¼Œå‘é€æ–¹è¿ç»­å‘é€çš„å¤šä¸ªå°æ•°æ®åŒ…è¢«æ¥æ”¶æ–¹ä¸€æ¬¡æ€§æ¥æ”¶çš„ç°è±¡ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºåº•å±‚ä¼ è¾“å±‚åè®®ï¼ˆå¦‚ TCPï¼‰ä¼šå°†å¤šä¸ªå°æ•°æ®åŒ…åˆå¹¶æˆä¸€ä¸ªå¤§çš„æ•°æ®å—è¿›è¡Œä¼ è¾“ï¼Œå¯¼è‡´æ¥æ”¶æ–¹åœ¨æ¥æ”¶æ•°æ®æ—¶ä¸€æ¬¡æ€§æ¥æ”¶äº†å¤šä¸ªæ•°æ®åŒ…ï¼Œé€ æˆç²˜è¿ã€‚</p><p><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/image-20240707183605837.png" alt="ç²˜åŒ…é—®é¢˜å®ä¾‹"></p><h4 id="æ‹†åŒ…-åŠåŒ…é—®é¢˜"><a href="#æ‹†åŒ…-åŠåŒ…é—®é¢˜" class="headerlink" title="æ‹†åŒ…&#x2F;åŠåŒ…é—®é¢˜"></a>æ‹†åŒ…&#x2F;åŠåŒ…é—®é¢˜</h4><p>æ‹†åŒ…é—®é¢˜æ˜¯æŒ‡å‘é€æ–¹å‘é€çš„ä¸€ä¸ªå¤§æ•°æ®åŒ…è¢«æ¥æ”¶æ–¹æ‹†åˆ†æˆå¤šä¸ªå°æ•°æ®åŒ…è¿›è¡Œæ¥æ”¶çš„ç°è±¡ã€‚è¿™å¯èƒ½æ˜¯å› ä¸ºåº•å±‚ä¼ è¾“å±‚åè®®ï¼ˆå¦‚ TCPï¼‰å°†ä¸€ä¸ªå¤§æ•°æ®åŒ…æ‹†åˆ†æˆå¤šä¸ªå°çš„æ•°æ®å—è¿›è¡Œä¼ è¾“ï¼Œå¯¼è‡´æ¥æ”¶æ–¹åœ¨æ¥æ”¶æ•°æ®æ—¶åˆ†åˆ«æ¥æ”¶äº†å¤šä¸ªå°æ•°æ®åŒ…ï¼Œé€ æˆæ‹†å¼€ã€‚</p><p><img src="/2024/07/07/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%BC%95%E5%85%A5Netty/image-20240707183638595.png" alt="æ‹†åŒ…é—®é¢˜å®ä¾‹"></p><h4 id="xxxxxxxxxx-public-class-TestServer-public-static-void-main-String-args-UserService-userService-new-UserServiceImpl-â€‹-ServiceProvider-serviceProvider-new-ServiceProvider-serviceProvider-provideServiceInterface-userService-â€‹-RpcServer-rpcServer-new-SimpleRPCRPCServer-serviceProvider-rpcServer-start-9999-java"><a href="#xxxxxxxxxx-public-class-TestServer-public-static-void-main-String-args-UserService-userService-new-UserServiceImpl-â€‹-ServiceProvider-serviceProvider-new-ServiceProvider-serviceProvider-provideServiceInterface-userService-â€‹-RpcServer-rpcServer-new-SimpleRPCRPCServer-serviceProvider-rpcServer-start-9999-java" class="headerlink" title="xxxxxxxxxxÂ public class TestServer { Â  Â public static void main(String[] args) { Â  Â  Â  Â UserService userService&#x3D;new UserServiceImpl();â€‹ Â  Â  Â  Â ServiceProvider serviceProvider&#x3D;new ServiceProvider(); Â  Â  Â  Â serviceProvider.provideServiceInterface(userService);â€‹ Â  Â  Â  Â RpcServer rpcServer&#x3D;new SimpleRPCRPCServer(serviceProvider); Â  Â  Â  Â rpcServer.start(9999); Â   }}java"></a>xxxxxxxxxxÂ public class TestServer { Â  Â public static void main(String[] args) { Â  Â  Â  Â UserService userService&#x3D;new UserServiceImpl();â€‹ Â  Â  Â  Â ServiceProvider serviceProvider&#x3D;new ServiceProvider(); Â  Â  Â  Â serviceProvider.provideServiceInterface(userService);â€‹ Â  Â  Â  Â RpcServer rpcServer&#x3D;new SimpleRPCRPCServer(serviceProvider); Â  Â  Â  Â rpcServer.start(9999); Â   }}java</h4><p>ç²˜åŒ…é—®é¢˜é€šå¸¸å‘ç”Ÿåœ¨ TCP&#x2F;IP åè®®ä¸­ï¼Œ<strong>å› ä¸º TCP æ˜¯é¢å‘è¿æ¥çš„ä¼ è¾“åè®®ï¼Œå®ƒæ˜¯ä»¥â€œæµâ€çš„å½¢å¼ä¼ è¾“æ•°æ®çš„ï¼Œè€Œâ€œæµâ€æ•°æ®æ˜¯æ²¡æœ‰æ˜ç¡®çš„å¼€å§‹å’Œç»“å°¾è¾¹ç•Œçš„ï¼Œæ‰€ä»¥å°±ä¼šå‡ºç°ç²˜åŒ…é—®é¢˜</strong>ã€‚</p><h4 id="å¸¸è§è§£å†³æ–¹æ¡ˆ"><a href="#å¸¸è§è§£å†³æ–¹æ¡ˆ" class="headerlink" title="å¸¸è§è§£å†³æ–¹æ¡ˆ"></a>å¸¸è§è§£å†³æ–¹æ¡ˆ</h4><ul><li><strong>å›ºå®šå¤§å°æ–¹æ³•</strong>ï¼šå‘é€æ–¹å’Œæ¥æ”¶æ–¹å›ºå®šå‘é€æ•°æ®å¤§å°ï¼Œå½“å­—ç¬¦é•¿åº¦ä¸å¤Ÿæ—¶ç”¨ç©ºå­—ç¬¦å¼¥è¡¥ï¼Œæœ‰äº†å›ºå®šå¤§å°ä¹‹åå°±çŸ¥é“æ¯æ¡æ¶ˆæ¯çš„å…·ä½“è¾¹ç•Œäº†ï¼Œè¿™æ ·å°±æ²¡æœ‰ç²˜åŒ…çš„é—®é¢˜äº†ã€‚</li><li><strong>è‡ªå®šä¹‰æ•°æ®åè®®ï¼ˆå®šä¹‰æ•°æ®é•¿åº¦ï¼‰</strong>ï¼šåœ¨ TCP åè®®çš„åŸºç¡€ä¸Šå°è£…ä¸€å±‚è‡ªå®šä¹‰æ•°æ®åè®®ï¼Œåœ¨è‡ªå®šä¹‰æ•°æ®åè®®ä¸­ï¼ŒåŒ…å«æ•°æ®å¤´ï¼ˆå­˜å‚¨æ•°æ®çš„å¤§å°ï¼‰å’Œ æ•°æ®çš„å…·ä½“å†…å®¹ï¼Œè¿™æ ·æœåŠ¡ç«¯å¾—åˆ°æ•°æ®ä¹‹åï¼Œé€šè¿‡è§£ææ•°æ®å¤´å°±å¯ä»¥çŸ¥é“æ•°æ®çš„å…·ä½“é•¿åº¦äº†ï¼Œä¹Ÿå°±æ²¡æœ‰ç²˜åŒ…çš„é—®é¢˜äº†ã€‚</li><li><strong>ç‰¹æ®Šåˆ†å‰²ç¬¦</strong>ï¼šä»¥ç‰¹æ®Šçš„å­—ç¬¦ç»“å°¾ï¼Œæ¯”å¦‚ä»¥â€œ\nâ€ç»“å°¾ï¼Œè¿™æ ·æˆ‘ä»¬å°±çŸ¥é“æ•°æ®çš„å…·ä½“è¾¹ç•Œäº†ï¼Œä»è€Œé¿å…äº†ç²˜åŒ…é—®é¢˜ã€‚</li></ul><p>ä»¥ä¸Šä¸‰ç§æ–¹æ¡ˆä¸­ï¼Œç¬¬ä¸€ç§å›ºå®šå¤§å°çš„æ–¹æ³•å¯èƒ½ä¼šé€ æˆç½‘ç»œæµé‡çš„æµªè´¹ï¼Œä»¥åŠä¼ è¾“æ€§èƒ½æ…¢çš„é—®é¢˜ï¼›ç¬¬äºŒç§è§£å†³æ–¹æ¡ˆå®ç°éš¾åº¦å¤§ï¼Œä¸”ä¸åˆ©äºç»´æŠ¤ï¼Œæ‰€ä»¥æ¯”è¾ƒæ¨èçš„æ˜¯ç¬¬ä¸‰ç§æ–¹æ¡ˆï¼Œä½¿ç”¨ç‰¹æ®Šåˆ†éš”ç¬¦æ¥åŒºåˆ†æ¶ˆæ¯çš„è¾¹ç•Œï¼Œä»è€Œé¿å…ç²˜åŒ…é—®é¢˜ã€‚</p><h4 id="Nettyè§£å†³æ–¹æ¡ˆ"><a href="#Nettyè§£å†³æ–¹æ¡ˆ" class="headerlink" title="Nettyè§£å†³æ–¹æ¡ˆ"></a>Nettyè§£å†³æ–¹æ¡ˆ</h4><blockquote><p>PSï¼šåœ¨ Netty ä¸­ï¼Œè§£ç å™¨ï¼ˆDecoderï¼‰èµ·ç€éå¸¸é‡è¦çš„ä½œç”¨ã€‚è§£ç å™¨ä¸»è¦è´Ÿè´£å°†ä»ç½‘ç»œä¸­æ¥æ”¶åˆ°çš„åŸå§‹å­—èŠ‚æµæ•°æ®è½¬æ¢ä¸ºåº”ç”¨ç¨‹åºèƒ½å¤Ÿç†è§£çš„ Java å¯¹è±¡æˆ–æ¶ˆæ¯æ ¼å¼ã€‚ä½¿ç”¨è§£ç å™¨å¯ä»¥è§£å†³ç²˜åŒ…å’Œæ‹†åŒ…é—®é¢˜ã€åè®®è½¬æ¢é—®é¢˜ã€æ¶ˆæ¯ç¼–ç ï¼ˆå¦‚æ–‡æœ¬è½¬æ¢ä¸ºå­—èŠ‚æµï¼‰ç­‰é—®é¢˜ã€‚</p></blockquote><ul><li><strong>ä½¿ç”¨å®šé•¿è§£ç å™¨ï¼ˆFixedLengthFrameDecoderï¼‰</strong>ï¼šæ¯ä¸ªæ•°æ®åŒ…éƒ½æ‹¥æœ‰å›ºå®šçš„é•¿åº¦ï¼Œæ¥æ”¶ç«¯æ ¹æ®å›ºå®šé•¿åº¦å¯¹æ•°æ®è¿›è¡Œåˆ‡åˆ†ï¼Œä»è€Œè§£å†³äº†ç²˜åŒ…é—®é¢˜ã€‚</li><li><strong>ä½¿ç”¨è¡Œåˆ†éš”ç¬¦è§£ç å™¨ï¼ˆLineBasedFrameDecoderï¼‰</strong>ï¼šä»¥è¡Œä¸ºå•ä½è¿›è¡Œæ•°æ®åŒ…çš„è§£ç ï¼Œä»è€Œè§£å†³ç²˜åŒ…é—®é¢˜ã€‚</li><li><strong>ä½¿ç”¨åˆ†éš”ç¬¦è§£ç å™¨ï¼ˆDelimiterBasedFrameDecoderï¼‰</strong>ï¼šä½¿ç”¨ç‰¹å®šçš„åˆ†éš”ç¬¦æ¥æ ‡è¯†æ¶ˆæ¯è¾¹ç•Œï¼Œè¿™æ ·æ¥æ”¶ç«¯å¯ä»¥æ ¹æ®åˆ†éš”ç¬¦æ­£ç¡®åˆ‡åˆ†æ¶ˆæ¯ã€‚</li><li><strong>ä½¿ç”¨é•¿åº¦å­—æ®µè§£ç å™¨ï¼ˆLengthFieldBasedFrameDecoderï¼‰</strong>ï¼šåœ¨æ¶ˆæ¯å¤´éƒ¨åŠ å…¥è¡¨ç¤ºæ¶ˆæ¯é•¿åº¦çš„å­—æ®µï¼Œæ¥æ”¶ç«¯æ ¹æ®é•¿åº¦å­—æ®µæ¥ç¡®å®šæ¶ˆæ¯çš„è¾¹ç•Œï¼Œè€Œä»è§£å†³ç²˜åŒ…é—®é¢˜ã€‚</li></ul><h2 id="NettyClientHandlerç±»"><a href="#NettyClientHandlerç±»" class="headerlink" title="NettyClientHandlerç±»"></a>NettyClientHandlerç±»</h2><blockquote><p>æŒ‡å®šå¯¹æ¥æ”¶æ¶ˆæ¯çš„å¤„ç†æ–¹å¼</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyClientHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;RpcResponse&gt; &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, RpcResponse response)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// æ¥æ”¶åˆ°response, ç»™channelè®¾è®¡åˆ«åï¼Œè®©sendRequesté‡Œè¯»å–response</span><br>        AttributeKey&lt;RpcResponse&gt; key = AttributeKey.valueOf(<span class="hljs-string">&quot;RPCResponse&quot;</span>);<br>        <span class="hljs-comment">//ç›¸å½“äºå°†channelå’Œç‰¹å®šä¿¡æ¯è¿›è¡Œç»‘å®š</span><br>        ctx.channel().attr(key).set(response);<br>        ctx.channel().close();<br>    &#125;<br>    <br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//å¼‚å¸¸å¤„ç†</span><br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="æœåŠ¡ç«¯é‡æ„"><a href="#æœåŠ¡ç«¯é‡æ„" class="headerlink" title="æœåŠ¡ç«¯é‡æ„"></a>æœåŠ¡ç«¯é‡æ„</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyRPCRPCServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RpcServer</span> &#123;<br>    <span class="hljs-keyword">private</span> ServiceProvider serviceProvider;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> &#123;<br>        <span class="hljs-comment">// netty æœåŠ¡çº¿ç¨‹ç»„bossè´Ÿè´£å»ºç«‹è¿æ¥ï¼Œ workè´Ÿè´£å…·ä½“çš„è¯·æ±‚</span><br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">bossGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        <span class="hljs-type">NioEventLoopGroup</span> <span class="hljs-variable">workGroup</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">NioEventLoopGroup</span>();<br>        System.out.println(<span class="hljs-string">&quot;nettyæœåŠ¡ç«¯å¯åŠ¨äº†&quot;</span>);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">//å¯åŠ¨nettyæœåŠ¡å™¨</span><br>            <span class="hljs-type">ServerBootstrap</span> <span class="hljs-variable">serverBootstrap</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerBootstrap</span>();<br>            <span class="hljs-comment">//åˆå§‹åŒ–</span><br>            serverBootstrap.group(bossGroup,workGroup).channel(NioServerSocketChannel.class)<br>                    <span class="hljs-comment">//NettyClientInitializerè¿™é‡Œ é…ç½®nettyå¯¹æ¶ˆæ¯çš„å¤„ç†æœºåˆ¶</span><br>                    .childHandler(<span class="hljs-keyword">new</span> <span class="hljs-title class_">NettyServerInitializer</span>(serviceProvider));<br>            <span class="hljs-comment">//åŒæ­¥å µå¡</span><br>            ChannelFuture channelFuture=serverBootstrap.bind(port).sync();<br>            <span class="hljs-comment">//æ­»å¾ªç¯ç›‘å¬</span><br>            channelFuture.channel().closeFuture().sync();<br>        &#125;<span class="hljs-keyword">catch</span> (InterruptedException e)&#123;<br>            e.printStackTrace();<br>        &#125;<span class="hljs-keyword">finally</span> &#123;<br>            bossGroup.shutdownGracefully();<br>            workGroup.shutdownGracefully();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="NettyRPCServerHandlerç±»"><a href="#NettyRPCServerHandlerç±»" class="headerlink" title="NettyRPCServerHandlerç±»"></a>NettyRPCServerHandlerç±»</h2><blockquote><p>NettyServerInitializerç±» å’ŒNettyClientInitializerç±»ä¼¼ï¼Œæ¥æ”¶æ¥è‡ªå®¢æˆ·ç«¯çš„ä¿¡æ¯ï¼Œå¹¶è§£æè°ƒç”¨</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">NettyRPCServerHandler</span> <span class="hljs-keyword">extends</span> <span class="hljs-title class_">SimpleChannelInboundHandler</span>&lt;RpcRequest&gt; &#123;<br>    <span class="hljs-keyword">private</span> ServiceProvider serviceProvider;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">channelRead0</span><span class="hljs-params">(ChannelHandlerContext ctx, RpcRequest request)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">//æ¥æ”¶requestï¼Œè¯»å–å¹¶è°ƒç”¨æœåŠ¡</span><br>        <span class="hljs-type">RpcResponse</span> <span class="hljs-variable">response</span> <span class="hljs-operator">=</span> getResponse(request);<br>        ctx.writeAndFlush(response);<br>        ctx.close();<br>    &#125;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">exceptionCaught</span><span class="hljs-params">(ChannelHandlerContext ctx, Throwable cause)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        cause.printStackTrace();<br>        ctx.close();<br>    &#125;<br>    <span class="hljs-keyword">private</span> RpcResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">(RpcRequest rpcRequest)</span>&#123;<br>        <span class="hljs-comment">//å¾—åˆ°æœåŠ¡å</span><br>        String interfaceName=rpcRequest.getInterfaceName();<br>        <span class="hljs-comment">//å¾—åˆ°æœåŠ¡ç«¯ç›¸åº”æœåŠ¡å®ç°ç±»</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> serviceProvider.getService(interfaceName);<br>        <span class="hljs-comment">//åå°„è°ƒç”¨æ–¹æ³•</span><br>        Method method=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            method= service.getClass().getMethod(rpcRequest.getMethodName(), rpcRequest.getParamsType());<br>            Object invoke=method.invoke(service,rpcRequest.getParams());<br>            <span class="hljs-keyword">return</span> RpcResponse.sussess(invoke);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;æ–¹æ³•æ‰§è¡Œé”™è¯¯&quot;</span>);<br>            <span class="hljs-keyword">return</span> RpcResponse.fail();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>æ‰‹æ’•RPCæ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RPC</tag>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>Netty</tag>
      
      <tag>Socket</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹æ’•RPCæ¡†æ¶â€”â€”å®ç°ç®€å•çš„RPCè°ƒç”¨</title>
    <link href="/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84RPC%E8%B0%83%E7%94%A8/"/>
    <url>/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84RPC%E8%B0%83%E7%94%A8/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€åœºæ™¯è®¾è®¡"><a href="#ä¸€ã€åœºæ™¯è®¾è®¡" class="headerlink" title="ä¸€ã€åœºæ™¯è®¾è®¡"></a>ä¸€ã€åœºæ™¯è®¾è®¡</h1><blockquote><p>ç°åœ¨A,Bä½äºä¸åŒçš„æœåŠ¡å™¨ä¸Šï¼Œä½†ç°åœ¨Aæƒ³è°ƒç”¨Bçš„æŸä¸ªæ–¹æ³•ï¼Œå¦‚ä½•å®ç°å‘¢ï¼Ÿ</p></blockquote><p><strong>æœåŠ¡ç«¯B</strong>ï¼š<br>æœ‰ä¸€ä¸ªç”¨æˆ·è¡¨</p><ol><li>UserService é‡Œæœ‰ä¸€ä¸ªåŠŸèƒ½ï¼šgetUserByUserId(Integer id)</li><li>UserServiceImpl å®ç°äº†UserServiceæ¥å£å’Œæ–¹æ³•</li></ol><p><strong>å®¢æˆ·ç«¯A</strong>ï¼š<br>è°ƒç”¨getUserByUserIdæ–¹æ³•ï¼Œ å†…éƒ¨ä¼ ä¸€ä¸ªIdç»™æœåŠ¡ç«¯ï¼ŒæœåŠ¡ç«¯æŸ¥è¯¢åˆ°Userå¯¹è±¡è¿”å›ç»™å®¢æˆ·ç«¯</p><p>å¦‚ä½•å®ç°ä»¥ä¸Šè°ƒç”¨è¿‡ç¨‹å‘¢ï¼Ÿ</p><h1 id="äºŒã€è®¾è®¡æ€è·¯"><a href="#äºŒã€è®¾è®¡æ€è·¯" class="headerlink" title="äºŒã€è®¾è®¡æ€è·¯"></a>äºŒã€è®¾è®¡æ€è·¯</h1><blockquote><p>ä¸»è¦è€ƒè™‘å®¢æˆ·ç«¯ã€æœåŠ¡ç«¯ã€ä»¥åŠåŒæ–¹å¦‚ä½•é€šä¿¡æ‰èƒ½å®ç°æ­¤åŠŸèƒ½</p></blockquote><h2 id="2-1-å®¢æˆ·ç«¯çš„è®¾è®¡"><a href="#2-1-å®¢æˆ·ç«¯çš„è®¾è®¡" class="headerlink" title="2.1 å®¢æˆ·ç«¯çš„è®¾è®¡"></a>2.1 å®¢æˆ·ç«¯çš„è®¾è®¡</h2><ol><li>è°ƒç”¨getUserByUserIdæ–¹æ³•æ—¶ï¼Œå†…éƒ¨å°†è°ƒç”¨ä¿¡æ¯å¤„ç†åå‘é€ç»™æœåŠ¡ç«¯Bï¼Œå‘Šè¯‰Bæˆ‘è¦è·å–User</li><li>å¤–éƒ¨è°ƒç”¨æ–¹æ³•ï¼Œå†…éƒ¨è¿›è¡Œå…¶å®ƒçš„å¤„ç†â€”â€”è¿™ç§åœºæ™¯æˆ‘ä»¬å¯ä»¥ä½¿ç”¨åŠ¨æ€ä»£ç†çš„æ–¹å¼ï¼Œæ”¹å†™åŸæœ¬æ–¹æ³•çš„å¤„ç†é€»è¾‘</li></ol><h2 id="2-2-æœåŠ¡ç«¯çš„è®¾è®¡"><a href="#2-2-æœåŠ¡ç«¯çš„è®¾è®¡" class="headerlink" title="2.2 æœåŠ¡ç«¯çš„è®¾è®¡"></a>2.2 æœåŠ¡ç«¯çš„è®¾è®¡</h2><ol><li>ç›‘å¬åˆ°Açš„è¯·æ±‚åï¼Œæ¥æ”¶Açš„è°ƒç”¨ä¿¡æ¯ï¼Œå¹¶æ ¹æ®ä¿¡æ¯å¾—åˆ°Aæƒ³è°ƒç”¨çš„æœåŠ¡ä¸æ–¹æ³•</li><li>æ ¹æ®ä¿¡æ¯æ‰¾åˆ°å¯¹åº”çš„æœåŠ¡ï¼Œè¿›è¡Œè°ƒç”¨åå°†ç»“æœå‘é€å›ç»™A</li></ol><h2 id="2-3-é€šä¿¡è®¾è®¡"><a href="#2-3-é€šä¿¡è®¾è®¡" class="headerlink" title="2.3 é€šä¿¡è®¾è®¡"></a>2.3 é€šä¿¡è®¾è®¡</h2><ol><li>ä½¿ç”¨Javaçš„socketç½‘ç»œç¼–ç¨‹è¿›è¡Œé€šä¿¡</li><li>ä¸ºäº†æ–¹ä¾¿A ï¼ŒBä¹‹é—´ å¯¹æ¥æ”¶çš„æ¶ˆæ¯è¿›è¡Œå¤„ç†ï¼Œæˆ‘ä»¬éœ€è¦å°†è¯·æ±‚ä¿¡æ¯å’Œè¿”å›ä¿¡æ¯å°è£…æˆç»Ÿä¸€çš„æ¶ˆæ¯æ ¼å¼</li></ol><h1 id="ä¸‰ã€ä»£ç å®ç°"><a href="#ä¸‰ã€ä»£ç å®ç°" class="headerlink" title="ä¸‰ã€ä»£ç å®ç°"></a>ä¸‰ã€ä»£ç å®ç°</h1><blockquote><p>åœ¨æ­¤éƒ¨åˆ†æˆ‘ä»¬å°†ç†è®ºè½¬åŒ–ä¸ºä»£ç ï¼Œåˆ†åˆ«å®ç°å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯ã€‚</p></blockquote><p><strong>é¡¹ç›®ç›®å½•ç»“æ„</strong></p><p><img src="/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%AE%9E%E7%8E%B0%E7%AE%80%E5%8D%95%E7%9A%84RPC%E8%B0%83%E7%94%A8/489c162449c4444faf080dcab759fb8b.png" alt="é¡¹ç›®ç»“æ„"></p><h2 id="3-1-å®šä¹‰ç”¨æˆ·ä¿¡æ¯"><a href="#3-1-å®šä¹‰ç”¨æˆ·ä¿¡æ¯" class="headerlink" title="3.1 å®šä¹‰ç”¨æˆ·ä¿¡æ¯"></a>3.1 å®šä¹‰ç”¨æˆ·ä¿¡æ¯</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Builder</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@NoArgsConstructor</span><br><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">User</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">// å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯å…±æœ‰çš„</span><br>    <span class="hljs-keyword">private</span> Integer id;<br>    <span class="hljs-keyword">private</span> String userName;<br>    <span class="hljs-keyword">private</span> Boolean sex;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-2-ç”¨æˆ·æœåŠ¡æ¥å£"><a href="#3-2-ç”¨æˆ·æœåŠ¡æ¥å£" class="headerlink" title="3.2 ç”¨æˆ·æœåŠ¡æ¥å£"></a>3.2 ç”¨æˆ·æœåŠ¡æ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-comment">// å®¢æˆ·ç«¯é€šè¿‡è¿™ä¸ªæ¥å£è°ƒç”¨æœåŠ¡ç«¯çš„å®ç°ç±»</span><br>    User <span class="hljs-title function_">getUserByUserId</span><span class="hljs-params">(Integer id)</span>;<br>    <span class="hljs-comment">//æ–°å¢ä¸€ä¸ªåŠŸèƒ½</span><br>    Integer <span class="hljs-title function_">insertUserId</span><span class="hljs-params">(User user)</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-3-ç”¨æˆ·æœåŠ¡æ¥å£å®ç°"><a href="#3-3-ç”¨æˆ·æœåŠ¡æ¥å£å®ç°" class="headerlink" title="3.3 ç”¨æˆ·æœåŠ¡æ¥å£å®ç°"></a>3.3 ç”¨æˆ·æœåŠ¡æ¥å£å®ç°</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserServiceImpl</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">UserService</span> &#123;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUserByUserId</span><span class="hljs-params">(Integer id)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;å®¢æˆ·ç«¯æŸ¥è¯¢äº†&quot;</span>+id+<span class="hljs-string">&quot;çš„ç”¨æˆ·&quot;</span>);<br>        <span class="hljs-comment">// æ¨¡æ‹Ÿä»æ•°æ®åº“ä¸­å–ç”¨æˆ·çš„è¡Œä¸º</span><br>        <span class="hljs-type">Random</span> <span class="hljs-variable">random</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> User.builder().userName(UUID.randomUUID().toString())<br>                .id(id)<br>                .sex(random.nextBoolean()).build();<br>        <span class="hljs-keyword">return</span> user;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Integer <span class="hljs-title function_">insertUserId</span><span class="hljs-params">(User user)</span> &#123;<br>        System.out.println(<span class="hljs-string">&quot;æ’å…¥æ•°æ®æˆåŠŸ&quot;</span>+user.getUserName());<br>        <span class="hljs-keyword">return</span> user.getId();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-4-å®šä¹‰æ¶ˆæ¯æ ¼å¼"><a href="#3-4-å®šä¹‰æ¶ˆæ¯æ ¼å¼" class="headerlink" title="3.4 å®šä¹‰æ¶ˆæ¯æ ¼å¼"></a>3.4 å®šä¹‰æ¶ˆæ¯æ ¼å¼</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//å®šä¹‰è¯·æ±‚ä¿¡æ¯æ ¼å¼RpcRequest</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcRequest</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//æœåŠ¡ç±»åï¼Œå®¢æˆ·ç«¯åªçŸ¥é“æ¥å£</span><br>    <span class="hljs-keyword">private</span> String interfaceName;<br>    <span class="hljs-comment">//è°ƒç”¨çš„æ–¹æ³•å</span><br>    <span class="hljs-keyword">private</span> String methodName;<br>    <span class="hljs-comment">//å‚æ•°åˆ—è¡¨</span><br>    <span class="hljs-keyword">private</span> Object[] params;<br>    <span class="hljs-comment">//å‚æ•°ç±»å‹</span><br>    <span class="hljs-keyword">private</span> Class&lt;?&gt;[] paramsType;<br>&#125;<br><br><span class="hljs-comment">//å®šä¹‰è¿”å›ä¿¡æ¯æ ¼å¼RpcResponseï¼ˆç±»ä¼¼httpæ ¼å¼ï¼‰</span><br><span class="hljs-meta">@Data</span><br><span class="hljs-meta">@Builder</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RpcResponse</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Serializable</span> &#123;<br>    <span class="hljs-comment">//çŠ¶æ€ç </span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> code;<br>    <span class="hljs-comment">//çŠ¶æ€ä¿¡æ¯</span><br>    <span class="hljs-keyword">private</span> String message;<br>    <span class="hljs-comment">//å…·ä½“æ•°æ®</span><br>    <span class="hljs-keyword">private</span> Object data;<br>    <span class="hljs-comment">//æ„é€ æˆåŠŸä¿¡æ¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RpcResponse <span class="hljs-title function_">sussess</span><span class="hljs-params">(Object data)</span>&#123;<br>        <span class="hljs-keyword">return</span> RpcResponse.builder().code(<span class="hljs-number">200</span>).data(data).build();<br>    &#125;<br>    <span class="hljs-comment">//æ„é€ å¤±è´¥ä¿¡æ¯</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RpcResponse <span class="hljs-title function_">fail</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> RpcResponse.builder().code(<span class="hljs-number">500</span>).message(<span class="hljs-string">&quot;æœåŠ¡å™¨å‘ç”Ÿé”™è¯¯&quot;</span>).build();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-5-å®ç°åŠ¨æ€ä»£ç†ç±»"><a href="#3-5-å®ç°åŠ¨æ€ä»£ç†ç±»" class="headerlink" title="3.5 å®ç°åŠ¨æ€ä»£ç†ç±»"></a>3.5 å®ç°åŠ¨æ€ä»£ç†ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ClientProxy</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">InvocationHandler</span> &#123;<br>    <span class="hljs-comment">//ä¼ å…¥å‚æ•°serviceæ¥å£çš„classå¯¹è±¡ï¼Œåå°„å°è£…æˆä¸€ä¸ªrequest</span><br>    <span class="hljs-keyword">private</span> String host;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> port;<br><br>    <span class="hljs-comment">//jdkåŠ¨æ€ä»£ç†ï¼Œæ¯ä¸€æ¬¡ä»£ç†å¯¹è±¡è°ƒç”¨æ–¹æ³•ï¼Œéƒ½ä¼šç»è¿‡æ­¤æ–¹æ³•å¢å¼ºï¼ˆåå°„è·å–requestå¯¹è±¡ï¼Œsocketå‘é€åˆ°æœåŠ¡ç«¯ï¼‰</span><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">invoke</span><span class="hljs-params">(Object proxy, Method method, Object[] args)</span> <span class="hljs-keyword">throws</span> Throwable &#123;<br>        <span class="hljs-comment">//æ„å»ºrequest</span><br>        RpcRequest request=RpcRequest.builder()<br>                .interfaceName(method.getDeclaringClass().getName())<br>                .methodName(method.getName())<br>                .params(args).paramsType(method.getParameterTypes()).build();<br>        <span class="hljs-comment">//IOClient.sendRequest å’ŒæœåŠ¡ç«¯è¿›è¡Œæ•°æ®ä¼ è¾“</span><br>        RpcResponse response= IOClient.sendRequest(host,port,request);<br>        <span class="hljs-keyword">return</span> response.getData();<br>    &#125;<br>     <span class="hljs-keyword">public</span> &lt;T&gt;T <span class="hljs-title function_">getProxy</span><span class="hljs-params">(Class&lt;T&gt; clazz)</span>&#123;<br>        <span class="hljs-type">Object</span> <span class="hljs-variable">o</span> <span class="hljs-operator">=</span> Proxy.newProxyInstance(clazz.getClassLoader(), <span class="hljs-keyword">new</span> <span class="hljs-title class_">Class</span>[]&#123;clazz&#125;, <span class="hljs-built_in">this</span>);<br>        <span class="hljs-keyword">return</span> (T)o;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-6-å°è£…ä¿¡æ¯ä¼ è¾“ç±»"><a href="#3-6-å°è£…ä¿¡æ¯ä¼ è¾“ç±»" class="headerlink" title="3.6 å°è£…ä¿¡æ¯ä¼ è¾“ç±»"></a>3.6 å°è£…ä¿¡æ¯ä¼ è¾“ç±»</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">IOClient</span> &#123;<br>    <span class="hljs-comment">//è¿™é‡Œè´Ÿè´£åº•å±‚ä¸æœåŠ¡ç«¯çš„é€šä¿¡ï¼Œå‘é€requestï¼Œè¿”å›response</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> RpcResponse <span class="hljs-title function_">sendRequest</span><span class="hljs-params">(String host, <span class="hljs-type">int</span> port, RpcRequest request)</span>&#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            Socket socket=<span class="hljs-keyword">new</span> <span class="hljs-title class_">Socket</span>(host, port);<br>            ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(socket.getOutputStream());<br>            ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(socket.getInputStream());<br><br>            oos.writeObject(request);<br>            oos.flush();<br><br>            RpcResponse response=(RpcResponse) ois.readObject();<br>            <span class="hljs-keyword">return</span> response;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>            <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-7-å®šä¹‰æœåŠ¡ç«¯Serveræ¥å£"><a href="#3-7-å®šä¹‰æœåŠ¡ç«¯Serveræ¥å£" class="headerlink" title="3.7 å®šä¹‰æœåŠ¡ç«¯Serveræ¥å£"></a>3.7 å®šä¹‰æœåŠ¡ç«¯Serveræ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">RpcServer</span> &#123;<br>    <span class="hljs-comment">//å¼€å¯ç›‘å¬</span><br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span>;<br>    <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span>;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-8-å®ç°RpcServeræ¥å£"><a href="#3-8-å®ç°RpcServeræ¥å£" class="headerlink" title="3.8 å®ç°RpcServeræ¥å£"></a>3.8 å®ç°RpcServeræ¥å£</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">SimpleRPCRPCServer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">RpcServer</span> &#123;<br>    <span class="hljs-keyword">private</span> ServiceProvider serviceProvide;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">start</span><span class="hljs-params">(<span class="hljs-type">int</span> port)</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ServerSocket serverSocket=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServerSocket</span>(port);<br>            System.out.println(<span class="hljs-string">&quot;æœåŠ¡å™¨å¯åŠ¨äº†&quot;</span>);<br>            <span class="hljs-keyword">while</span> (<span class="hljs-literal">true</span>) &#123;<br>                <span class="hljs-comment">//å¦‚æœæ²¡æœ‰è¿æ¥ï¼Œä¼šå µå¡åœ¨è¿™é‡Œ</span><br>                <span class="hljs-type">Socket</span> <span class="hljs-variable">socket</span> <span class="hljs-operator">=</span> serverSocket.accept();<br>                <span class="hljs-comment">//æœ‰è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªæ–°çš„çº¿ç¨‹æ‰§è¡Œå¤„ç†</span><br>                <span class="hljs-keyword">new</span> <span class="hljs-title class_">Thread</span>(<span class="hljs-keyword">new</span> <span class="hljs-title class_">WorkThread</span>(socket,serviceProvide)).start();<br>            &#125;<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">stop</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-9-å®ç°WorkThreadç±»"><a href="#3-9-å®ç°WorkThreadç±»" class="headerlink" title="3.9 å®ç°WorkThreadç±»"></a>3.9 å®ç°WorkThreadç±»</h2><blockquote><p>WorkThreadç±»è´Ÿè´£å¯åŠ¨çº¿ç¨‹å’Œå®¢æˆ·ç«¯è¿›è¡Œæ•°æ®ä¼ è¾“ï¼ŒWorkThreadç±»ä¸­çš„getResponseæ–¹æ³•è´Ÿè´£è§£ææ”¶åˆ°çš„requestä¿¡æ¯ï¼Œå¯»æ‰¾æœåŠ¡è¿›è¡Œè°ƒç”¨å¹¶è¿”å›ç»“æœã€‚</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@AllArgsConstructor</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WorkThread</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">Runnable</span>&#123;<br>    <span class="hljs-keyword">private</span> Socket socket;<br>    <span class="hljs-keyword">private</span> ServiceProvider serviceProvide;<br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">run</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">try</span> &#123;<br>            ObjectOutputStream oos=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectOutputStream</span>(socket.getOutputStream());<br>            ObjectInputStream ois=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ObjectInputStream</span>(socket.getInputStream());<br>            <span class="hljs-comment">//è¯»å–å®¢æˆ·ç«¯ä¼ è¿‡æ¥çš„request</span><br>            <span class="hljs-type">RpcRequest</span> <span class="hljs-variable">rpcRequest</span> <span class="hljs-operator">=</span> (RpcRequest) ois.readObject();<br>            <span class="hljs-comment">//åå°„è°ƒç”¨æœåŠ¡æ–¹æ³•è·å–è¿”å›å€¼</span><br>            RpcResponse rpcResponse=getResponse(rpcRequest);<br>            <span class="hljs-comment">//å‘å®¢æˆ·ç«¯å†™å…¥response</span><br>            oos.writeObject(rpcResponse);<br>            oos.flush();<br>        &#125; <span class="hljs-keyword">catch</span> (IOException | ClassNotFoundException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">private</span> RpcResponse <span class="hljs-title function_">getResponse</span><span class="hljs-params">(RpcRequest rpcRequest)</span>&#123;<br>        <span class="hljs-comment">//å¾—åˆ°æœåŠ¡å</span><br>        String interfaceName=rpcRequest.getInterfaceName();<br>        <span class="hljs-comment">//å¾—åˆ°æœåŠ¡ç«¯ç›¸åº”æœåŠ¡å®ç°ç±»</span><br>        <span class="hljs-type">Object</span> <span class="hljs-variable">service</span> <span class="hljs-operator">=</span> serviceProvide.getService(interfaceName);<br>        <span class="hljs-comment">//åå°„è°ƒç”¨æ–¹æ³•</span><br>        Method method=<span class="hljs-literal">null</span>;<br>        <span class="hljs-keyword">try</span> &#123;<br>            method= service.getClass().getMethod(rpcRequest.getMethodName(), rpcRequest.getParamsType());<br>            Object invoke=method.invoke(service,rpcRequest.getParams());<br>            <span class="hljs-keyword">return</span> RpcResponse.sussess(invoke);<br>        &#125; <span class="hljs-keyword">catch</span> (NoSuchMethodException | IllegalAccessException | InvocationTargetException e) &#123;<br>            e.printStackTrace();<br>            System.out.println(<span class="hljs-string">&quot;æ–¹æ³•æ‰§è¡Œé”™è¯¯&quot;</span>);<br>            <span class="hljs-keyword">return</span> RpcResponse.fail();<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-10-å®ç°æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨"><a href="#3-10-å®ç°æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨" class="headerlink" title="3.10 å®ç°æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨"></a>3.10 å®ç°æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨</h2><blockquote><p>å› ä¸ºä¸€ä¸ªæœåŠ¡å™¨ä¼šæœ‰å¤šä¸ªæœåŠ¡ï¼Œæ‰€ä»¥éœ€è¦è®¾ç½®ä¸€ä¸ªæœ¬åœ°æœåŠ¡å­˜æ”¾å™¨serviceProviderå­˜æ”¾æœåŠ¡ï¼Œåœ¨æ¥æ”¶åˆ°æœåŠ¡ç«¯çš„requestä¿¡æ¯ä¹‹åï¼Œæˆ‘ä»¬åœ¨æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨æ‰¾åˆ°éœ€è¦çš„æœåŠ¡ï¼Œé€šè¿‡åå°„è°ƒç”¨æ–¹æ³•ï¼Œå¾—åˆ°ç»“æœå¹¶è¿”å›</p></blockquote><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">//æœ¬åœ°æœåŠ¡å­˜æ”¾å™¨</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceProvider</span> &#123;<br>    <span class="hljs-comment">//é›†åˆä¸­å­˜æ”¾æœåŠ¡çš„å®ä¾‹</span><br>    <span class="hljs-keyword">private</span> Map&lt;String,Object&gt; interfaceProvider;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-title function_">ServiceProvider</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-built_in">this</span>.interfaceProvider=<span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>    &#125;<br>    <span class="hljs-comment">//æœ¬åœ°æ³¨å†ŒæœåŠ¡</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">provideServiceInterface</span><span class="hljs-params">(Object service)</span>&#123;<br>        String serviceName=service.getClass().getName();<br>        Class&lt;?&gt;[] interfaceName=service.getClass().getInterfaces();<br><br>        <span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz:interfaceName)&#123;<br>            interfaceProvider.put(clazz.getName(),service);<br>        &#125;<br><br>    &#125;<br>    <span class="hljs-comment">//è·å–æœåŠ¡å®ä¾‹</span><br>    <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">getService</span><span class="hljs-params">(String interfaceName)</span>&#123;<br>        <span class="hljs-keyword">return</span> interfaceProvider.get(interfaceName);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-11-å®¢æˆ·ç«¯ä¸»ç¨‹åº"><a href="#3-11-å®¢æˆ·ç«¯ä¸»ç¨‹åº" class="headerlink" title="3.11 å®¢æˆ·ç«¯ä¸»ç¨‹åº"></a>3.11 å®¢æˆ·ç«¯ä¸»ç¨‹åº</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestClient</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        ClientProxy clientProxy=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ClientProxy</span>(<span class="hljs-string">&quot;127.0.0.1&quot;</span>,<span class="hljs-number">9999</span>);<br>        UserService proxy=clientProxy.getProxy(UserService.class);<br><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> proxy.getUserByUserId(<span class="hljs-number">1</span>);<br>        System.out.println(<span class="hljs-string">&quot;ä»æœåŠ¡ç«¯å¾—åˆ°çš„user=&quot;</span>+user.toString());<br><br>        User u=User.builder().id(<span class="hljs-number">100</span>).userName(<span class="hljs-string">&quot;wxx&quot;</span>).sex(<span class="hljs-literal">true</span>).build();<br>        <span class="hljs-type">Integer</span> <span class="hljs-variable">id</span> <span class="hljs-operator">=</span> proxy.insertUserId(u);<br>        System.out.println(<span class="hljs-string">&quot;å‘æœåŠ¡ç«¯æ’å…¥userçš„id&quot;</span>+id);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure><h2 id="3-12-æœåŠ¡ç«¯ä¸»ç¨‹åº"><a href="#3-12-æœåŠ¡ç«¯ä¸»ç¨‹åº" class="headerlink" title="3.12 æœåŠ¡ç«¯ä¸»ç¨‹åº"></a>3.12 æœåŠ¡ç«¯ä¸»ç¨‹åº</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">TestServer</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">main</span><span class="hljs-params">(String[] args)</span> &#123;<br>        UserService userService=<span class="hljs-keyword">new</span> <span class="hljs-title class_">UserServiceImpl</span>();<br><br>        ServiceProvider serviceProvider=<span class="hljs-keyword">new</span> <span class="hljs-title class_">ServiceProvider</span>();<br>        serviceProvider.provideServiceInterface(userService);<br><br>        RpcServer rpcServer=<span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleRPCRPCServer</span>(serviceProvider);<br>        rpcServer.start(<span class="hljs-number">9999</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>æ‰‹æ’•RPCæ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RPC</tag>
      
      <tag>é¡¹ç›®</tag>
      
      <tag>Socket</tag>
      
      <tag>Java</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>æ‰‹æ’•RPCæ¡†æ¶â€”â€”å‰è¨€</title>
    <link href="/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%89%8D%E8%A8%80/"/>
    <url>/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%89%8D%E8%A8%80/</url>
    
    <content type="html"><![CDATA[<h1 id="ä¸€ã€RPCæ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#ä¸€ã€RPCæ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="ä¸€ã€RPCæ˜¯ä»€ä¹ˆï¼Ÿ"></a>ä¸€ã€RPCæ˜¯ä»€ä¹ˆï¼Ÿ</h1><blockquote><p>RPCï¼ˆRemote Procedure Callï¼Œ<strong>è¿œç¨‹è¿‡ç¨‹è°ƒç”¨</strong>ï¼‰æ˜¯ä¸€ç§ç”¨äºåœ¨ä¸åŒçš„è®¡ç®—æœºä¹‹é—´è¿›è¡Œé€šä¿¡çš„æŠ€æœ¯ï¼Œå…è®¸ä¸€ä¸ªç¨‹åºè°ƒç”¨å¦ä¸€ä¸ªç¨‹åºä¸­çš„å‡½æ•°æˆ–æ–¹æ³•ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°å‡½æ•°ä¸€æ ·ï¼Œè€Œæ— éœ€ç¨‹åºå‘˜æ˜¾å¼åœ°ç¼–å†™é€šä¿¡ä»£ç ã€‚</p></blockquote><h1 id="äºŒã€ä¸ºä»€ä¹ˆä¼šå‡ºç°RPC"><a href="#äºŒã€ä¸ºä»€ä¹ˆä¼šå‡ºç°RPC" class="headerlink" title="äºŒã€ä¸ºä»€ä¹ˆä¼šå‡ºç°RPC"></a>äºŒã€ä¸ºä»€ä¹ˆä¼šå‡ºç°RPC</h1><blockquote><p>åœ¨ä¼ä¸šå¼€å‘ä¸­ï¼Œéšç€ä¸šåŠ¡å¤æ‚åº¦çš„æé«˜ï¼Œå•ä½“åº”ç”¨æœåŠ¡ä¸å†èƒ½æ»¡è¶³éœ€æ±‚ï¼Œäºæ˜¯éƒ½ä¼šé‡‡ç”¨åˆ†å¸ƒå¼æ¡†æ¶ï¼Œéšä¹‹è€Œæ¥çš„é—®é¢˜å°±æ˜¯å•ä½“åº”ç”¨æœåŠ¡è¢«æ‹†åˆ†æˆå¤šä¸ªç‹¬ç«‹éƒ¨ç½²çš„æœåŠ¡ï¼Œä»–ä»¬ä¹‹é—´å¦‚ä½•é€šä¿¡å‘¢ï¼Ÿè¿™é‡Œå°±è¦ç”¨åˆ°RPCäº†ï¼Œé€šè¿‡ä½¿ç”¨RPCï¼Œå®¢æˆ·ç«¯å¯ä»¥è¿œç¨‹è°ƒç”¨ä½äºå…¶ä»–æœåŠ¡å™¨ä¸Šçš„æ–¹æ³•å‡½æ•°ï¼Œå°±åƒè°ƒç”¨æœ¬åœ°æ–¹æ³•ä¸€æ ·ã€‚<br>&#x3D;&#x3D;RPCæ¡†æ¶è§£å†³åœ¨åˆ†å¸ƒå¼æ¶æ„ä¸­ï¼Œå„ä¸ªæœåŠ¡ä¹‹é—´çš„ç½‘ç»œé€šä¿¡é—®é¢˜çš„æ¡†æ¶ã€‚&#x3D;&#x3D;</p></blockquote><h1 id="ä¸‰ã€RPCçš„åŸç†"><a href="#ä¸‰ã€RPCçš„åŸç†" class="headerlink" title="ä¸‰ã€RPCçš„åŸç†"></a>ä¸‰ã€RPCçš„åŸç†</h1><blockquote><p>æˆ‘ä»¬é¦–å…ˆä»RPCçš„è°ƒç”¨æµç¨‹å…¥æ‰‹ï¼Œç„¶åå¯¹å„ä¸ªæµç¨‹æ¶‰åŠåˆ°çš„ä¸€äº›é‡è¦æŠ€æœ¯å†åšæ·±å…¥æ¢è®¨ï¼Œæœ‰äº›æ²¡è®²åˆ°çš„æŠ€æœ¯ä¼šåœ¨åç»­æ–‡ç« ä¸­ç»“åˆé¡¹ç›®è¿›è¡Œè®²è§£ã€‚</p></blockquote><p><img src="/2024/07/06/%E6%89%8B%E6%92%95RPC%E6%A1%86%E6%9E%B6%E2%80%94%E2%80%94%E5%89%8D%E8%A8%80/654f3aee931449edaa74f62efc392493.png" alt="RPCåè®®è°ƒç”¨æµç¨‹"></p><h2 id="3-1-RPCæ˜¯å¦‚ä½•åšåˆ°é€æ˜åŒ–è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Ÿ"><a href="#3-1-RPCæ˜¯å¦‚ä½•åšåˆ°é€æ˜åŒ–è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Ÿ" class="headerlink" title="3.1 RPCæ˜¯å¦‚ä½•åšåˆ°é€æ˜åŒ–è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Ÿ"></a>3.1 RPCæ˜¯å¦‚ä½•åšåˆ°é€æ˜åŒ–è¿œç¨‹æœåŠ¡è°ƒç”¨ï¼Ÿ</h2><blockquote><p>é€šè¿‡åŠ¨æ€ä»£ç†æ¨¡å¼ï¼Œåœ¨æ‰§è¡Œè¯¥æ–¹æ³•çš„å‰åå¯¹æ•°æ®è¿›è¡Œå°è£…å’Œè§£ç ç­‰ï¼Œè®©ç”¨äºæ„Ÿè§‰å°±åƒæ˜¯ç›´æ¥è°ƒç”¨è¯¥æ–¹æ³•ä¸€æ ·ï¼Œæ®Šä¸çŸ¥ï¼Œæˆ‘ä»¬å¯¹æ–¹æ³•å‰åéƒ½ç»è¿‡äº†å¤æ‚çš„å¤„ç†ã€‚</p></blockquote><h2 id="3-2-å¦‚ä½•å®ç°ä¼ è¾“æ¶ˆæ¯çš„ç¼–è§£ç ï¼Ÿ"><a href="#3-2-å¦‚ä½•å®ç°ä¼ è¾“æ¶ˆæ¯çš„ç¼–è§£ç ï¼Ÿ" class="headerlink" title="3.2 å¦‚ä½•å®ç°ä¼ è¾“æ¶ˆæ¯çš„ç¼–è§£ç ï¼Ÿ"></a>3.2 å¦‚ä½•å®ç°ä¼ è¾“æ¶ˆæ¯çš„ç¼–è§£ç ï¼Ÿ</h2><blockquote><p>é€šä¿—æ¥è¯´ï¼Œåœ¨å®¢æˆ·ç«¯å’ŒæœåŠ¡ç«¯é€šä¿¡çš„è¿‡ç¨‹ä¸­ï¼Œå®¢æˆ·ç«¯å‘æœåŠ¡ç«¯å‘é€æ–¹æ³•è°ƒç”¨è¯·æ±‚ï¼ŒæœåŠ¡ç«¯æ¥æ”¶åˆ°è¯·æ±‚åï¼Œåœ¨æœ¬åœ°è°ƒç”¨æ–¹æ³•ï¼Œè°ƒç”¨ç»“æŸåï¼Œå†å‘å®¢æˆ·ç«¯å‘é€å“åº”æ¶ˆæ¯ã€‚</p></blockquote><p>æ‰€ä»¥æˆ‘ä»¬å°±è¦è‡ªå·±æ¥å°è£…æ¶ˆæ¯å¯¹è±¡çš„æ•°æ®ç»“æ„ï¼Œä»¥ä¾¿äºåŒæ–¹é€šä¿¡çš„è¿›è¡Œï¼Œè€Œæˆ‘ä»¬åœ¨è¿›è¡Œrpcè°ƒç”¨æ—¶ï¼Œä¸å¯èƒ½æ˜¯ç›´æ¥åœ¨ç½‘ç»œä¸­ä¼ è¾“æ¶ˆæ¯å¯¹è±¡çš„ï¼Œç½‘ç»œä¸­çš„æ•°æ®éƒ½æ˜¯ä»¥å­—èŠ‚æµæ–¹å¼æ¥ä¼ è¾“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å°±éœ€è¦å¯¹è¿™äº›å¯¹è±¡è¿›è¡Œç¼–è§£ç ï¼Œè¿™å°±è¦ç”¨åˆ°æ•°æ®åºåˆ—åŒ–å’Œååºåˆ—åŒ–æŠ€æœ¯äº†ã€‚</p><p>&#x3D;&#x3D;åºåˆ—åŒ–ï¼šæŠŠå¯¹è±¡è½¬æ¢ä¸ºå­—èŠ‚åºåˆ—çš„è¿‡ç¨‹ç§°ä¸ºå¯¹è±¡çš„åºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯ç¼–ç çš„è¿‡ç¨‹ã€‚&#x3D;&#x3D;<br>&#x3D;&#x3D;ååºåˆ—åŒ–ï¼šæŠŠå­—èŠ‚åºåˆ—æ¢å¤ä¸ºå¯¹è±¡çš„è¿‡ç¨‹ç§°ä¸ºå¯¹è±¡çš„ååºåˆ—åŒ–ï¼Œä¹Ÿå°±æ˜¯è§£ç çš„è¿‡ç¨‹ã€‚&#x3D;&#x3D;</p>]]></content>
    
    
    <categories>
      
      <category>é¡¹ç›®</category>
      
      <category>æ‰‹æ’•RPCæ¡†æ¶</category>
      
    </categories>
    
    
    <tags>
      
      <tag>RPC</tag>
      
      <tag>é¡¹ç›®</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>MySQLå…«è‚¡æ–‡</title>
    <link href="/2024/07/05/MySQL%E5%85%AB%E8%82%A1%E6%96%87/"/>
    <url>/2024/07/05/MySQL%E5%85%AB%E8%82%A1%E6%96%87/</url>
    
    <content type="html"><![CDATA[<h2 id="ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ"><a href="#ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ" class="headerlink" title="ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ"></a>ä¸€æ¡SQLæŸ¥è¯¢è¯­å¥æ˜¯å¦‚ä½•æ‰§è¡Œçš„ï¼Ÿ</h2><ul><li>è¿æ¥å™¨ï¼šè¿æ¥å™¨è´Ÿè´£å’Œå®¢æˆ·ç«¯å»ºç«‹è¿æ¥ï¼Œè·å–ç”¨æˆ·æƒé™ï¼Œç»´æŒå’Œç®¡ç†è¿æ¥</li><li>æŸ¥è¯¢ç¼“å­˜ï¼šMySQLæ‹¿åˆ°ä¸€æ¡æŸ¥è¯¢è¯­å¥åï¼Œä¼šå…ˆåˆ°ç¼“å­˜ä¸­æŸ¥è¯¢ä¹‹å‰æ˜¯ä¸æ˜¯æ‰§è¡Œè¿‡æ­¤è¯­å¥ï¼Œä¹‹å‰æ‰§è¡Œçš„è¯­å¥åŠå…¶ç»“æœå¯èƒ½ä¼šä»¥Key-valueå¯¹çš„å½¢å¼å­˜å‚¨åœ¨ç¼“å­˜ä¸­ï¼Œå¦‚æœå­˜åœ¨ï¼Œç›´æ¥è¿”å›ç»“æœã€‚</li><li>åˆ†æå™¨ï¼šè¾“å…¥çš„SQLè¯­å¥æ˜¯ç”±å­—ç¬¦ä¸²å’Œç©ºæ ¼æ„æˆçš„ï¼ŒMySQLéœ€è¦è¯†åˆ«å‡ºè¿™äº›å­—ç¬¦ä¸²åˆ†åˆ«æ˜¯ä»€ä¹ˆï¼Œä»£è¡¨ä»€ä¹ˆã€‚</li><li>ä¼˜åŒ–å™¨ï¼šå½“ä¸€ä¸ªè¡¨å­˜åœ¨å¤šä¸ªç´¢å¼•æ—¶ï¼Œä¼˜åŒ–å™¨ä¼šå†³å®šä½¿ç”¨å“ªä¸ªç´¢å¼•ã€‚æˆ–è€…ä¸€ä¸ªè¯­å¥ä¸­ç”±å¤šä¸ªè¡¨ç›¸è¿æ—¶ï¼Œå†³å®šå„ä¸ªè¡¨çš„è¿æ¥é¡ºåºã€‚</li><li>æ‰§è¡Œå™¨ï¼šé€šè¿‡åˆ†æå’Œä¼˜åŒ–ï¼ŒçŸ¥é“äº†è¦åšä»€ä¹ˆï¼Œå¹¶ä¸”è¿˜çŸ¥é“å¯è¯¥æ€ä¹ˆåšã€‚æ¥ç€å°±æ˜¯è¿›è¡Œè¯­å¥çš„æ‰§è¡Œã€‚</li></ul><h2 id="äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>è¯»æœªæäº¤ï¼šä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æäº¤æ—¶ï¼Œå®ƒçš„å˜æ›´å°±èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚(ä¼šå‘ç”Ÿè„è¯»ã€ä¸å¯é‡å¤è¯»ã€å¹»è¯»)</li><li>è¯»æäº¤ï¼šä¸€ä¸ªäº‹åŠ¡æäº¤åï¼Œä»–çš„å˜æ›´æ‰èƒ½è¢«å…¶ä»–äº‹åŠ¡çœ‹åˆ°ã€‚(ä¼šå‘ç”Ÿä¸å¯é‡å¤è¯»ã€å¹»è¯»)</li><li>å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œæ€»æ˜¯è·Ÿåœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ã€‚(ä¼šå‘ç”Ÿå¹»è¯»)</li><li>ä¸²è¡ŒåŒ–ï¼šå†™ä¼šåŠ å†™é”ï¼Œè¯»ä¼šåŠ è¯»é”ã€‚å½“å‡ºç°è¯»å†™é”å†²çªæ—¶ï¼Œåè®¿é—®çš„äº‹åŠ¡å¿…é¡»ç­‰å‰ä¸€ä¸ªäº‹åŠ¡æ‰§è¡Œå®Œæˆï¼Œæ‰èƒ½ç»§ç»­æ‰§è¡Œã€‚</li></ul><p>æŒ‰éš”ç¦»æ°´å¹³é«˜ä½æ’åºï¼š</p><p>ä¸²è¡ŒåŒ– &gt; å¯é‡å¤è¯» &gt; è¯»å·²æäº¤ &gt; è¯»æœªæäº¤</p><h2 id="è¿™å››ç§éš”ç¦»çº§åˆ«æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ"><a href="#è¿™å››ç§éš”ç¦»çº§åˆ«æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="è¿™å››ç§éš”ç¦»çº§åˆ«æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ"></a>è¿™å››ç§éš”ç¦»çº§åˆ«æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</h2><ul><li>å¯¹äºã€Œè¯»æœªæäº¤ã€éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œå› ä¸ºå¯ä»¥è¯»åˆ°æœªæäº¤äº‹åŠ¡ä¿®æ”¹çš„æ•°æ®ï¼Œæ‰€ä»¥&#x3D;&#x3D;ç›´æ¥è¯»å–æœ€æ–°çš„æ•°æ®&#x3D;&#x3D;å°±å¥½äº†ï¼›</li><li>å¯¹äºã€Œä¸²è¡ŒåŒ–ã€éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œé€šè¿‡&#x3D;&#x3D;åŠ è¯»å†™é”çš„æ–¹å¼æ¥é¿å…å¹¶è¡Œè®¿é—®&#x3D;&#x3D;ï¼›</li><li>å¯¹äºã€Œè¯»æäº¤ã€å’Œã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«çš„äº‹åŠ¡æ¥è¯´ï¼Œå®ƒä»¬æ˜¯é€šè¿‡ Read View æ¥å®ç°çš„ï¼Œå®ƒä»¬çš„åŒºåˆ«åœ¨äºåˆ›å»º Read View çš„æ—¶æœºä¸åŒã€‚å¯ä»¥æŠŠ Read View ç†è§£æˆä¸€ä¸ªæ•°æ®å¿«ç…§ï¼Œå°±åƒç›¸æœºæ‹ç…§é‚£æ ·ï¼Œå®šæ ¼æŸä¸€æ—¶åˆ»çš„é£æ™¯ã€‚ã€Œè¯»æäº¤ã€éš”ç¦»çº§åˆ«æ˜¯åœ¨ã€Œæ¯ä¸ªè¯­å¥æ‰§è¡Œå‰ã€éƒ½ä¼šé‡æ–°ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œè€Œã€Œå¯é‡å¤è¯»ã€éš”ç¦»çº§åˆ«æ˜¯ã€Œå¯åŠ¨äº‹åŠ¡æ—¶ã€ç”Ÿæˆä¸€ä¸ª Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewã€‚</li></ul><h2 id="äº‹åŠ¡çš„å››å¤§ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#äº‹åŠ¡çš„å››å¤§ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="äº‹åŠ¡çš„å››å¤§ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ"></a>äº‹åŠ¡çš„å››å¤§ç‰¹æ€§æ˜¯ä»€ä¹ˆï¼Ÿ</h2><ul><li>åŸå­æ€§ï¼šäº‹åŠ¡æ—¶ä¸å¯åˆ†å‰²çš„æœ€å°å·¥ä½œå•å…ƒï¼Œä¸€ä¸ªäº‹åŠ¡å¯¹åº”äºä¸€ä¸ªå®Œæ•´çš„ä¸šåŠ¡ï¼Œä¸€ä¸ªäº‹åŠ¡çš„æ“ä½œè¦ä¹ˆå…¨éƒ¨å®Œæˆï¼Œè¦ä¹ˆå…¨éƒ¨æ²¡å®Œæˆï¼Œå½“æ“ä½œè¿‡ç¨‹ä¸­å‡ºç°é—®é¢˜ï¼Œä¼šå›æ»šåˆ°åŸå§‹çŠ¶æ€ã€‚</li><li>ä¸€è‡´æ€§ï¼šäº‹åŠ¡æ‰§è¡Œä¹‹å‰å’Œæ‰§è¡Œä¹‹åéƒ½å¿…é¡»å¤„äºä¸€è‡´æ€§çŠ¶æ€ã€‚</li><li>éš”ç¦»æ€§ï¼šå…è®¸å¤šä¸ªå¹¶å‘çš„äº‹åŠ¡åŒæ—¶å¯¹æ•°æ®è¿›è¡Œä¿®æ”¹å’Œè¯»å–ï¼Œæ‰§è¡Œäº’ä¸å¹²æ‰°ï¼Œé˜²æ­¢å¤šä¸ªäº‹åŠ¡å¹¶å‘æ‰§è¡Œç”±äºäº¤å‰æ‰§è¡Œé€ æˆæ•°æ®ä¸ä¸€è‡´çš„æƒ…å†µã€‚</li><li>æŒä¹…æ€§ï¼šä¸€ä¸ªäº‹åŠ¡ä¸€æ—¦è¢«æäº¤ï¼Œé‚£ä¹ˆå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…æ€§çš„ï¼Œå³ä¾¿åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­é‡åˆ°æ•…éšœçš„æƒ…å†µä¸‹ä¹Ÿä¸ä¼šä¸¢å¤±æäº¤äº‹åŠ¡çš„æ“ä½œã€‚</li></ul><h2 id="InnoDBå¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯ä¿è¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§å‘¢ï¼Ÿ"><a href="#InnoDBå¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯ä¿è¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§å‘¢ï¼Ÿ" class="headerlink" title="InnoDBå¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯ä¿è¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§å‘¢ï¼Ÿ"></a>InnoDBå¼•æ“é€šè¿‡ä»€ä¹ˆæŠ€æœ¯ä¿è¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§å‘¢ï¼Ÿ</h2><ul><li>æŒä¹…æ€§æ˜¯é€šè¿‡ redo log ï¼ˆé‡åšæ—¥å¿—ï¼‰æ¥ä¿è¯çš„ï¼›</li><li>åŸå­æ€§æ˜¯é€šè¿‡ undo logï¼ˆå›æ»šæ—¥å¿—ï¼‰ æ¥ä¿è¯çš„ï¼›</li><li>éš”ç¦»æ€§æ˜¯é€šè¿‡ MVCCï¼ˆå¤šç‰ˆæœ¬å¹¶å‘æ§åˆ¶ï¼‰ æˆ–é”æœºåˆ¶æ¥ä¿è¯çš„ï¼›</li><li>ä¸€è‡´æ€§åˆ™æ˜¯é€šè¿‡æŒä¹…æ€§+åŸå­æ€§+éš”ç¦»æ€§æ¥ä¿è¯ï¼›</li></ul><h2 id="å¹¶è¡Œäº‹åŠ¡ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ"><a href="#å¹¶è¡Œäº‹åŠ¡ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ" class="headerlink" title="å¹¶è¡Œäº‹åŠ¡ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ"></a>å¹¶è¡Œäº‹åŠ¡ä¼šå¼•å‘ä»€ä¹ˆé—®é¢˜ï¼Ÿ</h2><p>åœ¨åŒæ—¶å¤„ç†å¤šä¸ªäº‹åŠ¡æ—¶ï¼Œå°±å¯èƒ½å‡ºç°&#x3D;&#x3D;è„è¯»ã€ä¸å¯é‡å¤è¯»ä»¥åŠå¹»è¯»&#x3D;&#x3D;ã€‚</p><ul><li>è„è¯»ï¼šä¸€ä¸ªäº‹åŠ¡ã€Œè¯»åˆ°ã€äº†å¦ä¸€ä¸ªäº‹åŠ¡ã€Œæœªæäº¤äº‹åŠ¡ä¿®æ”¹è¿‡çš„æ•°æ®ã€ã€‚</li><li>ä¸å¯é‡å¤è¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡è¯»å–åŒä¸€ä¸ªæ•°æ®ï¼Œå¦‚æœå‡ºç°å‰åä¸¤æ¬¡è¯»åˆ°çš„æ•°æ®ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œä¸å¯é‡å¤è¯»ã€ç°è±¡ã€‚</li><li>å¹»è¯»ï¼šåœ¨ä¸€ä¸ªäº‹åŠ¡å†…å¤šæ¬¡æŸ¥è¯¢æŸä¸ªç¬¦åˆæŸ¥è¯¢æ¡ä»¶çš„ã€Œè®°å½•æ•°é‡ã€ï¼Œå¦‚æœå‡ºç°å‰åä¸¤æ¬¡æŸ¥è¯¢åˆ°çš„è®°å½•æ•°é‡ä¸ä¸€æ ·çš„æƒ…å†µï¼Œå°±æ„å‘³ç€å‘ç”Ÿäº†ã€Œå¹»è¯»ã€ç°è±¡ã€‚</li></ul><p>æŒ‰ä¸¥é‡æ€§æ’åºï¼š</p><p>è„è¯» &gt; ä¸å¯é‡å¤è¯» &gt; å¹»è¯»</p><h2 id="MySQLå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨è§£å†³å¹»è¯»äº†å—ï¼Ÿ"><a href="#MySQLå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨è§£å†³å¹»è¯»äº†å—ï¼Ÿ" class="headerlink" title="MySQLå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨è§£å†³å¹»è¯»äº†å—ï¼Ÿ"></a>MySQLå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œå®Œå…¨è§£å†³å¹»è¯»äº†å—ï¼Ÿ</h2><ul><li>é’ˆå¯¹<strong>å¿«ç…§è¯»</strong>ï¼ˆæ™®é€š select è¯­å¥ï¼‰ï¼Œæ˜¯<strong>é€šè¿‡ MVCC æ–¹å¼è§£å†³äº†å¹»è¯»</strong>ï¼Œå› ä¸ºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œäº‹åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­çœ‹åˆ°çš„æ•°æ®ï¼Œä¸€ç›´è·Ÿè¿™ä¸ªäº‹åŠ¡å¯åŠ¨æ—¶çœ‹åˆ°çš„æ•°æ®æ˜¯ä¸€è‡´çš„ï¼Œå³ä½¿ä¸­é€”æœ‰å…¶ä»–äº‹åŠ¡æ’å…¥äº†ä¸€æ¡æ•°æ®ï¼Œæ˜¯æŸ¥è¯¢ä¸å‡ºæ¥è¿™æ¡æ•°æ®çš„ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜ã€‚</li><li>é’ˆå¯¹<strong>å½“å‰è¯»</strong>ï¼Œæ˜¯<strong>é€šè¿‡ next-key lockï¼ˆè®°å½•é”+é—´éš™é”ï¼‰æ–¹å¼è§£å†³äº†å¹»è¯»</strong>ï¼Œå› ä¸ºå½“æ‰§è¡Œ select â€¦ for update è¯­å¥çš„æ—¶å€™ï¼Œä¼šåŠ ä¸Š next-key lockï¼Œå¦‚æœæœ‰å…¶ä»–äº‹åŠ¡åœ¨ next-key lock é”èŒƒå›´å†…æ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œé‚£ä¹ˆè¿™ä¸ªæ’å…¥è¯­å¥å°±ä¼šè¢«é˜»å¡ï¼Œæ— æ³•æˆåŠŸæ’å…¥ï¼Œæ‰€ä»¥å°±å¾ˆå¥½äº†é¿å…å¹»è¯»é—®é¢˜ã€‚</li></ul><h2 id="è¯·ä¸¾ä¾‹å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå‘ç”Ÿå¹»è¯»çš„åœºæ™¯"><a href="#è¯·ä¸¾ä¾‹å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå‘ç”Ÿå¹»è¯»çš„åœºæ™¯" class="headerlink" title="è¯·ä¸¾ä¾‹å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå‘ç”Ÿå¹»è¯»çš„åœºæ™¯"></a>è¯·ä¸¾ä¾‹å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œå‘ç”Ÿå¹»è¯»çš„åœºæ™¯</h2><ul><li>å¯¹äºå¿«ç…§è¯»ï¼ŒMVCC å¹¶ä¸èƒ½å®Œå…¨é¿å…å¹»è¯»ç°è±¡ã€‚å› ä¸ºå½“äº‹åŠ¡ A æ›´æ–°äº†ä¸€æ¡äº‹åŠ¡ B æ’å…¥çš„è®°å½•ï¼Œé‚£ä¹ˆäº‹åŠ¡ A å‰åä¸¤æ¬¡æŸ¥è¯¢çš„è®°å½•æ¡ç›®å°±ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥å°±å‘ç”Ÿå¹»è¯»ã€‚</li><li>å¯¹äºå½“å‰è¯»ï¼Œå¦‚æœäº‹åŠ¡å¼€å¯åï¼Œå¹¶æ²¡æœ‰æ‰§è¡Œå½“å‰è¯»ï¼Œè€Œæ˜¯å…ˆå¿«ç…§è¯»ï¼Œç„¶åè¿™æœŸé—´å¦‚æœå…¶ä»–äº‹åŠ¡æ’å…¥äº†ä¸€æ¡è®°å½•ï¼Œé‚£ä¹ˆäº‹åŠ¡åç»­ä½¿ç”¨å½“å‰è¯»è¿›è¡ŒæŸ¥è¯¢çš„æ—¶å€™ï¼Œå°±ä¼šå‘ç°ä¸¤æ¬¡æŸ¥è¯¢çš„è®°å½•æ¡ç›®å°±ä¸ä¸€æ ·äº†ï¼Œæ‰€ä»¥å°±å‘ç”Ÿå¹»è¯»ã€‚</li></ul><p><strong>å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹è™½ç„¶å¾ˆå¤§ç¨‹åº¦ä¸Šé¿å…äº†å¹»è¯»ï¼Œä½†æ˜¯è¿˜æ˜¯æ²¡æœ‰èƒ½å®Œå…¨è§£å†³å¹»è¯»</strong>ã€‚</p><h2 id="å¦‚ä½•é¿å…å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å‘ç”Ÿå¹»è¯»çš„åœºæ™¯å‘¢ï¼Ÿ"><a href="#å¦‚ä½•é¿å…å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å‘ç”Ÿå¹»è¯»çš„åœºæ™¯å‘¢ï¼Ÿ" class="headerlink" title="å¦‚ä½•é¿å…å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å‘ç”Ÿå¹»è¯»çš„åœºæ™¯å‘¢ï¼Ÿ"></a>å¦‚ä½•é¿å…å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å‘ç”Ÿå¹»è¯»çš„åœºæ™¯å‘¢ï¼Ÿ</h2><ul><li>å°½é‡åœ¨å¼€å¯äº‹åŠ¡ä¹‹åï¼Œé©¬ä¸Šæ‰§è¡Œ select â€¦ for update è¿™ç±»å½“å‰è¯»çš„è¯­å¥ï¼Œå› ä¸ºå®ƒä¼šå¯¹è®°å½•åŠ  next-key lockï¼Œä»è€Œé¿å…å…¶ä»–äº‹åŠ¡æ’å…¥ä¸€æ¡æ–°è®°å½•ã€‚</li></ul><h2 id="ç´¢å¼•æœ‰å“ªäº›ç§ç±»ï¼Ÿ"><a href="#ç´¢å¼•æœ‰å“ªäº›ç§ç±»ï¼Ÿ" class="headerlink" title="ç´¢å¼•æœ‰å“ªäº›ç§ç±»ï¼Ÿ"></a>ç´¢å¼•æœ‰å“ªäº›ç§ç±»ï¼Ÿ</h2><ul><li>ä»æ•°æ®ç»“æ„ç»´åº¦åˆ†ç±»ï¼š<ul><li>B+æ ‘ç´¢å¼•ï¼šæ‰€æœ‰å­èŠ‚ç‚¹å­˜å‚¨æ•°æ®ï¼Œé€‚åˆèŒƒå›´æŸ¥è¯¢ã€‚</li><li>å“ˆå¸Œç´¢å¼•ï¼šé€‚åˆç­‰å€¼æŸ¥è¯¢ã€‚</li><li>å…¨æ–‡ç´¢å¼•ï¼šMyISAMå’ŒInnoDBä¸­æ”¯æŒä½¿ç”¨å…¨æ–‡ç´¢å¼•ã€‚</li><li>R-Treeç´¢å¼•ï¼šç”¨æ¥å¯¹GISæ•°æ®ç±»å‹åˆ›å»ºSPATIALç´¢å¼•ã€‚</li></ul></li><li>ä»ç‰©ç†å­˜å‚¨ç»´åº¦åˆ†ç±»ï¼š<ul><li>ï¼ˆèšé›†ç´¢å¼•ï¼‰èšç°‡ç´¢å¼•ï¼šæ•°æ®å­˜å‚¨ä¸ç´¢å¼•ä¸€èµ·å­˜æ”¾ï¼Œå¶å­èŠ‚ç‚¹ä¼šå­˜å‚¨ä¸€æ•´è¡Œè®°å½•ï¼Œæ‰¾åˆ°ç´¢å¼•ä¹Ÿå°±æ‰¾åˆ°äº†æ•°æ®ã€‚</li><li>ï¼ˆéèšé›†ï¼‰äºŒçº§ç´¢å¼•ï¼šæ•°æ®å­˜å‚¨ä¸ç´¢å¼•åˆ†å¼€å­˜æ”¾ï¼Œå¶å­èŠ‚ç‚¹ä¸å­˜å‚¨æ•°æ®ï¼Œå­˜å‚¨çš„æ˜¯æ•°æ®åœ°å€ã€‚</li></ul></li><li>ä»é€»è¾‘ç»´åº¦åˆ†ç±»<ul><li>ä¸»é”®ç´¢å¼•ï¼šä¸€ç§ç‰¹æ®Šçš„å”¯ä¸€ç´¢å¼•ï¼Œä¸å…è®¸ç”±ç©ºå€¼ã€‚</li><li>å”¯ä¸€ç´¢å¼•ï¼šç´¢å¼•åˆ—ä¸­çš„å€¼å¿…é¡»å”¯ä¸€ï¼Œå€¼å…è®¸ä¸ºç©ºã€‚</li><li>æ™®é€šç´¢å¼•ï¼šMySQLä¸­çš„åŸºæœ¬ç´¢å¼•ç±»å‹ï¼Œå…è®¸ç©ºå€¼å’Œé‡å¤å€¼ã€‚</li><li>è”åˆç´¢å¼•ï¼šå¤šä¸ªå­—æ®µåˆ›å»ºçš„ç´¢å¼•ï¼Œä½¿ç”¨æ—¶éµå¾ªæœ€å·¦å‰ç¼€åŸåˆ™ã€‚</li><li>ç©ºé—´ç´¢å¼•ï¼šMySQL5.7ä¹‹åæ”¯æŒç©ºé—´ç´¢å¼•ï¼Œåœ¨ç©ºé—´ç´¢å¼•è¿™æ–¹é¢éµå¾ªOpenGISå‡ ä½•æ•°æ®æ¨¡å‹è§„åˆ™ã€‚</li></ul></li></ul><h2 id="MySQLä¸ºä»€ä¹ˆä½¿ç”¨B-æ ‘æ¥ä½œç´¢å¼•å‘¢ï¼Ÿ"><a href="#MySQLä¸ºä»€ä¹ˆä½¿ç”¨B-æ ‘æ¥ä½œç´¢å¼•å‘¢ï¼Ÿ" class="headerlink" title="MySQLä¸ºä»€ä¹ˆä½¿ç”¨B+æ ‘æ¥ä½œç´¢å¼•å‘¢ï¼Ÿ"></a>MySQLä¸ºä»€ä¹ˆä½¿ç”¨B+æ ‘æ¥ä½œç´¢å¼•å‘¢ï¼Ÿ</h2><ul><li>æŸ¥è¯¢åº•å±‚èŠ‚ç‚¹ï¼šB+æ ‘çš„éå¶å­èŠ‚ç‚¹ä¸å­˜æ”¾å®é™…çš„è®°å½•æ•°æ®ï¼Œè¿›å­˜æ”¾ç´¢å¼•ï¼Œå› æ­¤æ•°æ®é‡ç›¸åŒçš„æƒ…å†µä¸‹ï¼Œç›¸æ¯”æ—¢å­˜å‚¨ç´¢å¼•åˆå­˜å‚¨è®°å½•çš„Bæ ‘ï¼ŒB+æ ‘å¯ä»¥æœ‰æ›´å¤§çš„ç©ºé—´æ¥å­˜æ”¾æ›´å¤šçš„ç´¢å¼•ï¼Œæ‰€ä»¥æŸ¥è¯¢åº•å±‚èŠ‚ç‚¹çš„ç£ç›˜I&#x2F;Oæ¬¡æ•°ä¼šæ›´å°‘ã€‚</li><li>æ’å…¥å’Œåˆ é™¤ï¼šB+æ ‘æœ‰å¤§é‡çš„å†—ä½™èŠ‚ç‚¹ï¼Œåˆ é™¤ä¸€ä¸ªèŠ‚ç‚¹æ—¶ï¼Œå¯ä»¥ç›´æ¥ä»å¶å­èŠ‚ç‚¹ä¸­åˆ é™¤ï¼Œç”šè‡³ä¸ç”¨ç§»åŠ¨éå¶å­èŠ‚ç‚¹ï¼Œåˆ é™¤éå¸¸å—ã€‚æ’å…¥ä¹Ÿæ˜¯ä¸€æ ·ï¼Œè™½ç„¶æ’å…¥å¯èƒ½å­˜åœ¨èŠ‚ç‚¹çš„åˆ†è£‚ï¼ˆå¦‚æœèŠ‚ç‚¹é¥±å’Œï¼‰ï¼Œä½†æ˜¯æœ€å¤šåªæ¶‰åŠæ ‘çš„ä¸€æ¡è·¯å¾„ã€‚Bæ ‘æ²¡æœ‰å†—ä½™èŠ‚ç‚¹ï¼Œåˆ é™¤çš„æ—¶å€™éå¸¸å¤æ‚ï¼Œå¯èƒ½è®¾è®¡å¤æ‚çš„æ ‘çš„å˜å½¢ã€‚</li><li>èŒƒå›´æŸ¥è¯¢ï¼šB+ æ ‘å¶å­èŠ‚ç‚¹ä¹‹é—´ç”¨é“¾è¡¨è¿æ¥äº†èµ·æ¥ï¼Œæœ‰åˆ©äºèŒƒå›´æŸ¥è¯¢ï¼Œè€Œ B æ ‘è¦å®ç°èŒƒå›´æŸ¥è¯¢ï¼Œå› æ­¤åªèƒ½é€šè¿‡æ ‘çš„éå†æ¥å®ŒæˆèŒƒå›´æŸ¥è¯¢ï¼Œè¿™ä¼šæ¶‰åŠå¤šä¸ªèŠ‚ç‚¹çš„ç£ç›˜ I&#x2F;O æ“ä½œï¼ŒèŒƒå›´æŸ¥è¯¢æ•ˆç‡ä¸å¦‚ B+ æ ‘ã€‚</li></ul><h2 id="B-æ ‘å’ŒBæ ‘çš„å·®å¼‚æœ‰å“ªäº›ï¼Ÿ"><a href="#B-æ ‘å’ŒBæ ‘çš„å·®å¼‚æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="B+æ ‘å’ŒBæ ‘çš„å·®å¼‚æœ‰å“ªäº›ï¼Ÿ"></a>B+æ ‘å’ŒBæ ‘çš„å·®å¼‚æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>B+æ ‘çš„å¶å­èŠ‚ç‚¹å­˜æ”¾å®é™…æ•°æ®ï¼ˆç´¢å¼•+è®°å½•ï¼‰ï¼Œéå¶å­èŠ‚ç‚¹åªä¼šå­˜æ”¾ç´¢å¼•ã€‚</li><li>æ‰€æœ‰çš„ç´¢å¼•éƒ½ä¼šåœ¨å¶å­èŠ‚ç‚¹å‡ºç°ï¼Œå¶å­èŠ‚ç‚¹ä¹‹é—´æ„æˆä¸€ä¸ªæœ‰åºé“¾è¡¨ã€‚</li><li>éå¶å­èŠ‚ç‚¹çš„ç´¢å¼•ä¹Ÿä¼šåŒæ—¶å­˜åœ¨åœ¨å­èŠ‚ç‚¹ä¸­ï¼Œå¹¶ä¸”æ˜¯åœ¨å­èŠ‚ç‚¹ä¸­æ‰€æœ‰ç´¢å¼•çš„æœ€å¤§ï¼ˆæˆ–æœ€å°ï¼‰ã€‚</li><li>éå¶å­èŠ‚ç‚¹ä¸­æœ‰å¤šå°‘ä¸ªå­èŠ‚ç‚¹ï¼Œå°±æœ‰å¤šå°‘ä¸ªç´¢å¼•ï¼›</li></ul><h2 id="ä»€ä¹ˆæ—¶å€™éœ€è¦å»ºç«‹ç´¢å¼•ï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™éœ€è¦å»ºç«‹ç´¢å¼•ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™éœ€è¦å»ºç«‹ç´¢å¼•ï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™éœ€è¦å»ºç«‹ç´¢å¼•ï¼Ÿ</h2><ul><li><p>è¡¨çš„ä¸»å…³é”®å­—ï¼šè‡ªåŠ¨å»ºç«‹å”¯ä¸€ç´¢å¼•ã€‚</p></li><li><p>ç›´æ¥æ¡ä»¶æŸ¥è¯¢çš„å­—æ®µï¼š&#x3D;&#x3D;ç»å¸¸&#x3D;&#x3D;ç”¨äºWHEREæŸ¥è¯¢æ¡ä»¶çš„å­—æ®µï¼Œè¿™æ ·èƒ½å¤Ÿæé«˜æ•´ä¸ªè¡¨çš„æŸ¥è¯¢é€Ÿåº¦ã€‚</p></li><li><p>æŸ¥è¯¢ä¸­ä¸å…¶å®ƒè¡¨å…³è”çš„å­—æ®µï¼šä¾‹å¦‚å­—æ®µå»ºâ½´äº†å¤–é”®å…³ç³»ã€‚</p></li><li><p>æŸ¥è¯¢ä¸­æ’åºçš„å­—æ®µï¼šæ’åºçš„å­—æ®µå¦‚æœé€šè¿‡ç´¢å¼•å»è®¿é—®å°†â¼¤â¼¤æâ¾¼æ’åºé€Ÿåº¦ï¼Œå¦åˆ™ç”¨çš„æ˜¯æ–‡ä»¶æ’åºã€‚</p></li><li><p>å”¯â¼€æ€§çº¦æŸåˆ—ï¼š å¦‚æœæŸåˆ—å…·æœ‰å”¯â¼€æ€§çº¦æŸï¼Œé‚£ä¹ˆä¸ºäº†ç¡®ä¿æ•°æ®çš„å”¯â¼€æ€§ï¼Œå¯ä»¥åœ¨è¿™äº›åˆ—ä¸Šåˆ›å»ºå”¯</p><p>â¼€ç´¢å¼•ã€‚</p></li><li><p>â¼¤è¡¨ä¸­çš„å…³é”®åˆ—ï¼š åœ¨â¼¤è¡¨ä¸­ï¼Œå¦‚æœæŸ¥è¯¢çš„æ•ˆç‡å˜å¾—å¾ˆä½ï¼Œå¯ä»¥è€ƒè™‘åœ¨å…³é”®åˆ—ä¸Šåˆ›å»ºç´¢å¼•ã€‚</p></li></ul><h2 id="ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Ÿ"><a href="#ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Ÿ"></a>ä»€ä¹ˆæ—¶å€™ä¸éœ€è¦åˆ›å»ºç´¢å¼•ï¼Ÿ</h2><ul><li><p>å°è¡¨ï¼šå¯¹â¼©è¡¨åˆ›å»ºç´¢å¼•å¯èƒ½ä¼šå¸¦æ¥é¢å¤–çš„å¼€é”€ï¼Œå› ä¸ºåœ¨â¼©æ•°æ®é›†ä¸­æ‰«ææ•´ä¸ªè¡¨å¯èƒ½â½ä½¿â½¤ç´¢å¼•æ›´</p><p>å¿«ã€‚</p></li><li><p>é¢‘ç¹çš„æ’å…¥ã€æ›´æ–°å’Œåˆ é™¤ï¼šç´¢å¼•çš„ç»´æŠ¤æˆæœ¬ä¼šéšç€æ•°æ®çš„æ’â¼Šã€æ›´æ–°å’Œåˆ é™¤æ“ä½œâ½½å¢åŠ ã€‚å¦‚</p><p>æœè¡¨ç»å¸¸è¢«ä¿®æ”¹ï¼Œè¿‡å¤šçš„ç´¢å¼•å¯èƒ½ä¼šå½±å“æ€§èƒ½ã€‚</p></li><li><p>æ•°æ®é‡å¤ä¸”å‡åŒ€åˆ†å¸ƒï¼šè¿™ç§å­—æ®µå»ºç´¢å¼•â¼€èˆ¬ä¸ä¼šæâ¾¼æ•°æ®åº“çš„æŸ¥è¯¢é€Ÿåº¦ã€‚</p></li><li><p>å¾ˆå°‘è¢«æŸ¥è¯¢çš„åˆ—ï¼šå¦‚æœæŸåˆ—å¾ˆå°‘è¢«â½¤äºæŸ¥è¯¢æ¡ä»¶ï¼Œé‚£ä¹ˆä¸ºå®ƒåˆ›å»ºç´¢å¼•å¯èƒ½æ²¡æœ‰æ˜æ˜¾çš„æ€§èƒ½æ</p><p>å‡ã€‚</p></li><li><p>æŸ¥è¯¢ç»“æœæ€»è¡Œæ•°å¾ˆå°‘çš„åˆ—ï¼šå¦‚æœæŸ¥è¯¢çš„ç»“æœé›†æ€»â¾æ•°å¾ˆå°‘ï¼Œä½¿â½¤ç´¢å¼•å¯èƒ½ä¸ä¼šæœ‰å¤ªâ¼¤çš„æ€§èƒ½æ</p><p>å‡ã€‚</p></li></ul><h2 id="ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ"><a href="#ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ"></a>ç´¢å¼•å¤±æ•ˆçš„åœºæ™¯æœ‰å“ªäº›ï¼Ÿ</h2><ul><li><p>å½“æˆ‘ä»¬ä½¿ç”¨å·¦æˆ–è€…å·¦å³æ¨¡ç³ŠåŒ¹é…çš„æ—¶å€™ï¼Œä¹Ÿå°±æ˜¯ <code>like %xx</code> æˆ–è€… <code>like %xx%</code>è¿™ä¸¤ç§æ–¹å¼éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼›</p></li><li><p>è¡¨è¿æ¥ä¸­çš„åˆ—ç±»å‹ä¸åŒ¹é…ï¼š å¦‚æœåœ¨è¿æ¥æ“ä½œä¸­æ¶‰åŠçš„ä¸¤ä¸ªè¡¨çš„åˆ—ç±»å‹ä¸åŒ¹é…ï¼Œç´¢å¼•å¯èƒ½ä¼šå¤±æ•ˆã€‚</p><p>ä¾‹å¦‚ï¼Œâ¼€ä¸ªè¡¨çš„åˆ—æ˜¯æ•´æ•°ï¼Œå¦â¼€ä¸ªè¡¨çš„åˆ—æ˜¯å­—ç¬¦ï¼Œè¿æ¥æ—¶å¯èƒ½ä¼šå¯¼è‡´ç´¢å¼•å¤±æ•ˆã€‚</p></li><li><p>å½“æˆ‘ä»¬åœ¨æŸ¥è¯¢æ¡ä»¶ä¸­å¯¹ç´¢å¼•åˆ—åšäº†è®¡ç®—ã€å‡½æ•°ã€ç±»å‹è½¬æ¢æ“ä½œï¼Œè¿™äº›æƒ…å†µä¸‹éƒ½ä¼šé€ æˆç´¢å¼•å¤±æ•ˆï¼›</p></li><li><p>ä¸ç­‰å·æ¡ä»¶ï¼š å½“æŸ¥è¯¢ä¸­åŒ…å«ä¸ç­‰å·æ¡ä»¶ï¼ˆå¦‚&gt;,&lt;,&gt;&#x3D;,&lt;&#x3D;ï¼‰æ—¶ï¼Œç´¢å¼•å¯èƒ½ä¼šå¤±æ•ˆã€‚é€šå¸¸æƒ…å†µä¸‹ï¼Œç´¢</p><p>å¼•åªèƒ½â½¤äºç­‰å€¼â½è¾ƒã€‚</p></li><li><p>OR æ¡ä»¶ï¼š å½“æŸ¥è¯¢ä¸­ä½¿â½¤å¤šä¸ª OR æ¡ä»¶æ—¶ï¼Œå¦‚æœè¿™äº›æ¡ä»¶ä¸æ¶‰åŠåŒâ¼€åˆ—ï¼Œç´¢å¼•å¯èƒ½â½†æ³•æœ‰æ•ˆä½¿</p><p>â½¤ã€‚æ•°æ®åº“å¯èƒ½ä¼šé€‰æ‹©å…¨è¡¨æ‰«æâ½½ä¸æ˜¯ä½¿â½¤å¤šä¸ªç´¢å¼•ã€‚</p></li></ul><h2 id="ä¼˜åŒ–ç´¢å¼•çš„æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ"><a href="#ä¼˜åŒ–ç´¢å¼•çš„æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="ä¼˜åŒ–ç´¢å¼•çš„æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ"></a>ä¼˜åŒ–ç´¢å¼•çš„æ–¹æ³•æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>å‰ç¼€ç´¢å¼•ä¼˜åŒ–</li><li>è¦†ç›–ç´¢å¼•ä¼˜åŒ–</li><li>ä¸»é”®ç´¢å¼•æœ€å¥½æ˜¯è‡ªå¢çš„</li><li>é˜²æ­¢ç´¢å¼•å¤±æ•ˆ</li></ul><h2 id="MySQLçš„æ‰§è¡Œå¼•æ“æœ‰å“ªäº›ï¼Ÿ"><a href="#MySQLçš„æ‰§è¡Œå¼•æ“æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="MySQLçš„æ‰§è¡Œå¼•æ“æœ‰å“ªäº›ï¼Ÿ"></a>MySQLçš„æ‰§è¡Œå¼•æ“æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>InnoDBï¼šå¼•æ“æä¾›äº†å¯¹äº‹åŠ¡ACIDçš„â½€æŒï¼Œè¿˜æä¾›äº†â¾çº§é”å’Œå¤–é”®çš„çº¦æŸã€‚</li><li>MyISAMï¼šå¼•æ“ä¸â½€æŒäº‹åŠ¡ï¼Œä¹Ÿä¸â½€æŒâ¾çº§é”å’Œå¤–é”®çº¦æŸã€‚</li><li>Memeryï¼šå°±æ˜¯å°†æ•°æ®æ”¾åœ¨å†…å­˜ä¸­ï¼Œæ•°æ®å¤„ç†é€Ÿåº¦å¾ˆå¿«ï¼Œä½†æ˜¯å®‰å…¨æ€§ä¸â¾¼ã€‚</li></ul><h2 id="MySQLå•è¡¨ä¸è¦è¶…è¿‡2000wè¡Œï¼Œé è°±å—ï¼Ÿ"><a href="#MySQLå•è¡¨ä¸è¦è¶…è¿‡2000wè¡Œï¼Œé è°±å—ï¼Ÿ" class="headerlink" title="MySQLå•è¡¨ä¸è¦è¶…è¿‡2000wè¡Œï¼Œé è°±å—ï¼Ÿ"></a>MySQLå•è¡¨ä¸è¦è¶…è¿‡2000wè¡Œï¼Œé è°±å—ï¼Ÿ</h2><p>2000wåªæ˜¯æ¨èå€¼ï¼Œè¶…è¿‡è¿™ä¸ªå€¼å¯èƒ½ä¼šå¯¼è‡´B+æ ‘å±‚çº§æ›´é«˜ï¼Œå½±å“æŸ¥è¯¢æ€§èƒ½ã€‚</p><h2 id="count-å’Œcount-1-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªæ€§èƒ½æ›´å¥½ï¼Ÿ"><a href="#count-å’Œcount-1-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªæ€§èƒ½æ›´å¥½ï¼Ÿ" class="headerlink" title="count(*)å’Œcount(1)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªæ€§èƒ½æ›´å¥½ï¼Ÿ"></a>count(*)å’Œcount(1)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿå“ªä¸ªæ€§èƒ½æ›´å¥½ï¼Ÿ</h2><p>count(*)å…¶å®ç­‰äº count(0)ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“ä½ ä½¿ç”¨ count(*) æ—¶ï¼ŒMySQL ä¼šå°† * å‚æ•°è½¬åŒ–ä¸ºå‚æ•° 0 æ¥å¤„ç†ã€‚</p><p><strong>æ€§èƒ½æ’åº</strong></p><p>&#x3D;&#x3D;count(*) &#x3D; count(1) &gt; count(ä¸»é”®å­—æ®µ) &gt; count(å­—æ®µ)&#x3D;&#x3D;</p><p>count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ)åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æœè¡¨é‡Œå­˜åœ¨äºŒçº§ç´¢å¼•ï¼Œä¼˜åŒ–å™¨å°±ä¼šé€‰æ‹©äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æã€‚å¦‚æœè¦æ‰§è¡Œ count(1)ã€ count(*)ã€ count(ä¸»é”®å­—æ®µ) æ—¶ï¼Œå°½é‡åœ¨æ•°æ®è¡¨ä¸Šå»ºç«‹äºŒçº§ç´¢å¼•ï¼Œè¿™æ ·ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨é‡‡ç”¨ key_len æœ€å°çš„äºŒçº§ç´¢å¼•è¿›è¡Œæ‰«æï¼Œç›¸æ¯”äºæ‰«æä¸»é”®ç´¢å¼•æ•ˆç‡ä¼šé«˜ä¸€äº›ã€‚ä¸è¦ä½¿ç”¨ count(å­—æ®µ) æ¥ç»Ÿè®¡è®°å½•ä¸ªæ•°ï¼Œå› ä¸ºå®ƒçš„æ•ˆç‡æ˜¯æœ€å·®çš„ï¼Œä¼šé‡‡ç”¨å…¨è¡¨æ‰«æçš„æ–¹å¼æ¥ç»Ÿè®¡ã€‚å¦‚æœä½ éè¦ç»Ÿè®¡è¡¨ä¸­è¯¥å­—æ®µä¸ä¸º NULL çš„è®°å½•ä¸ªæ•°ï¼Œå»ºè®®ç»™è¿™ä¸ªå­—æ®µå»ºç«‹ä¸€ä¸ªäºŒçº§ç´¢å¼•ã€‚</p><h2 id="å¦‚ä½•ä¼˜åŒ–count"><a href="#å¦‚ä½•ä¼˜åŒ–count" class="headerlink" title="å¦‚ä½•ä¼˜åŒ–count(*)?"></a>å¦‚ä½•ä¼˜åŒ–count(*)?</h2><ul><li>è¿‘ä¼¼å€¼ï¼šå¦‚æœä¸šåŠ¡å¯¹äºç»Ÿè®¡ä¸ªæ•°ä¸éœ€è¦å¾ˆç²¾ç¡®ï¼Œå¯ä»¥ä½¿ç”¨show table statusæˆ–è€…explainå‘½ä»¤æ¥è¿›è¡Œä¼°ç®—ã€‚</li><li>é¢å¤–è¡¨ä¿å­˜è®¡æ•°å€¼ï¼šæƒ³ç²¾ç¡®çš„è·å–è¡¨çš„è®°å½•æ€»æ•°ï¼Œæˆ‘ä»¬å¯ä»¥å°†è¿™ä¸ªè®¡æ•°å€¼ä¿å­˜åˆ°å•ç‹¬çš„ä¸€å¼ è®¡æ•°è¡¨ä¸­ã€‚å½“æˆ‘ä»¬åœ¨æ•°æ®è¡¨æ’å…¥ä¸€æ¡è®°å½•çš„åŒæ—¶ï¼Œå°†è®¡æ•°è¡¨ä¸­çš„è®¡æ•°å­—æ®µ + 1ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨æ–°å¢å’Œåˆ é™¤æ“ä½œæ—¶ï¼Œæˆ‘ä»¬éœ€è¦é¢å¤–ç»´æŠ¤è¿™ä¸ªè®¡æ•°è¡¨ã€‚</li></ul><h2 id="MySQLä½¿ç”¨-like-â€œ-xâ€ï¼Œç´¢å¼•ä¸€å®šä¼šå¤±æ•ˆå—ï¼Ÿ"><a href="#MySQLä½¿ç”¨-like-â€œ-xâ€ï¼Œç´¢å¼•ä¸€å®šä¼šå¤±æ•ˆå—ï¼Ÿ" class="headerlink" title="MySQLä½¿ç”¨ like â€œ%xâ€ï¼Œç´¢å¼•ä¸€å®šä¼šå¤±æ•ˆå—ï¼Ÿ"></a>MySQLä½¿ç”¨ like â€œ%xâ€ï¼Œç´¢å¼•ä¸€å®šä¼šå¤±æ•ˆå—ï¼Ÿ</h2><p><strong>ä¸ä¸€å®š</strong></p><p>å› ä¸ºå¦‚æœè¿™å¼ è¡¨çš„å­—æ®µéƒ½æ˜¯ç´¢å¼•å­—æ®µï¼Œé‚£ä¹ˆæŸ¥è¯¢çš„æ—¶å€™å°±ä¼šä½¿ç”¨è¦†ç›–ç´¢å¼•ï¼Œ<strong>æŸ¥è¯¢çš„æ•°æ®éƒ½åœ¨äºŒçº§ç´¢å¼•çš„ B+ æ ‘ï¼Œå› ä¸ºäºŒçº§ç´¢å¼•çš„ B+ æ ‘çš„å¶å­èŠ‚ç‚¹åŒ…å«ã€Œç´¢å¼•å€¼+ä¸»é”®å€¼ã€ï¼Œæ‰€ä»¥æŸ¥äºŒçº§ç´¢å¼•çš„ B+ æ ‘å°±èƒ½æŸ¥åˆ°å…¨éƒ¨ç»“æœäº†</strong></p><p>ä½†æ˜¯å¦‚æœæŸ¥è¯¢å­—æ®µä¸­å«æœ‰éç´¢å¼•å­—æ®µï¼Œé‚£ä¹ˆç´¢å¼•å°±ä¼šå¤±æ•ˆäº†ï¼Œè¦æŸ¥è¯¢çš„æ•°æ®å°±ä¸èƒ½åªåœ¨äºŒçº§ç´¢å¼•æ ‘é‡Œæ‰¾äº†ï¼Œå¾—éœ€è¦å›è¡¨æ“ä½œæ‰èƒ½å®ŒæˆæŸ¥è¯¢çš„å·¥ä½œï¼Œå†åŠ ä¸Šæ˜¯å·¦æ¨¡ç³ŠåŒ¹é…ï¼Œæ— æ³•åˆ©ç”¨ç´¢å¼•æ ‘çš„æœ‰åºæ€§æ¥å¿«é€Ÿå®šä½æ•°æ®ï¼Œæ‰€ä»¥å¾—åœ¨äºŒçº§ç´¢å¼•æ ‘é€ä¸€éå†ï¼Œè·å–ä¸»é”®å€¼åï¼Œå†åˆ°èšç°‡ç´¢å¼•æ ‘æ£€ç´¢åˆ°å¯¹åº”çš„æ•°æ®è¡Œï¼Œä¼˜åŒ–å™¨è®¤ä¸ºä¸Šé¢è¿™æ ·çš„æŸ¥è¯¢è¿‡ç¨‹çš„æˆæœ¬å®åœ¨å¤ªé«˜äº†ï¼Œæ‰€ä»¥ç›´æ¥é€‰æ‹©å…¨è¡¨æ‰«æçš„æ–¹å¼æ¥æŸ¥è¯¢æ•°æ®ã€‚</p><h2 id="MySQLæœ‰å“ªäº›é”å‘¢ï¼Ÿ"><a href="#MySQLæœ‰å“ªäº›é”å‘¢ï¼Ÿ" class="headerlink" title="MySQLæœ‰å“ªäº›é”å‘¢ï¼Ÿ"></a>MySQLæœ‰å“ªäº›é”å‘¢ï¼Ÿ</h2><ul><li><p>å…¨å±€é”ï¼šä¸»è¦åº”ç”¨äºåš<strong>å…¨åº“é€»è¾‘å¤‡ä»½</strong>ï¼Œè¿™æ ·åœ¨å¤‡ä»½æ•°æ®åº“æœŸé—´ï¼Œä¸ä¼šå› ä¸ºæ•°æ®æˆ–è¡¨ç»“æ„çš„æ›´æ–°ï¼Œè€Œå‡ºç°å¤‡ä»½æ–‡ä»¶çš„æ•°æ®ä¸é¢„æœŸçš„ä¸ä¸€æ ·ã€‚</p><ul><li>å…¨å±€é”æœ‰ä»€ä¹ˆç¼ºç‚¹å‘¢ï¼Ÿ<ul><li>åŠ ä¸Šå…¨å±€é”ï¼Œæ„å‘³ç€æ•´ä¸ªæ•°æ®åº“éƒ½æ˜¯åªè¯»çŠ¶æ€ã€‚é‚£ä¹ˆå¦‚æœæ•°æ®åº“é‡Œæœ‰å¾ˆå¤šæ•°æ®ï¼Œå¤‡ä»½å°±ä¼šèŠ±è´¹å¾ˆå¤šçš„æ—¶é—´ï¼Œå…³é”®æ˜¯å¤‡ä»½æœŸé—´ï¼Œä¸šåŠ¡åªèƒ½è¯»æ•°æ®ï¼Œè€Œä¸èƒ½æ›´æ–°æ•°æ®ï¼Œè¿™æ ·ä¼šé€ æˆä¸šåŠ¡åœæ»ã€‚</li></ul></li><li>ä½¿ç”¨å…¨å±€é”ä¼šå½±å“ä¸šåŠ¡ï¼Œé‚£æœ‰ä»€ä¹ˆå…¶ä»–æ–¹å¼å¯ä»¥é¿å…ï¼Ÿ<ul><li>å¦‚æœæ•°æ®åº“çš„å¼•æ“æ”¯æŒçš„äº‹åŠ¡æ”¯æŒ<strong>å¯é‡å¤è¯»çš„éš”ç¦»çº§åˆ«</strong>ï¼Œé‚£ä¹ˆåœ¨å¤‡ä»½æ•°æ®åº“ä¹‹å‰å…ˆå¼€å¯äº‹åŠ¡ï¼Œä¼šå…ˆåˆ›å»º Read Viewï¼Œç„¶åæ•´ä¸ªäº‹åŠ¡æ‰§è¡ŒæœŸé—´éƒ½åœ¨ç”¨è¿™ä¸ª Read Viewï¼Œè€Œä¸”ç”±äº MVCC çš„æ”¯æŒï¼Œå¤‡ä»½æœŸé—´ä¸šåŠ¡ä¾ç„¶å¯ä»¥å¯¹æ•°æ®è¿›è¡Œæ›´æ–°æ“ä½œã€‚</li></ul></li></ul></li><li><p>è¡¨çº§é”</p><ul><li><p>è¡¨é”ï¼šè¡¨é”é™¤äº†ä¼šé™åˆ¶åˆ«çš„çº¿ç¨‹çš„è¯»å†™å¤–ï¼Œä¹Ÿä¼šé™åˆ¶æœ¬çº¿ç¨‹æ¥ä¸‹æ¥çš„è¯»å†™æ“ä½œã€‚</p></li><li><p>å…ƒæ•°æ®é”ï¼šå¯¹æ•°æ®åº“è¡¨è¿›è¡Œæ“ä½œæ—¶ï¼Œä¼šâ¾ƒåŠ¨ç»™è¿™ä¸ªè¡¨åŠ ä¸Šå…ƒæ•°æ®é”ï¼Œä¸ºäº†ä¿è¯å½“â½¤æˆ·å¯¹è¡¨æ‰§â¾ CRUD æ“ä½œæ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¯¹è¿™ä¸ªè¡¨ç»“æ„åšäº†å˜æ›´ã€‚å…ƒæ•°æ®é”åœ¨äº‹åŠ¡æäº¤åæ‰ä¼šé‡Šæ”¾ã€‚</p></li><li><p>æ„å‘é”ï¼šå¯¹æŸäº›è®°å½•åŠ ä¸Šã€Œå…±äº«é”ã€ä¹‹å‰ï¼Œéœ€è¦å…ˆåœ¨è¡¨çº§åˆ«åŠ ä¸Šä¸€ä¸ªã€Œæ„å‘å…±äº«é”ã€ï¼›å¯¹æŸäº›çºªå½•åŠ ä¸Šã€Œç‹¬å é”ã€ä¹‹å‰ï¼Œéœ€è¦å…ˆåœ¨è¡¨çº§åˆ«åŠ ä¸Šä¸€ä¸ªã€Œæ„å‘ç‹¬å é”ã€ï¼›å½“æ‰§è¡Œæ’å…¥ã€æ›´æ–°ã€åˆ é™¤æ“ä½œï¼Œéœ€è¦å…ˆå¯¹è¡¨åŠ ä¸Šã€Œæ„å‘ç‹¬å é”ã€ï¼Œç„¶åå¯¹è¯¥è®°å½•åŠ ç‹¬å é”ã€‚</p><p>è€Œæ™®é€šçš„ select æ˜¯ä¸ä¼šåŠ è¡Œçº§é”çš„ï¼Œæ™®é€šçš„ select è¯­å¥æ˜¯åˆ©ç”¨ MVCC å®ç°ä¸€è‡´æ€§è¯»ï¼Œæ˜¯æ— é”çš„ã€‚</p><ul><li><strong>æ„å‘é”çš„ç›®çš„æ˜¯ä¸ºäº†å¿«é€Ÿåˆ¤æ–­è¡¨é‡Œæ˜¯å¦æœ‰è®°å½•è¢«åŠ é”</strong>ã€‚</li></ul></li><li><p>AUTO-INCé”ï¼šè¡¨â¾¥çš„ä¸»é”®é€šå¸¸éƒ½ä¼šè®¾ç½®æˆâ¾ƒå¢çš„ï¼Œä¹‹åå¯ä»¥åœ¨æ’â¼Šæ•°æ®æ—¶ï¼Œå¯ä»¥ä¸æŒ‡å®šä¸»é”®çš„å€¼ï¼Œæ•°æ®åº“ä¼šâ¾ƒåŠ¨ç»™ä¸»é”®èµ‹å€¼é€’å¢çš„å€¼é€šè¿‡ AUTO-INC é”å®ç°çš„ã€‚&#x3D;&#x3D;åœ¨æ’â¼Šæ•°æ®æ—¶ï¼Œä¼šåŠ â¼€ä¸ªè¡¨çº§åˆ«çš„ AUTO-INC é”&#x3D;&#x3D;ï¼Œç„¶åä¸ºè¢« AUTO_INCREMENT ä¿®é¥°çš„å­—æ®µèµ‹å€¼é€’å¢çš„å€¼ï¼Œç­‰æ’â¼Šè¯­å¥æ‰§â¾å®Œæˆåï¼Œæ‰ä¼šæŠŠ AUTO-INC é”é‡Šæ”¾æ‰ã€‚å…¶ä»–äº‹åŠ¡çš„å¦‚æœè¦å‘è¯¥è¡¨æ’â¼Šè¯­å¥éƒ½ä¼šè¢«é˜»å¡ï¼Œä»â½½ä¿è¯æ’â¼Šæ•°æ®æ—¶å­—æ®µçš„å€¼æ˜¯è¿ç»­é€’å¢çš„ã€‚</p></li></ul></li><li><p>è¡Œçº§é”</p><ul><li>Record Lockï¼šè®°å½•é”ï¼Œä¹Ÿå°±æ˜¯ä»…ä»…æŠŠä¸€æ¡è®°å½•é”ä¸Šï¼›è®°å½•é”åˆ†ä¸ºæ’ä»–é”å’Œå…±äº«é”ã€‚<ul><li>åªæœ‰Så’ŒSå…¼å®¹</li><li>å…±äº«é”ï¼ˆSé”ï¼‰æ»¡è¶³è¯»è¯»å…±äº«ï¼Œè¯»å†™äº’æ–¥ã€‚</li><li>ç‹¬å é”ï¼ˆXé”ï¼‰æ»¡è¶³å†™å†™äº’æ–¥ã€è¯»å†™äº’æ–¥ã€‚</li></ul></li><li>Gap Lockï¼šé—´éš™é”ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œä½†æ˜¯ä¸åŒ…å«è®°å½•æœ¬èº«ï¼›åªå­˜åœ¨äºå¯é‡å¤è¯»éš”ç¦»çº§åˆ«ï¼Œâ½¬çš„æ˜¯ä¸ºäº†è§£å†³å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹å¹»è¯»çš„ç°è±¡ã€‚<strong>é—´éš™é”ä¹‹é—´æ˜¯å…¼å®¹çš„ï¼Œå³ä¸¤ä¸ªäº‹åŠ¡å¯ä»¥åŒæ—¶æŒæœ‰åŒ…å«å…±åŒé—´éš™èŒƒå›´çš„é—´éš™é”ï¼Œå¹¶ä¸å­˜åœ¨äº’æ–¥å…³ç³»</strong></li><li>Next-Key Lockï¼š&#x3D;&#x3D;Record Lock + Gap Lock çš„ç»„åˆ&#x3D;&#x3D;ï¼Œé”å®šä¸€ä¸ªèŒƒå›´ï¼Œå¹¶ä¸”é”å®šè®°å½•æœ¬èº«ã€‚next-key lock å³èƒ½ä¿æŠ¤è¯¥è®°å½•ï¼Œâ¼œèƒ½é˜»â½Œå…¶ä»–äº‹åŠ¡å°†æ–°çºªå½•æ’â¼Šåˆ°è¢«ä¿æŠ¤è®°å½•å‰â¾¯çš„é—´éš™ä¸­ã€‚</li><li>æ’å…¥æ„å‘é”ï¼šâ¼€ä¸ªäº‹åŠ¡åœ¨æ’â¼Šâ¼€æ¡è®°å½•çš„æ—¶å€™ï¼Œéœ€è¦åˆ¤æ–­æ’â¼Šä½ç½®æ˜¯å¦å·²è¢«å…¶ä»–äº‹åŠ¡åŠ äº†é—´éš™é”ï¼ˆnext-key lock ä¹ŸåŒ…å«é—´éš™é”ï¼‰ã€‚å¦‚æœæœ‰çš„è¯ï¼Œæ’â¼Šæ“ä½œå°±ä¼šå‘â½£é˜»å¡ï¼Œç›´åˆ°æ‹¥æœ‰é—´éš™é”çš„é‚£ä¸ªäº‹åŠ¡æäº¤ä¸ºæ­¢ï¼Œåœ¨æ­¤æœŸé—´ä¼šâ½£æˆâ¼€ä¸ªæ’â¼Šæ„å‘é”ï¼Œè¡¨æ˜æœ‰äº‹åŠ¡æƒ³åœ¨æŸä¸ªåŒºé—´æ’â¼Šæ–°è®°å½•ï¼Œä½†æ˜¯ç°åœ¨å¤„äºç­‰å¾…çŠ¶æ€ã€‚</li></ul></li></ul><h2 id="updateæ²¡åŠ ç´¢å¼•ä¼šé”å…¨è¡¨ï¼Ÿ"><a href="#updateæ²¡åŠ ç´¢å¼•ä¼šé”å…¨è¡¨ï¼Ÿ" class="headerlink" title="updateæ²¡åŠ ç´¢å¼•ä¼šé”å…¨è¡¨ï¼Ÿ"></a>updateæ²¡åŠ ç´¢å¼•ä¼šé”å…¨è¡¨ï¼Ÿ</h2><p>æ˜¯çš„ï¼Œä¼šå¼•èµ·é”å…¨è¡¨ï¼<strong>åœ¨ update è¯­å¥çš„ where æ¡ä»¶æ²¡æœ‰ä½¿ç”¨ç´¢å¼•ï¼Œå°±ä¼šå…¨è¡¨æ‰«æï¼Œäºæ˜¯å°±ä¼šå¯¹æ‰€æœ‰è®°å½•åŠ ä¸Š next-key é”ï¼ˆè®°å½•é” + é—´éš™é”ï¼‰ï¼Œç›¸å½“äºæŠŠæ•´ä¸ªè¡¨é”ä½äº†</strong>ã€‚</p><p>-<br>  æ‰§è¡Œ update è¯­å¥çš„æ—¶å€™ï¼Œç¡®ä¿ where æ¡ä»¶ä¸­å¸¦ä¸Šäº†ç´¢å¼•åˆ—ï¼Œå¹¶ä¸”åœ¨æµ‹è¯•æœºç¡®è®¤è¯¥è¯­å¥æ˜¯å¦èµ°çš„æ˜¯ç´¢å¼•æ‰«æï¼Œé˜²æ­¢å› ä¸ºæ‰«æå…¨è¡¨ï¼Œè€Œå¯¹è¡¨ä¸­çš„æ‰€æœ‰è®°å½•åŠ ä¸Šé”ã€‚</p><ul><li>æ‰“å¼€ MySQL sql_safe_updates å‚æ•°ï¼Œè¿™æ ·å¯ä»¥é¢„é˜² update æ“ä½œæ—¶ where æ¡ä»¶æ²¡æœ‰å¸¦ä¸Šç´¢å¼•åˆ—ã€‚</li><li>å¦‚æœå‘ç°å³ä½¿åœ¨ where æ¡ä»¶ä¸­å¸¦ä¸Šäº†åˆ—ç´¢å¼•åˆ—ï¼Œä¼˜åŒ–å™¨èµ°çš„è¿˜æ˜¯å…¨æ ‡æ‰«æï¼Œè¿™æ—¶æˆ‘ä»¬å°±è¦ä½¿ç”¨ <code>force index([index_name])</code> å¯ä»¥å‘Šè¯‰ä¼˜åŒ–å™¨ä½¿ç”¨å“ªä¸ªç´¢å¼•ã€‚</li></ul><h2 id="MySQLè®°å½•é”-é—´éš™é”å¯ä»¥é˜²æ­¢åˆ é™¤æ“ä½œè€Œå¯¼è‡´å¹»è¯»å—ï¼Ÿ"><a href="#MySQLè®°å½•é”-é—´éš™é”å¯ä»¥é˜²æ­¢åˆ é™¤æ“ä½œè€Œå¯¼è‡´å¹»è¯»å—ï¼Ÿ" class="headerlink" title="MySQLè®°å½•é”+é—´éš™é”å¯ä»¥é˜²æ­¢åˆ é™¤æ“ä½œè€Œå¯¼è‡´å¹»è¯»å—ï¼Ÿ"></a>MySQLè®°å½•é”+é—´éš™é”å¯ä»¥é˜²æ­¢åˆ é™¤æ“ä½œè€Œå¯¼è‡´å¹»è¯»å—ï¼Ÿ</h2><p>å¯ä»¥é˜²æ­¢æ­¤ç±»äº‹æƒ…å‘ç”Ÿï¼</p><ul><li>åœ¨ MySQL çš„å¯é‡å¤è¯»éš”ç¦»çº§åˆ«ä¸‹ï¼Œé’ˆå¯¹å½“å‰è¯»çš„è¯­å¥ä¼šå¯¹<strong>ç´¢å¼•</strong>åŠ è®°å½•é”+é—´éš™é”ï¼Œè¿™æ ·å¯ä»¥é¿å…å…¶ä»–äº‹åŠ¡æ‰§è¡Œå¢ã€åˆ ã€æ”¹æ—¶å¯¼è‡´å¹»è¯»çš„é—®é¢˜ã€‚</li><li>åœ¨æ‰§è¡Œ updateã€deleteã€select â€¦ for update ç­‰å…·æœ‰åŠ é”æ€§è´¨çš„è¯­å¥ï¼Œä¸€å®šè¦æ£€æŸ¥è¯­å¥æ˜¯å¦èµ°äº†ç´¢å¼•ï¼Œå¦‚æœæ˜¯å…¨è¡¨æ‰«æçš„è¯ï¼Œä¼šå¯¹æ¯ä¸€ä¸ªç´¢å¼•åŠ  next-key é”ï¼Œç›¸å½“äºæŠŠæ•´ä¸ªè¡¨é”ä½äº†ï¼Œè¿™æ˜¯æŒºä¸¥é‡çš„é—®é¢˜ã€‚</li></ul><h2 id="MySQLæ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ"><a href="#MySQLæ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ" class="headerlink" title="MySQLæ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ"></a>MySQLæ­»é”äº†ï¼Œæ€ä¹ˆåŠï¼Ÿ</h2><p>æ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š<strong>äº’æ–¥ã€å æœ‰ä¸”ç­‰å¾…ã€ä¸å¯å¼ºå ç”¨ã€å¾ªç¯ç­‰å¾…</strong>ã€‚</p><p>ä¸¤ç§ç­–ç•¥é€šè¿‡æ‰“ç ´å¾ªç¯ç­‰å¾…æ¡ä»¶æ¥è§£é™¤æ­»é”çŠ¶æ€ï¼š</p><ul><li>è®¾ç½®äº‹åŠ¡ç­‰å¾…é”çš„è¶…æ—¶æ—¶é—´ã€‚å½“ä¸€ä¸ªäº‹åŠ¡çš„ç­‰å¾…æ—¶é—´è¶…è¿‡è¯¥å€¼åï¼Œå°±å¯¹è¿™ä¸ªäº‹åŠ¡è¿›è¡Œå›æ»šï¼Œäºæ˜¯é”å°±é‡Šæ”¾äº†ï¼Œå¦ä¸€ä¸ªäº‹åŠ¡å°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚</li><li>å¼€å¯ä¸»åŠ¨æ­»é”æ£€æµ‹ã€‚ä¸»åŠ¨æ­»é”æ£€æµ‹åœ¨å‘ç°æ­»é”åï¼Œä¸»åŠ¨å›æ»šæ­»é”é“¾æ¡ä¸­çš„æŸä¸€ä¸ªäº‹åŠ¡ï¼Œè®©å…¶ä»–äº‹åŠ¡å¾—ä»¥ç»§ç»­æ‰§è¡Œã€‚</li></ul><h2 id="MySQLæ—¥å¿—æ–‡ä»¶æœ‰å“ªå‡ ç§ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#MySQLæ—¥å¿—æ–‡ä»¶æœ‰å“ªå‡ ç§ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="MySQLæ—¥å¿—æ–‡ä»¶æœ‰å“ªå‡ ç§ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>MySQLæ—¥å¿—æ–‡ä»¶æœ‰å“ªå‡ ç§ï¼Ÿæœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><ul><li>undo logï¼šå›æ»šæ—¥å¿—ï¼Œæ˜¯ Innodb å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„<strong>åŸå­æ€§</strong>ï¼Œä¸»è¦<strong>ç”¨äºäº‹åŠ¡å›æ»šå’Œ MVCC</strong>ã€‚<ul><li>MVCCæ˜¯é€šè¿‡ ReadView + undo log å®ç°çš„ã€‚undo log ä¸ºæ¯æ¡è®°å½•ä¿å­˜å¤šä»½å†å²æ•°æ®ï¼ŒMySQL åœ¨æ‰§è¡Œå¿«ç…§è¯»ï¼ˆæ™®é€š select è¯­å¥ï¼‰çš„æ—¶å€™ï¼Œä¼šæ ¹æ®äº‹åŠ¡çš„ Read View é‡Œçš„ä¿¡æ¯ï¼Œé¡ºç€ undo log çš„ç‰ˆæœ¬é“¾æ‰¾åˆ°æ»¡è¶³å…¶å¯è§æ€§çš„è®°å½•ã€‚</li></ul></li><li>redo logï¼šé‡åšæ—¥å¿—ï¼Œæ˜¯ Innodb å­˜å‚¨å¼•æ“å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œå®ç°äº†äº‹åŠ¡ä¸­çš„<strong>æŒä¹…æ€§</strong>ï¼Œä¸»è¦<strong>ç”¨äºæ‰ç”µç­‰æ•…éšœæ¢å¤</strong>ã€‚</li><li>binlogï¼šå½’æ¡£æ—¥å¿—ï¼Œæ˜¯ Server å±‚ç”Ÿæˆçš„æ—¥å¿—ï¼Œä¸»è¦<strong>ç”¨äºæ•°æ®å¤‡ä»½å’Œä¸»ä»å¤åˆ¶</strong>ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>å…«è‚¡</category>
      
      <category>MySQL</category>
      
    </categories>
    
    
    <tags>
      
      <tag>MySQL</tag>
      
      <tag>å…«è‚¡</tag>
      
    </tags>
    
  </entry>
  
  
  
  <entry>
    <title>Rediså…«è‚¡æ–‡</title>
    <link href="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/"/>
    <url>/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/</url>
    
    <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Redisï¼Ÿ"><a href="#ä»€ä¹ˆæ˜¯Redisï¼Ÿ" class="headerlink" title="ä»€ä¹ˆæ˜¯Redisï¼Ÿ"></a>ä»€ä¹ˆæ˜¯Redisï¼Ÿ</h2><p>Redis æ˜¯ä¸€ç§åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œå¯¹æ•°æ®çš„è¯»å†™æ“ä½œéƒ½æ˜¯åœ¨å†…å­˜ä¸­å®Œæˆï¼Œå› æ­¤<strong>è¯»å†™é€Ÿåº¦éå¸¸å¿«</strong>ï¼Œå¸¸ç”¨äº<strong>ç¼“å­˜ï¼Œæ¶ˆæ¯é˜Ÿåˆ—ã€åˆ†å¸ƒå¼é”ç­‰åœºæ™¯</strong>ã€‚Redis æä¾›äº†å¤šç§æ•°æ®ç±»å‹æ¥æ”¯æŒä¸åŒçš„ä¸šåŠ¡åœºæ™¯ï¼Œæ¯”å¦‚ String(å­—ç¬¦ä¸²)ã€Hash(å“ˆå¸Œ)ã€ List (åˆ—è¡¨)ã€Set(é›†åˆ)ã€Zset(æœ‰åºé›†åˆ)ã€Bitmapsï¼ˆä½å›¾ï¼‰ã€HyperLogLogï¼ˆåŸºæ•°ç»Ÿè®¡ï¼‰ã€GEOï¼ˆåœ°ç†ä¿¡æ¯ï¼‰ã€Streamï¼ˆæµï¼‰ï¼Œå¹¶ä¸”å¯¹æ•°æ®ç±»å‹çš„æ“ä½œéƒ½æ˜¯<strong>åŸå­æ€§</strong>çš„ï¼Œå› ä¸ºæ‰§è¡Œå‘½ä»¤ç”±å•çº¿ç¨‹è´Ÿè´£çš„ï¼Œä¸å­˜åœ¨å¹¶å‘ç«äº‰çš„é—®é¢˜ã€‚</p><h2 id="Rediså’ŒMemcachedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#Rediså’ŒMemcachedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="Rediså’ŒMemcachedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>Rediså’ŒMemcachedæœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><ul><li>å…±åŒç‚¹<ul><li>éƒ½æ˜¯åŸºäºå†…å­˜çš„æ•°æ®åº“ï¼Œä¸€èˆ¬éƒ½ç”¨æ¥å½“ä½œç¼“å­˜ä½¿ç”¨ã€‚</li><li>éƒ½æœ‰è¿‡æœŸçš„ç­–ç•¥ã€‚</li><li>ä¸¤è€…çš„æ€§èƒ½éƒ½éå¸¸é«˜ã€‚</li></ul></li><li>åŒºåˆ«ï¼š<ul><li>Redisæ”¯æŒçš„æ•°æ®ç±»å‹æ›´ä¸ºä¸°å¯Œï¼Œè€ŒMemcachedåªæ”¯æŒç®€å•çš„key-valueæ•°æ®ç±»å‹ã€‚</li><li>Redisæ”¯æŒæ•°æ®çš„æŒä¹…åŒ–ï¼Œå¯ä»¥å°†å†…å­˜ä¸­çš„æ•°æ®ä¿æŒåœ¨ç£ç›˜ä¸­ï¼Œé‡å¯çš„æ—¶å€™å¯ä»¥å†æ¬¡åŠ è½½è¿›è¡Œä½¿ç”¨ï¼Œè€Œ Memcached æ²¡æœ‰æŒä¹…åŒ–åŠŸèƒ½ï¼Œæ•°æ®å…¨éƒ¨å­˜åœ¨å†…å­˜ä¹‹ä¸­ï¼ŒMemcached é‡å¯æˆ–è€…æŒ‚æ‰åï¼Œæ•°æ®å°±æ²¡äº†ï¼›</li><li>Redis åŸç”Ÿæ”¯æŒé›†ç¾¤æ¨¡å¼ï¼ŒMemcached æ²¡æœ‰åŸç”Ÿçš„é›†ç¾¤æ¨¡å¼ï¼Œéœ€è¦ä¾é å®¢æˆ·ç«¯æ¥å®ç°å¾€é›†ç¾¤ä¸­åˆ†ç‰‡å†™å…¥æ•°æ®ï¼›</li><li>Redis æ”¯æŒå‘å¸ƒè®¢é˜…æ¨¡å‹ã€Lua è„šæœ¬ã€äº‹åŠ¡ç­‰åŠŸèƒ½ï¼Œè€Œ Memcached ä¸æ”¯æŒï¼›</li></ul></li></ul><h2 id="ä¸ºä»€ä¹ˆç”¨Redisä½œä¸ºMySQLçš„ç¼“å­˜ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆç”¨Redisä½œä¸ºMySQLçš„ç¼“å­˜ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆç”¨Redisä½œä¸ºMySQLçš„ç¼“å­˜ï¼Ÿ"></a>ä¸ºä»€ä¹ˆç”¨Redisä½œä¸ºMySQLçš„ç¼“å­˜ï¼Ÿ</h2><ul><li>Rediså…·æœ‰é«˜æ€§èƒ½ã€‚ç”¨æˆ·ç¬¬ä¸€æ¬¡è®¿é—® MySQL ä¸­çš„æŸäº›æ•°æ®ã€‚è¿™ä¸ªè¿‡ç¨‹ä¼šæ¯”è¾ƒæ…¢ï¼Œå› ä¸ºæ˜¯ä»ç¡¬ç›˜ä¸Šè¯»å–çš„ã€‚å°†è¯¥ç”¨æˆ·è®¿é—®çš„æ•°æ®ç¼“å­˜åœ¨ Redis ä¸­ï¼Œè¿™æ ·ä¸‹ä¸€æ¬¡å†è®¿é—®è¿™äº›æ•°æ®çš„æ—¶å€™å°±å¯ä»¥ç›´æ¥ä»ç¼“å­˜ä¸­è·å–äº†ï¼Œæ“ä½œ Redis ç¼“å­˜å°±æ˜¯ç›´æ¥æ“ä½œå†…å­˜ï¼Œæ‰€ä»¥é€Ÿåº¦ç›¸å½“å¿«ã€‚</li><li>Rediså…·æœ‰é«˜å¹¶å‘ã€‚ç›´æ¥è®¿é—® Redis èƒ½å¤Ÿæ‰¿å—çš„è¯·æ±‚æ˜¯è¿œè¿œå¤§äºç›´æ¥è®¿é—® MySQL çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥è€ƒè™‘æŠŠæ•°æ®åº“ä¸­çš„éƒ¨åˆ†æ•°æ®è½¬ç§»åˆ°ç¼“å­˜ä¸­å»ï¼Œè¿™æ ·ç”¨æˆ·çš„ä¸€éƒ¨åˆ†è¯·æ±‚ä¼šç›´æ¥åˆ°ç¼“å­˜è¿™é‡Œè€Œä¸ç”¨ç»è¿‡æ•°æ®åº“ã€‚</li></ul><h2 id="Redisçš„æ•°æ®ç±»å‹ä»¥åŠä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Redisçš„æ•°æ®ç±»å‹ä»¥åŠä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Redisçš„æ•°æ®ç±»å‹ä»¥åŠä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Redisçš„æ•°æ®ç±»å‹ä»¥åŠä½¿ç”¨åœºæ™¯æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/%E4%BA%94%E7%A7%8D%E6%95%B0%E6%8D%AE%E7%B1%BB%E5%9E%8B-17201898400001.png" alt="äº”ç§æ•°æ®ç±»å‹"></p><ul><li>String ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼šç¼“å­˜å¯¹è±¡ã€å¸¸è§„è®¡æ•°ã€åˆ†å¸ƒå¼é”ã€å…±äº« session ä¿¡æ¯ç­‰ã€‚</li><li>List ç±»å‹çš„åº”ç”¨åœºæ™¯ï¼šæ¶ˆæ¯é˜Ÿåˆ—ï¼ˆä½†æ˜¯æœ‰ä¸¤ä¸ªé—®é¢˜ï¼š1. ç”Ÿäº§è€…éœ€è¦è‡ªè¡Œå®ç°å…¨å±€å”¯ä¸€ IDï¼›2. ä¸èƒ½ä»¥æ¶ˆè´¹ç»„å½¢å¼æ¶ˆè´¹æ•°æ®ï¼‰ç­‰ã€‚</li><li>Hash ç±»å‹ï¼šç¼“å­˜å¯¹è±¡ã€è´­ç‰©è½¦ç­‰ã€‚</li><li>Set ç±»å‹ï¼šèšåˆè®¡ç®—ï¼ˆå¹¶é›†ã€äº¤é›†ã€å·®é›†ï¼‰åœºæ™¯ï¼Œæ¯”å¦‚ç‚¹èµã€å…±åŒå…³æ³¨ã€æŠ½å¥–æ´»åŠ¨ç­‰ã€‚</li><li>Zset ç±»å‹ï¼šæ’åºåœºæ™¯ï¼Œæ¯”å¦‚æ’è¡Œæ¦œã€ç”µè¯å’Œå§“åæ’åºç­‰ã€‚</li></ul><h2 id="äº”ç§å¸¸è§çš„Redisæ•°æ®ç±»å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"><a href="#äº”ç§å¸¸è§çš„Redisæ•°æ®ç±»å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ" class="headerlink" title="äº”ç§å¸¸è§çš„Redisæ•°æ®ç±»å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ"></a>äº”ç§å¸¸è§çš„Redisæ•°æ®ç±»å‹æ˜¯æ€ä¹ˆå®ç°çš„ï¼Ÿ</h2><ul><li>Stringç±»å‹çš„å†…éƒ¨å®ç°<ul><li>SDS ä¸ä»…å¯ä»¥ä¿å­˜æ–‡æœ¬æ•°æ®ï¼Œè¿˜å¯ä»¥ä¿å­˜äºŒè¿›åˆ¶æ•°æ®ã€‚</li><li>SDS è·å–å­—ç¬¦ä¸²é•¿åº¦çš„æ—¶é—´å¤æ‚åº¦æ˜¯ O(1)ã€‚</li><li>Redis çš„ SDS API æ˜¯å®‰å…¨çš„ï¼Œæ‹¼æ¥å­—ç¬¦ä¸²ä¸ä¼šé€ æˆç¼“å†²åŒºæº¢å‡ºã€‚</li></ul></li><li>Listç±»å‹å†…éƒ¨å®ç°<ul><li>List æ•°æ®ç±»å‹åº•å±‚æ•°æ®ç»“æ„ç”± quicklist å®ç°äº†ï¼Œæ›¿ä»£äº†åŒå‘é“¾è¡¨å’Œå‹ç¼©åˆ—è¡¨ã€‚</li></ul></li><li>Hash ç±»å‹å†…éƒ¨å®ç°<ul><li>å¦‚æœå“ˆå¸Œç±»å‹å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼Œæ‰€æœ‰å€¼å°äº 64 å­—èŠ‚çš„è¯ï¼ŒRedis ä¼šä½¿ç”¨<strong>å‹ç¼©åˆ—è¡¨</strong>ä½œä¸º Hash ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›<strong>å‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æ„æ¥å®ç°äº†</strong>ã€‚</li><li>å¦‚æœå“ˆå¸Œç±»å‹å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨<strong>å“ˆå¸Œè¡¨</strong>ä½œä¸º Hash ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ã€‚</li></ul></li><li>Set ç±»å‹å†…éƒ¨å®ç°<ul><li>å¦‚æœé›†åˆä¸­çš„å…ƒç´ éƒ½æ˜¯æ•´æ•°ä¸”å…ƒç´ ä¸ªæ•°å°äº 512 ä¸ªï¼ŒRedis ä¼šä½¿ç”¨<strong>æ•´æ•°é›†åˆ</strong>ä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›</li><li>å¦‚æœé›†åˆä¸­çš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢æ¡ä»¶ï¼Œåˆ™ Redis ä½¿ç”¨<strong>å“ˆå¸Œè¡¨</strong>ä½œä¸º Set ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ã€‚</li></ul></li><li>ZSet ç±»å‹å†…éƒ¨å®ç°<ul><li>å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸ªæ•°å°äº 128 ä¸ªï¼Œå¹¶ä¸”æ¯ä¸ªå…ƒç´ çš„å€¼å°äº 64 å­—èŠ‚æ—¶ï¼ŒRedis ä¼šä½¿ç”¨<strong>å‹ç¼©åˆ—è¡¨</strong>ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›<strong>å‹ç¼©åˆ—è¡¨æ•°æ®ç»“æ„å·²ç»åºŸå¼ƒäº†ï¼Œäº¤ç”± listpack æ•°æ®ç»“æ„æ¥å®ç°äº†ã€‚</strong></li><li>å¦‚æœæœ‰åºé›†åˆçš„å…ƒç´ ä¸æ»¡è¶³ä¸Šé¢çš„æ¡ä»¶ï¼ŒRedis ä¼šä½¿ç”¨<strong>è·³è¡¨</strong>ä½œä¸º Zset ç±»å‹çš„åº•å±‚æ•°æ®ç»“æ„ï¼›</li></ul></li></ul><h2 id="Redisæ˜¯å•çº¿ç¨‹å—ï¼Ÿ"><a href="#Redisæ˜¯å•çº¿ç¨‹å—ï¼Ÿ" class="headerlink" title="Redisæ˜¯å•çº¿ç¨‹å—ï¼Ÿ"></a>Redisæ˜¯å•çº¿ç¨‹å—ï¼Ÿ</h2><ul><li>Redis å•çº¿ç¨‹æŒ‡çš„æ˜¯<strong>ã€Œæ¥æ”¶å®¢æˆ·ç«¯è¯·æ±‚-&gt;è§£æè¯·æ±‚ -&gt;è¿›è¡Œæ•°æ®è¯»å†™ç­‰æ“ä½œ-&gt;å‘é€æ•°æ®ç»™å®¢æˆ·ç«¯ã€</strong>è¿™ä¸ªè¿‡ç¨‹æ˜¯ç”±ä¸€ä¸ªçº¿ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰æ¥å®Œæˆçš„ã€‚</li><li>ä½†æ˜¯ï¼Œ<strong>Redis ç¨‹åºå¹¶ä¸æ˜¯å•çº¿ç¨‹çš„</strong>ï¼ŒRedis åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œæ˜¯ä¼š<strong>å¯åŠ¨åå°çº¿ç¨‹</strong>çš„ï¼Œ2 ä¸ªåå°çº¿ç¨‹ï¼Œåˆ†åˆ«å¤„ç†å…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜è¿™ä¸¤ä¸ªä»»åŠ¡ï¼›1ä¸ªæ–°çš„åå°çº¿ç¨‹ï¼Œç”¨æ¥å¼‚æ­¥é‡Šæ”¾ Redis å†…å­˜ã€‚ä¹‹æ‰€ä»¥ Redis ä¸ºã€Œå…³é—­æ–‡ä»¶ã€AOF åˆ·ç›˜ã€é‡Šæ”¾å†…å­˜ã€è¿™äº›ä»»åŠ¡åˆ›å»ºå•ç‹¬çš„çº¿ç¨‹æ¥å¤„ç†ï¼Œæ˜¯å› ä¸ºè¿™äº›ä»»åŠ¡çš„æ“ä½œéƒ½æ˜¯å¾ˆè€—æ—¶çš„ï¼Œå¦‚æœæŠŠè¿™äº›ä»»åŠ¡éƒ½æ”¾åœ¨ä¸»çº¿ç¨‹æ¥å¤„ç†ï¼Œé‚£ä¹ˆ Redis ä¸»çº¿ç¨‹å°±å¾ˆå®¹æ˜“å‘ç”Ÿé˜»å¡ï¼Œè¿™æ ·å°±æ— æ³•å¤„ç†åç»­çš„è¯·æ±‚äº†ã€‚</li></ul><h2 id="Redisé‡‡ç”¨å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ"><a href="#Redisé‡‡ç”¨å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ" class="headerlink" title="Redisé‡‡ç”¨å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ"></a>Redisé‡‡ç”¨å•çº¿ç¨‹ä¸ºä»€ä¹ˆè¿˜é‚£ä¹ˆå¿«ï¼Ÿ</h2><ul><li>Redis çš„å¤§éƒ¨åˆ†æ“ä½œ<strong>éƒ½åœ¨å†…å­˜ä¸­å®Œæˆ</strong>ï¼Œå¹¶ä¸”é‡‡ç”¨äº†é«˜æ•ˆçš„æ•°æ®ç»“æ„ã€‚å› æ­¤ Redis ç“¶é¢ˆå¯èƒ½æ˜¯æœºå™¨çš„å†…å­˜æˆ–è€…ç½‘ç»œå¸¦å®½ï¼Œè€Œå¹¶é CPUï¼Œæ—¢ç„¶ CPU ä¸æ˜¯ç“¶é¢ˆï¼Œé‚£ä¹ˆè‡ªç„¶å°±é‡‡ç”¨å•çº¿ç¨‹çš„è§£å†³æ–¹æ¡ˆäº†ï¼›</li><li>Redis é‡‡ç”¨å•çº¿ç¨‹æ¨¡å‹å¯ä»¥<strong>é¿å…äº†å¤šçº¿ç¨‹ä¹‹é—´çš„ç«äº‰</strong>ï¼Œçœå»äº†å¤šçº¿ç¨‹åˆ‡æ¢å¸¦æ¥çš„æ—¶é—´å’Œæ€§èƒ½ä¸Šçš„å¼€é”€ï¼Œè€Œä¸”ä¹Ÿä¸ä¼šå¯¼è‡´æ­»é”é—®é¢˜ã€‚</li><li>Redis é‡‡ç”¨äº† <strong>I&#x2F;O å¤šè·¯å¤ç”¨æœºåˆ¶</strong>å¤„ç†å¤§é‡çš„å®¢æˆ·ç«¯ Socket è¯·æ±‚ï¼Œç®€å•æ¥è¯´ï¼Œåœ¨ Redis åªè¿è¡Œå•çº¿ç¨‹çš„æƒ…å†µä¸‹ï¼Œè¯¥æœºåˆ¶å…è®¸å†…æ ¸ä¸­ï¼ŒåŒæ—¶å­˜åœ¨å¤šä¸ªç›‘å¬ Socket å’Œå·²è¿æ¥ Socketã€‚å†…æ ¸ä¼šä¸€ç›´ç›‘å¬è¿™äº› Socket ä¸Šçš„è¿æ¥è¯·æ±‚æˆ–æ•°æ®è¯·æ±‚ã€‚ä¸€æ—¦æœ‰è¯·æ±‚åˆ°è¾¾ï¼Œå°±ä¼šäº¤ç»™ Redis çº¿ç¨‹å¤„ç†ï¼Œè¿™å°±å®ç°äº†ä¸€ä¸ª Redis çº¿ç¨‹å¤„ç†å¤šä¸ª IO æµçš„æ•ˆæœã€‚</li></ul><h2 id="Redis-6-0ä¹‹å‰ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ"><a href="#Redis-6-0ä¹‹å‰ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ" class="headerlink" title="Redis 6.0ä¹‹å‰ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ"></a>Redis 6.0ä¹‹å‰ä¸ºä»€ä¹ˆä½¿ç”¨å•çº¿ç¨‹ï¼Ÿ</h2><ul><li><strong>CPU å¹¶ä¸æ˜¯åˆ¶çº¦ Redis æ€§èƒ½è¡¨ç°çš„ç“¶é¢ˆæ‰€åœ¨</strong>ï¼Œæ›´å¤šæƒ…å†µä¸‹æ˜¯å—åˆ°å†…å­˜å¤§å°å’Œç½‘ç»œI&#x2F;Oçš„é™åˆ¶ï¼Œæ‰€ä»¥ Redis æ ¸å¿ƒç½‘ç»œæ¨¡å‹ä½¿ç”¨å•çº¿ç¨‹å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜</li><li>ä½¿ç”¨äº†å•çº¿ç¨‹åï¼Œå¯ç»´æŠ¤æ€§é«˜ï¼Œå¤šçº¿ç¨‹æ¨¡å‹è™½ç„¶åœ¨æŸäº›æ–¹é¢è¡¨ç°ä¼˜å¼‚ï¼Œä½†æ˜¯å®ƒå´å¼•å…¥äº†ç¨‹åºæ‰§è¡Œé¡ºåºçš„ä¸ç¡®å®šæ€§ï¼Œå¸¦æ¥äº†å¹¶å‘è¯»å†™çš„ä¸€ç³»åˆ—é—®é¢˜ï¼Œ<strong>å¢åŠ äº†ç³»ç»Ÿå¤æ‚åº¦ã€åŒæ—¶å¯èƒ½å­˜åœ¨çº¿ç¨‹åˆ‡æ¢ã€ç”šè‡³åŠ é”è§£é”ã€æ­»é”é€ æˆçš„æ€§èƒ½æŸè€—</strong>ã€‚</li></ul><h2 id="Redis-6-0ä¹‹åä¸ºä»€ä¹ˆå¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ"><a href="#Redis-6-0ä¹‹åä¸ºä»€ä¹ˆå¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ" class="headerlink" title="Redis 6.0ä¹‹åä¸ºä»€ä¹ˆå¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ"></a>Redis 6.0ä¹‹åä¸ºä»€ä¹ˆå¼•å…¥äº†å¤šçº¿ç¨‹ï¼Ÿ</h2><ul><li>åœ¨ Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼Œä¹Ÿ<strong>é‡‡ç”¨äº†å¤šä¸ª I&#x2F;O çº¿ç¨‹æ¥å¤„ç†ç½‘ç»œè¯·æ±‚</strong>ï¼Œ<strong>è¿™æ˜¯å› ä¸ºéšç€ç½‘ç»œç¡¬ä»¶çš„æ€§èƒ½æå‡ï¼ŒRedis çš„æ€§èƒ½ç“¶é¢ˆæœ‰æ—¶ä¼šå‡ºç°åœ¨ç½‘ç»œ I&#x2F;O çš„å¤„ç†ä¸Šã€‚</strong>ä½†æ˜¯å¯¹äºå‘½ä»¤çš„æ‰§è¡Œï¼ŒRedis ä»ç„¶ä½¿ç”¨å•çº¿ç¨‹æ¥å¤„ç†**</li></ul><p> Redis 6.0 ç‰ˆæœ¬ä¹‹åï¼ŒRedis åœ¨å¯åŠ¨çš„æ—¶å€™ï¼Œé»˜è®¤æƒ…å†µä¸‹ä¼š<strong>é¢å¤–åˆ›å»º 6 ä¸ªçº¿ç¨‹</strong></p><ul><li>Redis-server ï¼š Redisçš„ä¸»çº¿ç¨‹ï¼Œä¸»è¦è´Ÿè´£æ‰§è¡Œå‘½ä»¤ï¼›</li><li>bio_close_fileã€bio_aof_fsyncã€bio_lazy_freeï¼šä¸‰ä¸ªåå°çº¿ç¨‹ï¼Œåˆ†åˆ«å¼‚æ­¥å¤„ç†å…³é—­æ–‡ä»¶ä»»åŠ¡ã€AOFåˆ·ç›˜ä»»åŠ¡ã€é‡Šæ”¾å†…å­˜ä»»åŠ¡ï¼›</li><li>io_thd_1ã€io_thd_2ã€io_thd_3ï¼šä¸‰ä¸ª I&#x2F;O çº¿ç¨‹ï¼ŒI&#x2F;O å¤šçº¿ç¨‹ï¼Œç”¨æ¥åˆ†æ‹… Redis ç½‘ç»œ I&#x2F;O çš„å‹åŠ›ã€‚</li></ul><h2 id="Rediså¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°æ•°æ®ä¸ä¸¢å¤±ï¼Ÿ</h2><p>ä¸ºäº†ä¿è¯å†…å­˜ä¸­çš„æ•°æ®ä¸ä¼šä¸¢å¤±ï¼ŒRedis å®ç°äº†æ•°æ®æŒä¹…åŒ–çš„æœºåˆ¶ï¼Œè¿™ä¸ªæœºåˆ¶ä¼šæŠŠæ•°æ®å­˜å‚¨åˆ°ç£ç›˜ï¼Œè¿™æ ·åœ¨ Redis é‡å¯å°±èƒ½å¤Ÿä»ç£ç›˜ä¸­æ¢å¤åŸæœ‰çš„æ•°æ®ã€‚</p><p>ä¸‰ç§æ•°æ®æŒä¹…åŒ–çš„æ–¹å¼ï¼š</p><ul><li><strong>AOF æ—¥å¿—</strong>ï¼šæ¯æ‰§è¡Œä¸€æ¡å†™æ“ä½œå‘½ä»¤ï¼Œå°±æŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼›</li><li><strong>RDB å¿«ç…§</strong>ï¼šå°†æŸä¸€æ—¶åˆ»çš„å†…å­˜æ•°æ®ï¼Œä»¥äºŒè¿›åˆ¶çš„æ–¹å¼å†™å…¥ç£ç›˜ï¼›</li><li><strong>æ··åˆæŒä¹…åŒ–æ–¹å¼</strong>ï¼šRedis 4.0 æ–°å¢çš„æ–¹å¼ï¼Œé›†æˆäº† AOF å’Œ RBD çš„ä¼˜ç‚¹ï¼›</li></ul><h2 id="AOFæ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ"><a href="#AOFæ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ" class="headerlink" title="AOFæ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ"></a>AOFæ—¥å¿—æ˜¯å¦‚ä½•å®ç°çš„ï¼Ÿ</h2><p>Redis åœ¨æ‰§è¡Œå®Œä¸€æ¡å†™æ“ä½œå‘½ä»¤åï¼Œå°±ä¼šæŠŠè¯¥å‘½ä»¤ä»¥è¿½åŠ çš„æ–¹å¼å†™å…¥åˆ°ä¸€ä¸ªæ–‡ä»¶é‡Œï¼Œç„¶å Redis é‡å¯æ—¶ï¼Œä¼šè¯»å–è¯¥æ–‡ä»¶è®°å½•çš„å‘½ä»¤ï¼Œç„¶åé€ä¸€æ‰§è¡Œå‘½ä»¤çš„æ–¹å¼æ¥è¿›è¡Œæ•°æ®æ¢å¤ã€‚</p><h2 id="ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œå†æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œå†æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œå†æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿ"></a>ä¸ºä»€ä¹ˆå…ˆæ‰§è¡Œå‘½ä»¤ï¼Œå†æŠŠæ•°æ®å†™å…¥æ—¥å¿—å‘¢ï¼Ÿ</h2><ul><li><strong>é¿å…é¢å¤–çš„æ£€æŸ¥å¼€é”€</strong>ï¼šå› ä¸ºå¦‚æœå…ˆå°†å†™æ“ä½œå‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—é‡Œï¼Œå†æ‰§è¡Œè¯¥å‘½ä»¤çš„è¯ï¼Œå¦‚æœå½“å‰çš„å‘½ä»¤è¯­æ³•æœ‰é—®é¢˜ï¼Œé‚£ä¹ˆå¦‚æœä¸è¿›è¡Œå‘½ä»¤è¯­æ³•æ£€æŸ¥ï¼Œè¯¥é”™è¯¯çš„å‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—é‡Œåï¼ŒRedis åœ¨ä½¿ç”¨æ—¥å¿—æ¢å¤æ•°æ®æ—¶ï¼Œå°±å¯èƒ½ä¼šå‡ºé”™ã€‚</li><li><strong>ä¸ä¼šé˜»å¡å½“å‰å†™æ“ä½œå‘½ä»¤çš„æ‰§è¡Œ</strong>ï¼šå› ä¸ºå½“å†™æ“ä½œå‘½ä»¤æ‰§è¡ŒæˆåŠŸåï¼Œæ‰ä¼šå°†å‘½ä»¤è®°å½•åˆ° AOF æ—¥å¿—ã€‚</li></ul><h2 id="AOF-å†™å›ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"><a href="#AOF-å†™å›ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ" class="headerlink" title="AOF å†™å›ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ"></a>AOF å†™å›ç­–ç•¥æœ‰å‡ ç§ï¼Ÿ</h2><ul><li><strong>Always</strong>ï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ€»æ˜¯ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼ŒåŒæ­¥å°† AOF æ—¥å¿—æ•°æ®å†™å›ç¡¬ç›˜ï¼›</li><li><strong>Everysec</strong>ï¼Œè¿™ä¸ªå•è¯çš„æ„æ€æ˜¯ã€Œæ¯ç§’ã€ï¼Œæ‰€ä»¥å®ƒçš„æ„æ€æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œç„¶åæ¯éš”ä¸€ç§’å°†ç¼“å†²åŒºé‡Œçš„å†…å®¹å†™å›åˆ°ç¡¬ç›˜ï¼›</li><li><strong>No</strong>ï¼Œæ„å‘³ç€ä¸ç”± Redis æ§åˆ¶å†™å›ç¡¬ç›˜çš„æ—¶æœºï¼Œè½¬äº¤ç»™æ“ä½œç³»ç»Ÿæ§åˆ¶å†™å›çš„æ—¶æœºï¼Œä¹Ÿå°±æ˜¯æ¯æ¬¡å†™æ“ä½œå‘½ä»¤æ‰§è¡Œå®Œåï¼Œå…ˆå°†å‘½ä»¤å†™å…¥åˆ° AOF æ–‡ä»¶çš„å†…æ ¸ç¼“å†²åŒºï¼Œå†ç”±æ“ä½œç³»ç»Ÿå†³å®šä½•æ—¶å°†ç¼“å†²åŒºå†…å®¹å†™å›ç¡¬ç›˜ã€‚</li></ul><h2 id="AOF-æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶"><a href="#AOF-æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶" class="headerlink" title="AOF æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶?"></a>AOF æ—¥å¿—è¿‡å¤§ï¼Œä¼šè§¦å‘ä»€ä¹ˆæœºåˆ¶?</h2><p>AOF æ—¥å¿—æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œéšç€æ‰§è¡Œçš„å†™æ“ä½œå‘½ä»¤è¶Šæ¥è¶Šå¤šï¼Œæ–‡ä»¶çš„å¤§å°ä¼šè¶Šæ¥è¶Šå¤§ã€‚ å¦‚æœå½“ AOF æ—¥å¿—æ–‡ä»¶è¿‡å¤§å°±ä¼šå¸¦æ¥æ€§èƒ½é—®é¢˜ï¼Œæ¯”å¦‚é‡å¯ Redis åï¼Œéœ€è¦è¯» AOF æ–‡ä»¶çš„å†…å®¹ä»¥æ¢å¤æ•°æ®ï¼Œå¦‚æœæ–‡ä»¶è¿‡å¤§ï¼Œæ•´ä¸ªæ¢å¤çš„è¿‡ç¨‹å°±ä¼šå¾ˆæ…¢ã€‚</p><p>AOF é‡å†™æœºåˆ¶æ˜¯åœ¨é‡å†™æ—¶ï¼Œè¯»å–å½“å‰æ•°æ®åº“ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œç„¶åå°†æ¯ä¸€ä¸ªé”®å€¼å¯¹ç”¨ä¸€æ¡å‘½ä»¤è®°å½•åˆ°ã€Œæ–°çš„ AOF æ–‡ä»¶ã€ï¼Œç­‰åˆ°å…¨éƒ¨è®°å½•å®Œåï¼Œå°±å°†æ–°çš„ AOF æ–‡ä»¶æ›¿æ¢æ‰ç°æœ‰çš„ AOF æ–‡ä»¶ã€‚</p><h2 id="AOFé‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²å­˜åœ¨çš„key-valueå¯¹ï¼Œå‡ºç°çš„è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ"><a href="#AOFé‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²å­˜åœ¨çš„key-valueå¯¹ï¼Œå‡ºç°çš„è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ" class="headerlink" title="AOFé‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²å­˜åœ¨çš„key-valueå¯¹ï¼Œå‡ºç°çš„è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ"></a>AOFé‡å†™æœŸé—´ï¼Œä¸»è¿›ç¨‹ä¿®æ”¹äº†å·²å­˜åœ¨çš„key-valueå¯¹ï¼Œå‡ºç°çš„è¿™ç§æ•°æ®ä¸ä¸€è‡´é—®é¢˜å¦‚ä½•è§£å†³ï¼Ÿ</h2><p>Redis è®¾ç½®äº†ä¸€ä¸ª <strong>AOF é‡å†™ç¼“å†²åŒº</strong>ï¼Œè¿™ä¸ªç¼“å†²åŒºåœ¨åˆ›å»º bgrewriteaof å­è¿›ç¨‹ä¹‹åå¼€å§‹ä½¿ç”¨ã€‚</p><p>åœ¨é‡å†™ AOF æœŸé—´ï¼Œå½“ Redis æ‰§è¡Œå®Œä¸€ä¸ªå†™å‘½ä»¤ä¹‹åï¼Œå®ƒä¼š<strong>åŒæ—¶å°†è¿™ä¸ªå†™å‘½ä»¤å†™å…¥åˆ° ã€ŒAOF ç¼“å†²åŒºã€å’Œ ã€ŒAOF é‡å†™ç¼“å†²åŒºã€</strong>ã€‚</p><p>å½“å­è¿›ç¨‹å®Œæˆ AOF é‡å†™å·¥ä½œåï¼Œä¼šå‘ä¸»è¿›ç¨‹å‘é€ä¸€æ¡ä¿¡å·ï¼Œä¸»è¿›ç¨‹æ”¶åˆ°è¯¥ä¿¡å·åï¼Œä¼šè°ƒç”¨ä¸€ä¸ªä¿¡å·å¤„ç†å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¸»è¦åšä»¥ä¸‹å·¥ä½œï¼š</p><ul><li>å°† AOF é‡å†™ç¼“å†²åŒºä¸­çš„æ‰€æœ‰å†…å®¹è¿½åŠ åˆ°æ–°çš„ AOF çš„æ–‡ä»¶ä¸­ï¼Œä½¿å¾—æ–°æ—§ä¸¤ä¸ª AOF æ–‡ä»¶æ‰€ä¿å­˜çš„æ•°æ®åº“çŠ¶æ€ä¸€è‡´ï¼›</li><li>æ–°çš„ AOF çš„æ–‡ä»¶è¿›è¡Œæ”¹åï¼Œè¦†ç›–ç°æœ‰çš„ AOF æ–‡ä»¶ã€‚</li></ul><h2 id="RDBå¿«ç…§æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ"><a href="#RDBå¿«ç…§æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ" class="headerlink" title="RDBå¿«ç…§æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ"></a>RDBå¿«ç…§æ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼Ÿ</h2><p>RDB å¿«ç…§å°±æ˜¯è®°å½•æŸä¸€ä¸ªç¬é—´çš„å†…å­˜æ•°æ®ï¼Œè®°å½•çš„æ˜¯å®é™…æ•°æ®ï¼Œè€Œ AOF æ–‡ä»¶è®°å½•çš„æ˜¯å‘½ä»¤æ“ä½œçš„æ—¥å¿—ï¼Œè€Œä¸æ˜¯å®é™…çš„æ•°æ®ã€‚å› æ­¤åœ¨ Redis æ¢å¤æ•°æ®æ—¶ï¼Œ RDB æ¢å¤æ•°æ®çš„æ•ˆç‡ä¼šæ¯” AOF é«˜äº›ï¼Œå› ä¸ºç›´æ¥å°† RDB æ–‡ä»¶è¯»å…¥å†…å­˜å°±å¯ä»¥ï¼Œä¸éœ€è¦åƒ AOF é‚£æ ·è¿˜éœ€è¦é¢å¤–æ‰§è¡Œæ“ä½œå‘½ä»¤çš„æ­¥éª¤æ‰èƒ½æ¢å¤æ•°æ®ã€‚</p><h2 id="RDBåšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ"><a href="#RDBåšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ" class="headerlink" title="RDBåšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ"></a>RDBåšå¿«ç…§æ—¶ä¼šé˜»å¡çº¿ç¨‹å—ï¼Ÿ</h2><p>Redis æä¾›äº†ä¸¤ä¸ªå‘½ä»¤æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œåˆ†åˆ«æ˜¯ save å’Œ bgsaveï¼Œä»–ä»¬çš„åŒºåˆ«å°±åœ¨äºæ˜¯å¦åœ¨ã€Œä¸»çº¿ç¨‹ã€é‡Œæ‰§è¡Œ</p><ul><li>æ‰§è¡Œäº† save å‘½ä»¤ï¼Œå°±ä¼šåœ¨ä¸»çº¿ç¨‹ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œç”±äºå’Œæ‰§è¡Œæ“ä½œå‘½ä»¤åœ¨åŒä¸€ä¸ªçº¿ç¨‹ï¼Œæ‰€ä»¥å¦‚æœå†™å…¥ RDB æ–‡ä»¶çš„æ—¶é—´å¤ªé•¿ï¼Œ<strong>ä¼šé˜»å¡ä¸»çº¿ç¨‹</strong>ï¼›</li><li>æ‰§è¡Œäº† bgsave å‘½ä»¤ï¼Œä¼šåˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥ç”Ÿæˆ RDB æ–‡ä»¶ï¼Œè¿™æ ·å¯ä»¥<strong>é¿å…ä¸»çº¿ç¨‹çš„é˜»å¡</strong>ï¼›</li></ul><h2 id="RDBåœ¨æ‰§è¡Œå¿«ç…§çš„æ—¶å€™ï¼Œæ•°æ®èƒ½ä¿®æ”¹å—ï¼Ÿ"><a href="#RDBåœ¨æ‰§è¡Œå¿«ç…§çš„æ—¶å€™ï¼Œæ•°æ®èƒ½ä¿®æ”¹å—ï¼Ÿ" class="headerlink" title="RDBåœ¨æ‰§è¡Œå¿«ç…§çš„æ—¶å€™ï¼Œæ•°æ®èƒ½ä¿®æ”¹å—ï¼Ÿ"></a>RDBåœ¨æ‰§è¡Œå¿«ç…§çš„æ—¶å€™ï¼Œæ•°æ®èƒ½ä¿®æ”¹å—ï¼Ÿ</h2><p>å¯ä»¥çš„ï¼Œæ‰§è¡Œ bgsave è¿‡ç¨‹ä¸­ï¼ŒRedis ä¾ç„¶<strong>å¯ä»¥ç»§ç»­å¤„ç†æ“ä½œå‘½ä»¤</strong>çš„ï¼Œä¹Ÿå°±æ˜¯æ•°æ®æ˜¯èƒ½è¢«ä¿®æ”¹çš„ï¼Œå…³é”®çš„æŠ€æœ¯å°±åœ¨äº<strong>å†™æ—¶å¤åˆ¶æŠ€æœ¯ï¼ˆCopy-On-Write, COWï¼‰ã€‚</strong>æ‰§è¡Œ bgsave å‘½ä»¤çš„æ—¶å€™ï¼Œä¼šé€šè¿‡ fork() åˆ›å»ºå­è¿›ç¨‹ï¼Œæ­¤æ—¶å­è¿›ç¨‹å’Œçˆ¶è¿›ç¨‹æ˜¯å…±äº«åŒä¸€ç‰‡å†…å­˜æ•°æ®çš„ï¼Œå› ä¸ºåˆ›å»ºå­è¿›ç¨‹çš„æ—¶å€™ï¼Œä¼šå¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ï¼Œä½†æ˜¯é¡µè¡¨æŒ‡å‘çš„ç‰©ç†å†…å­˜è¿˜æ˜¯ä¸€ä¸ªï¼Œæ­¤æ—¶å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œè¯»æ“ä½œï¼Œåˆ™ä¸»çº¿ç¨‹å’Œ bgsave å­è¿›ç¨‹äº’ç›¸ä¸å½±å“ã€‚å¦‚æœä¸»çº¿ç¨‹æ‰§è¡Œå†™æ“ä½œï¼Œåˆ™è¢«ä¿®æ”¹çš„æ•°æ®ä¼šå¤åˆ¶ä¸€ä»½å‰¯æœ¬ï¼Œç„¶å bgsave å­è¿›ç¨‹ä¼šæŠŠè¯¥å‰¯æœ¬æ•°æ®å†™å…¥ RDB æ–‡ä»¶ï¼Œåœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œä¸»çº¿ç¨‹ä»ç„¶å¯ä»¥ç›´æ¥ä¿®æ”¹åŸæ¥çš„æ•°æ®ã€‚</p><h2 id="ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼šæœ‰æ··åˆæŒä¹…åŒ–ï¼Ÿ</h2><ul><li>RDB ä¼˜ç‚¹æ˜¯æ•°æ®æ¢å¤é€Ÿåº¦å¿«ï¼Œä½†æ˜¯å¿«ç…§çš„é¢‘ç‡ä¸å¥½æŠŠæ¡ã€‚é¢‘ç‡å¤ªä½ï¼Œä¸¢å¤±çš„æ•°æ®å°±ä¼šæ¯”è¾ƒå¤šï¼Œé¢‘ç‡å¤ªé«˜ï¼Œå°±ä¼šå½±å“æ€§èƒ½ã€‚AOF ä¼˜ç‚¹æ˜¯ä¸¢å¤±æ•°æ®å°‘ï¼Œä½†æ˜¯æ•°æ®æ¢å¤ä¸å¿«ã€‚æ··åˆæŒä¹…åŒ–æ—¢ä¿è¯äº† Redis é‡å¯é€Ÿåº¦ï¼Œåˆé™ä½æ•°æ®ä¸¢å¤±é£é™©ã€‚</li></ul><p>ä½¿ç”¨äº†æ··åˆæŒä¹…åŒ–ï¼ŒAOF æ–‡ä»¶çš„<strong>å‰åŠéƒ¨åˆ†æ˜¯ RDB æ ¼å¼çš„å…¨é‡æ•°æ®ï¼ŒååŠéƒ¨åˆ†æ˜¯ AOF æ ¼å¼çš„å¢é‡æ•°æ®</strong>ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>æ··åˆæŒä¹…åŒ–ç»“åˆäº† RDB å’Œ AOF æŒä¹…åŒ–çš„ä¼˜ç‚¹ï¼Œå¼€å¤´ä¸º RDB çš„æ ¼å¼ï¼Œä½¿å¾— Redis å¯ä»¥æ›´å¿«çš„å¯åŠ¨ï¼ŒåŒæ—¶ç»“åˆ AOF çš„ä¼˜ç‚¹ï¼Œæœ‰å‡ä½äº†å¤§é‡æ•°æ®ä¸¢å¤±çš„é£é™©ã€‚</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li>AOF æ–‡ä»¶ä¸­æ·»åŠ äº† RDB æ ¼å¼çš„å†…å®¹ï¼Œä½¿å¾— AOF æ–‡ä»¶çš„å¯è¯»æ€§å˜å¾—å¾ˆå·®ï¼›</li><li>å…¼å®¹æ€§å·®ï¼Œå¦‚æœå¼€å¯æ··åˆæŒä¹…åŒ–ï¼Œé‚£ä¹ˆæ­¤æ··åˆæŒä¹…åŒ– AOF æ–‡ä»¶ï¼Œå°±ä¸èƒ½ç”¨åœ¨ Redis 4.0 ä¹‹å‰ç‰ˆæœ¬äº†ã€‚</li></ul><h2 id="å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ"><a href="#å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ" class="headerlink" title="å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ"></a>å¦‚ä½•å®ç°æœåŠ¡é«˜å¯ç”¨ï¼Ÿ</h2><p>è¦æƒ³è®¾è®¡ä¸€ä¸ªé«˜å¯ç”¨çš„ Redis æœåŠ¡ï¼Œä¸€å®šè¦ä» Redis çš„å¤šæœåŠ¡èŠ‚ç‚¹æ¥è€ƒè™‘ï¼Œæ¯”å¦‚ Redis çš„ä¸»ä»å¤åˆ¶ã€å“¨å…µæ¨¡å¼ã€åˆ‡ç‰‡é›†ç¾¤ã€‚</p><h2 id="è§£é‡Šä¸€ä¸‹è„‘è£‚ç°è±¡ï¼Œå¦‚ä½•è§£å†³æœ‰å…¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ"><a href="#è§£é‡Šä¸€ä¸‹è„‘è£‚ç°è±¡ï¼Œå¦‚ä½•è§£å†³æœ‰å…¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ" class="headerlink" title="è§£é‡Šä¸€ä¸‹è„‘è£‚ç°è±¡ï¼Œå¦‚ä½•è§£å†³æœ‰å…¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ"></a>è§£é‡Šä¸€ä¸‹è„‘è£‚ç°è±¡ï¼Œå¦‚ä½•è§£å†³æœ‰å…¶å¯¼è‡´çš„æ•°æ®ä¸¢å¤±é—®é¢˜å‘¢ï¼Ÿ</h2><p>ç”±äºç½‘ç»œé—®é¢˜ï¼Œé›†ç¾¤èŠ‚ç‚¹ä¹‹é—´å¤±å»è”ç³»ã€‚ä¸»ä»æ•°æ®ä¸åŒæ­¥ï¼›é‡æ–°å¹³è¡¡é€‰ä¸¾ï¼Œäº§ç”Ÿä¸¤ä¸ªä¸»æœåŠ¡ã€‚ç­‰ç½‘ç»œæ¢å¤ï¼Œæ—§ä¸»èŠ‚ç‚¹ä¼šé™çº§ä¸ºä»èŠ‚ç‚¹ï¼Œå†ä¸æ–°ä¸»èŠ‚ç‚¹è¿›è¡ŒåŒæ­¥å¤åˆ¶çš„æ—¶å€™ï¼Œç”±äºä¼šä»èŠ‚ç‚¹ä¼šæ¸…ç©ºè‡ªå·±çš„ç¼“å†²åŒºï¼Œæ‰€ä»¥å¯¼è‡´ä¹‹å‰å®¢æˆ·ç«¯å†™å…¥çš„æ•°æ®ä¸¢å¤±äº†ã€‚</p><p>è§£å†³æ–¹æ¡ˆï¼šå½“ä¸»èŠ‚ç‚¹å‘ç°ä»èŠ‚ç‚¹è¿æ¥çš„æ€»æ•°é‡å°äºé˜ˆå€¼æˆ–è€…é€šä¿¡è¶…æ—¶ï¼Œé‚£ä¹ˆç¦æ­¢ä¸»èŠ‚ç‚¹è¿›è¡Œå†™æ•°æ®ï¼Œç›´æ¥æŠŠé”™è¯¯è¿”å›ç»™å®¢æˆ·ç«¯ã€‚</p><h2 id="è¿‡æœŸåˆ é™¤ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"><a href="#è¿‡æœŸåˆ é™¤ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="è¿‡æœŸåˆ é™¤ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"></a>è¿‡æœŸåˆ é™¤ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>å®šæ—¶åˆ é™¤ï¼š<strong>åœ¨è®¾ç½® key çš„è¿‡æœŸæ—¶é—´æ—¶ï¼ŒåŒæ—¶åˆ›å»ºä¸€ä¸ªå®šæ—¶äº‹ä»¶ï¼Œå½“æ—¶é—´åˆ°è¾¾æ—¶ï¼Œç”±äº‹ä»¶å¤„ç†å™¨è‡ªåŠ¨æ‰§è¡Œ key çš„åˆ é™¤æ“ä½œã€‚</strong><ul><li>ä¼˜ç‚¹<ul><li>å¯ä»¥ä¿è¯è¿‡æœŸ key ä¼šè¢«å°½å¿«åˆ é™¤ï¼Œä¹Ÿå°±æ˜¯å†…å­˜å¯ä»¥è¢«å°½å¿«åœ°é‡Šæ”¾ã€‚å› æ­¤ï¼Œå®šæ—¶åˆ é™¤å¯¹å†…å­˜æ˜¯æœ€å‹å¥½çš„ã€‚</li></ul></li><li>ç¼ºç‚¹<ul><li>åœ¨è¿‡æœŸ key æ¯”è¾ƒå¤šçš„æƒ…å†µä¸‹ï¼Œåˆ é™¤è¿‡æœŸ key å¯èƒ½ä¼šå ç”¨ç›¸å½“ä¸€éƒ¨åˆ† CPU æ—¶é—´ï¼Œåœ¨å†…å­˜ä¸ç´§å¼ ä½† CPU æ—¶é—´ç´§å¼ çš„æƒ…å†µä¸‹ï¼Œå°† CPU æ—¶é—´ç”¨äºåˆ é™¤å’Œå½“å‰ä»»åŠ¡æ— å…³çš„è¿‡æœŸé”®ä¸Šï¼Œæ— ç–‘ä¼šå¯¹æœåŠ¡å™¨çš„å“åº”æ—¶é—´å’Œååé‡é€ æˆå½±å“ã€‚æ‰€ä»¥ï¼Œå®šæ—¶åˆ é™¤ç­–ç•¥å¯¹ CPU ä¸å‹å¥½ã€‚</li></ul></li></ul></li><li>æƒ°æ€§åˆ é™¤ï¼š<strong>ä¸ä¸»åŠ¨åˆ é™¤è¿‡æœŸé”®ï¼Œæ¯æ¬¡ä»æ•°æ®åº“è®¿é—® key æ—¶ï¼Œéƒ½æ£€æµ‹ key æ˜¯å¦è¿‡æœŸï¼Œå¦‚æœè¿‡æœŸåˆ™åˆ é™¤è¯¥ keyã€‚</strong><ul><li>ä¼˜ç‚¹<ul><li>å› ä¸ºæ¯æ¬¡è®¿é—®æ—¶ï¼Œæ‰ä¼šæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸï¼Œæ‰€ä»¥æ­¤ç­–ç•¥åªä¼šä½¿ç”¨å¾ˆå°‘çš„ç³»ç»Ÿèµ„æºï¼Œå› æ­¤ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹ CPU æ—¶é—´æœ€å‹å¥½ã€‚</li></ul></li><li>ç¼ºç‚¹<ul><li>å¦‚æœä¸€ä¸ª key å·²ç»è¿‡æœŸï¼Œè€Œè¿™ä¸ª key åˆä»ç„¶ä¿ç•™åœ¨æ•°æ®åº“ä¸­ï¼Œé‚£ä¹ˆåªè¦è¿™ä¸ªè¿‡æœŸ key ä¸€ç›´æ²¡æœ‰è¢«è®¿é—®ï¼Œå®ƒæ‰€å ç”¨çš„å†…å­˜å°±ä¸ä¼šé‡Šæ”¾ï¼Œé€ æˆäº†ä¸€å®šçš„å†…å­˜ç©ºé—´æµªè´¹ã€‚æ‰€ä»¥ï¼Œæƒ°æ€§åˆ é™¤ç­–ç•¥å¯¹å†…å­˜ä¸å‹å¥½ã€‚</li></ul></li></ul></li><li>å®šæœŸåˆ é™¤ï¼š<strong>æ¯éš”ä¸€æ®µæ—¶é—´ã€Œéšæœºã€ä»æ•°æ®åº“ä¸­å–å‡ºä¸€å®šæ•°é‡çš„ key è¿›è¡Œæ£€æŸ¥ï¼Œå¹¶åˆ é™¤å…¶ä¸­çš„è¿‡æœŸkeyã€‚</strong><ul><li>ä¼˜ç‚¹<ul><li>é€šè¿‡é™åˆ¶åˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ï¼Œæ¥å‡å°‘åˆ é™¤æ“ä½œå¯¹ CPU çš„å½±å“ï¼ŒåŒæ—¶ä¹Ÿèƒ½åˆ é™¤ä¸€éƒ¨åˆ†è¿‡æœŸçš„æ•°æ®å‡å°‘äº†è¿‡æœŸé”®å¯¹ç©ºé—´çš„æ— æ•ˆå ç”¨ã€‚</li></ul></li><li>ç¼ºç‚¹<ul><li>å†…å­˜æ¸…ç†æ–¹é¢æ²¡æœ‰å®šæ—¶åˆ é™¤æ•ˆæœå¥½ï¼ŒåŒæ—¶æ²¡æœ‰æƒ°æ€§åˆ é™¤ä½¿ç”¨çš„ç³»ç»Ÿèµ„æºå°‘ã€‚</li><li>éš¾ä»¥ç¡®å®šåˆ é™¤æ“ä½œæ‰§è¡Œçš„æ—¶é•¿å’Œé¢‘ç‡ã€‚å¦‚æœæ‰§è¡Œçš„å¤ªé¢‘ç¹ï¼Œå®šæœŸåˆ é™¤ç­–ç•¥å˜å¾—å’Œå®šæ—¶åˆ é™¤ç­–ç•¥ä¸€æ ·ï¼Œå¯¹CPUä¸å‹å¥½ï¼›å¦‚æœæ‰§è¡Œçš„å¤ªå°‘ï¼Œé‚£åˆå’Œæƒ°æ€§åˆ é™¤ä¸€æ ·äº†ï¼Œè¿‡æœŸ key å ç”¨çš„å†…å­˜ä¸ä¼šåŠæ—¶å¾—åˆ°é‡Šæ”¾ã€‚</li></ul></li></ul></li></ul><h2 id="Redisä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ"><a href="#Redisä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ" class="headerlink" title="Redisä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ"></a>Redisä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ä»€ä¹ˆï¼Ÿ</h2><p>Redis ä½¿ç”¨çš„è¿‡æœŸåˆ é™¤ç­–ç•¥æ˜¯ã€Œ<strong>æƒ°æ€§åˆ é™¤+å®šæœŸåˆ é™¤</strong>ã€è¿™ä¸¤ç§ç­–ç•¥é…å’Œä½¿ç”¨ã€‚ä»¥æ±‚åœ¨åˆç†ä½¿ç”¨ CPU æ—¶é—´å’Œé¿å…å†…å­˜æµªè´¹ä¹‹é—´å–å¾—å¹³è¡¡ã€‚</p><h2 id="Rediså¦‚ä½•å®ç°æƒ°æ€§åˆ é™¤çš„ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°æƒ°æ€§åˆ é™¤çš„ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°æƒ°æ€§åˆ é™¤çš„ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°æƒ°æ€§åˆ é™¤çš„ï¼Ÿ</h2><ul><li>Redis åœ¨è®¿é—®æˆ–è€…ä¿®æ”¹ key ä¹‹å‰ï¼Œéƒ½ä¼šè°ƒç”¨ expireIfNeeded å‡½æ•°å¯¹å…¶è¿›è¡Œæ£€æŸ¥ï¼Œæ£€æŸ¥ key æ˜¯å¦è¿‡æœŸ</li><li>å¦‚æœè¿‡æœŸï¼Œåˆ™åˆ é™¤è¯¥ keyï¼Œç„¶åè¿”å› null å®¢æˆ·ç«¯ï¼›</li><li>å¦‚æœæ²¡æœ‰è¿‡æœŸï¼Œä¸åšä»»ä½•å¤„ç†ï¼Œç„¶åè¿”å›æ­£å¸¸çš„é”®å€¼å¯¹ç»™å®¢æˆ·ç«¯ï¼›</li></ul><h2 id="Rediså¦‚ä½•å®ç°å®šæœŸåˆ é™¤çš„ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°å®šæœŸåˆ é™¤çš„ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°å®šæœŸåˆ é™¤çš„ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°å®šæœŸåˆ é™¤çš„ï¼Ÿ</h2><ul><li>ä»è¿‡æœŸå­—å…¸ä¸­éšæœºæŠ½å– 20 ä¸ª keyï¼›</li><li>æ£€æŸ¥è¿™ 20 ä¸ª key æ˜¯å¦è¿‡æœŸï¼Œå¹¶åˆ é™¤å·²è¿‡æœŸçš„ keyï¼›</li><li>å¦‚æœæœ¬è½®æ£€æŸ¥çš„å·²è¿‡æœŸ key çš„æ•°é‡ï¼Œè¶…è¿‡ 5 ä¸ªï¼ˆ20&#x2F;4ï¼‰ï¼Œä¹Ÿå°±æ˜¯ã€Œå·²è¿‡æœŸ key çš„æ•°é‡ã€å æ¯”ã€ŒéšæœºæŠ½å– key çš„æ•°é‡ã€å¤§äº 25%ï¼Œåˆ™ç»§ç»­é‡å¤æ­¥éª¤ 1ï¼›å¦‚æœå·²è¿‡æœŸçš„ key æ¯”ä¾‹å°äº 25%ï¼Œåˆ™åœæ­¢ç»§ç»­åˆ é™¤è¿‡æœŸ keyï¼Œç„¶åç­‰å¾…ä¸‹ä¸€è½®å†æ£€æŸ¥ã€‚</li></ul><p>Redis ä¸ºäº†ä¿è¯å®šæœŸåˆ é™¤ä¸ä¼šå‡ºç°å¾ªç¯è¿‡åº¦ï¼Œå¯¼è‡´çº¿ç¨‹å¡æ­»ç°è±¡ï¼Œä¸ºæ­¤å¢åŠ äº†å®šæœŸåˆ é™¤å¾ªç¯æµç¨‹çš„æ—¶é—´ä¸Šé™ï¼Œé»˜è®¤ä¸ä¼šè¶…è¿‡ 25msã€‚</p><h2 id="RedisæŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#RedisæŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="RedisæŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ"></a>RedisæŒä¹…åŒ–æ—¶ï¼Œå¯¹è¿‡æœŸé”®ä¼šå¦‚ä½•å¤„ç†ï¼Ÿ</h2><p>å¯¹äºRDBæ–‡ä»¶æ¥è¯´ï¼Œåˆ†ä¸ºç”Ÿæˆé˜¶æ®µå’ŒåŠ è½½é˜¶æ®µ</p><ul><li><strong>RDB æ–‡ä»¶ç”Ÿæˆé˜¶æ®µ</strong>ï¼šä»å†…å­˜çŠ¶æ€æŒä¹…åŒ–æˆ RDBï¼ˆæ–‡ä»¶ï¼‰çš„æ—¶å€™ï¼Œä¼šå¯¹ key è¿›è¡Œè¿‡æœŸæ£€æŸ¥ï¼Œ<strong>è¿‡æœŸçš„é”®ã€Œä¸ä¼šã€è¢«ä¿å­˜åˆ°æ–°çš„ RDB æ–‡ä»¶ä¸­</strong>ï¼Œå› æ­¤ Redis ä¸­çš„è¿‡æœŸé”®ä¸ä¼šå¯¹ç”Ÿæˆæ–° RDB æ–‡ä»¶äº§ç”Ÿä»»ä½•å½±å“ã€‚</li><li><strong>RDB åŠ è½½é˜¶æ®µ</strong><ul><li><strong>å¦‚æœ Redis æ˜¯ã€Œä¸»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œç¨‹åºä¼šå¯¹æ–‡ä»¶ä¸­ä¿å­˜çš„é”®è¿›è¡Œæ£€æŸ¥ï¼Œè¿‡æœŸé”®ã€Œä¸ä¼šã€è¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­</strong>ã€‚</li><li><strong>å¦‚æœ Redis æ˜¯ã€Œä»æœåŠ¡å™¨ã€è¿è¡Œæ¨¡å¼çš„è¯ï¼Œåœ¨è½½å…¥ RDB æ–‡ä»¶æ—¶ï¼Œä¸è®ºé”®æ˜¯å¦è¿‡æœŸéƒ½ä¼šè¢«è½½å…¥åˆ°æ•°æ®åº“ä¸­</strong>ã€‚ä½†ç”±äºä¸»ä»æœåŠ¡å™¨åœ¨è¿›è¡Œæ•°æ®åŒæ­¥æ—¶ï¼Œä»æœåŠ¡å™¨çš„æ•°æ®ä¼šè¢«æ¸…ç©ºã€‚</li></ul></li></ul><p>å¯¹äºAOF æ–‡ä»¶æ¥è¯´ï¼Œåˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼šAOF æ–‡ä»¶å†™å…¥é˜¶æ®µå’Œ AOF é‡å†™é˜¶æ®µã€‚</p><ul><li><strong>AOF æ–‡ä»¶å†™å…¥é˜¶æ®µ</strong>ï¼šå½“ Redis ä»¥ AOF æ¨¡å¼æŒä¹…åŒ–æ—¶ï¼Œ<strong>å¦‚æœæ•°æ®åº“æŸä¸ªè¿‡æœŸé”®è¿˜æ²¡è¢«åˆ é™¤ï¼Œé‚£ä¹ˆ AOF æ–‡ä»¶ä¼šä¿ç•™æ­¤è¿‡æœŸé”®ï¼Œå½“æ­¤è¿‡æœŸé”®è¢«åˆ é™¤åï¼ŒRedis ä¼šå‘ AOF æ–‡ä»¶è¿½åŠ ä¸€æ¡ DEL å‘½ä»¤æ¥æ˜¾å¼åœ°åˆ é™¤è¯¥é”®å€¼</strong>ã€‚</li><li><strong>AOF é‡å†™é˜¶æ®µ</strong>ï¼šæ‰§è¡Œ AOF é‡å†™æ—¶ï¼Œä¼šå¯¹ Redis ä¸­çš„é”®å€¼å¯¹è¿›è¡Œæ£€æŸ¥ï¼Œ<strong>å·²è¿‡æœŸçš„é”®ä¸ä¼šè¢«ä¿å­˜åˆ°é‡å†™åçš„ AOF æ–‡ä»¶ä¸­</strong>ï¼Œå› æ­¤ä¸ä¼šå¯¹ AOF é‡å†™é€ æˆä»»ä½•å½±å“ã€‚</li></ul><h2 id="Redisä¸»ä»æ¨¡å¼ä¸­ï¼Œä¼šå¯¹è¿‡æœŸé”®å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#Redisä¸»ä»æ¨¡å¼ä¸­ï¼Œä¼šå¯¹è¿‡æœŸé”®å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="Redisä¸»ä»æ¨¡å¼ä¸­ï¼Œä¼šå¯¹è¿‡æœŸé”®å¦‚ä½•å¤„ç†ï¼Ÿ"></a>Redisä¸»ä»æ¨¡å¼ä¸­ï¼Œä¼šå¯¹è¿‡æœŸé”®å¦‚ä½•å¤„ç†ï¼Ÿ</h2><p><strong>ä»åº“ä¸ä¼šè¿›è¡Œè¿‡æœŸæ‰«æï¼Œä»åº“å¯¹è¿‡æœŸçš„å¤„ç†æ˜¯è¢«åŠ¨çš„</strong>ã€‚ä¹Ÿå°±æ˜¯å³ä½¿ä»åº“ä¸­çš„ key è¿‡æœŸäº†ï¼Œå¦‚æœæœ‰å®¢æˆ·ç«¯è®¿é—®ä»åº“æ—¶ï¼Œä¾ç„¶å¯ä»¥å¾—åˆ° key å¯¹åº”çš„å€¼ï¼Œåƒæœªè¿‡æœŸçš„é”®å€¼å¯¹ä¸€æ ·è¿”å›ã€‚ä»åº“çš„è¿‡æœŸé”®å¤„ç†ä¾é ä¸»æœåŠ¡å™¨æ§åˆ¶ï¼Œ<strong>ä¸»åº“åœ¨ key åˆ°æœŸæ—¶ï¼Œä¼šåœ¨ AOF æ–‡ä»¶é‡Œå¢åŠ ä¸€æ¡ del æŒ‡ä»¤ï¼ŒåŒæ­¥åˆ°æ‰€æœ‰çš„ä»åº“</strong>ï¼Œä»åº“é€šè¿‡æ‰§è¡Œè¿™æ¡ del æŒ‡ä»¤æ¥åˆ é™¤è¿‡æœŸçš„ keyã€‚</p><h2 id="Rediså†…å­˜æ»¡äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"><a href="#Rediså†…å­˜æ»¡äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ" class="headerlink" title="Rediså†…å­˜æ»¡äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ"></a>Rediså†…å­˜æ»¡äº†ï¼Œä¼šå‘ç”Ÿä»€ä¹ˆï¼Ÿ</h2><p>åœ¨ Redis çš„è¿è¡Œå†…å­˜è¾¾åˆ°äº†æŸä¸ªé˜€å€¼ï¼Œå°±ä¼šè§¦å‘<strong>å†…å­˜æ·˜æ±°æœºåˆ¶</strong>ï¼Œè¿™ä¸ªé˜€å€¼å°±æ˜¯æˆ‘ä»¬è®¾ç½®çš„æœ€å¤§è¿è¡Œå†…å­˜ï¼Œ</p><h2 id="Rediså†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"><a href="#Rediså†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ" class="headerlink" title="Rediså†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ"></a>Rediså†…å­˜æ·˜æ±°ç­–ç•¥æœ‰å“ªäº›ï¼Ÿ</h2><ul><li>ä¸è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥<ul><li><strong>noeviction</strong>ï¼šå®ƒè¡¨ç¤ºå½“è¿è¡Œå†…å­˜è¶…è¿‡æœ€å¤§è®¾ç½®å†…å­˜æ—¶ï¼Œä¸æ·˜æ±°ä»»ä½•æ•°æ®ï¼Œè€Œæ˜¯ä¸å†æä¾›æœåŠ¡ï¼Œç›´æ¥è¿”å›é”™è¯¯ã€‚</li></ul></li><li>è¿›è¡Œæ•°æ®æ·˜æ±°çš„ç­–ç•¥<ul><li>åœ¨è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„æ•°æ®ä¸­è¿›è¡Œæ·˜æ±°<ul><li><strong>volatile-random</strong>ï¼šéšæœºæ·˜æ±°è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„ä»»æ„é”®å€¼ï¼›</li><li><strong>volatile-ttl</strong>ï¼šä¼˜å…ˆæ·˜æ±°æ›´æ—©è¿‡æœŸçš„é”®å€¼ã€‚</li><li><strong>volatile-lru</strong>ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›</li><li><strong>volatile-lfu</strong>ï¼šæ·˜æ±°æ‰€æœ‰è®¾ç½®äº†è¿‡æœŸæ—¶é—´çš„é”®å€¼ä¸­ï¼Œæœ€å°‘ä½¿ç”¨çš„é”®å€¼ï¼›</li></ul></li><li>åœ¨æ‰€æœ‰æ•°æ®èŒƒå›´å†…è¿›è¡Œæ·˜æ±°<ul><li><strong>allkeys-random</strong>ï¼šéšæœºæ·˜æ±°ä»»æ„é”®å€¼;</li><li><strong>allkeys-lru</strong>ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€ä¹…æœªä½¿ç”¨çš„é”®å€¼ï¼›</li><li><strong>allkeys-lfu</strong>ï¼šæ·˜æ±°æ•´ä¸ªé”®å€¼ä¸­æœ€å°‘ä½¿ç”¨çš„é”®å€¼ã€‚</li></ul></li></ul></li></ul><h2 id="Rediså¦‚ä½•å®ç°LRUç®—æ³•ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°LRUç®—æ³•ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°LRUç®—æ³•ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°LRUç®—æ³•ï¼Ÿ</h2><p>Redis å®ç°çš„æ˜¯ä¸€ç§<strong>è¿‘ä¼¼ LRU ç®—æ³•</strong>ï¼Œç›®çš„æ˜¯ä¸ºäº†æ›´å¥½çš„èŠ‚çº¦å†…å­˜ï¼Œå®ƒçš„<strong>å®ç°æ–¹å¼æ˜¯åœ¨ Redis çš„å¯¹è±¡ç»“æ„ä½“ä¸­æ·»åŠ ä¸€ä¸ªé¢å¤–çš„å­—æ®µï¼Œç”¨äºè®°å½•æ­¤æ•°æ®çš„æœ€åä¸€æ¬¡è®¿é—®æ—¶é—´</strong>ã€‚</p><p>å½“ Redis è¿›è¡Œå†…å­˜æ·˜æ±°æ—¶ï¼Œä¼šä½¿ç”¨<strong>éšæœºé‡‡æ ·çš„æ–¹å¼æ¥æ·˜æ±°æ•°æ®</strong>ï¼Œç„¶å<strong>æ·˜æ±°æœ€ä¹…æ²¡æœ‰ä½¿ç”¨çš„é‚£ä¸ª</strong>ã€‚</p><p>Redis å®ç°çš„ LRU ç®—æ³•çš„ä¼˜ç‚¹ï¼š</p><ul><li>ä¸ç”¨ä¸ºæ‰€æœ‰çš„æ•°æ®ç»´æŠ¤ä¸€ä¸ªå¤§é“¾è¡¨ï¼ŒèŠ‚çœäº†ç©ºé—´å ç”¨ï¼›</li><li>ä¸ç”¨åœ¨æ¯æ¬¡æ•°æ®è®¿é—®æ—¶éƒ½ç§»åŠ¨é“¾è¡¨é¡¹ï¼Œæå‡äº†ç¼“å­˜çš„æ€§èƒ½ï¼›</li></ul><p>ç¼ºç‚¹ï¼š<strong>æ— æ³•è§£å†³ç¼“å­˜æ±¡æŸ“é—®é¢˜</strong>ï¼Œæ¯”å¦‚åº”ç”¨ä¸€æ¬¡è¯»å–äº†å¤§é‡çš„æ•°æ®ï¼Œè€Œè¿™äº›æ•°æ®åªä¼šè¢«è¯»å–è¿™ä¸€æ¬¡ï¼Œé‚£ä¹ˆè¿™äº›æ•°æ®ä¼šç•™å­˜åœ¨ Redis ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´ï¼Œé€ æˆç¼“å­˜æ±¡æŸ“ã€‚</p><h2 id="Rediså¦‚ä½•å®ç°LFUç®—æ³•ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°LFUç®—æ³•ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°LFUç®—æ³•ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°LFUç®—æ³•ï¼Ÿ</h2><p>LFU ç®—æ³•ç›¸æ¯”äº LRU ç®—æ³•çš„å®ç°ï¼Œå¤šè®°å½•äº†ã€Œæ•°æ®çš„è®¿é—®é¢‘æ¬¡ã€çš„ä¿¡æ¯</p><p>LFU ç®—æ³•ä¼šè®°å½•æ¯ä¸ªæ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚å½“ä¸€ä¸ªæ•°æ®è¢«å†æ¬¡è®¿é—®æ—¶ï¼Œå°±ä¼šå¢åŠ è¯¥æ•°æ®çš„è®¿é—®æ¬¡æ•°ã€‚è¿™æ ·å°±è§£å†³äº†å¶å°”è¢«è®¿é—®ä¸€æ¬¡ä¹‹åï¼Œæ•°æ®ç•™å­˜åœ¨ç¼“å­˜ä¸­å¾ˆé•¿ä¸€æ®µæ—¶é—´çš„é—®é¢˜ï¼Œç›¸æ¯”äº LRU ç®—æ³•ä¹Ÿæ›´åˆç†ä¸€äº›ã€‚</p><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/061e2c04e0ebca3425dd75dd035b6b7b-172019020901413.png" alt="å¸¸è§Redisç¼“å­˜é—®é¢˜"></p><h2 id="å¦‚ä½•é¿å…ç¼“å­˜é›ªå´©ï¼Ÿ"><a href="#å¦‚ä½•é¿å…ç¼“å­˜é›ªå´©ï¼Ÿ" class="headerlink" title="å¦‚ä½•é¿å…ç¼“å­˜é›ªå´©ï¼Ÿ"></a>å¦‚ä½•é¿å…ç¼“å­˜é›ªå´©ï¼Ÿ</h2><p>å½“å¤§é‡ç¼“å­˜æ•°æ®åœ¨åŒä¸€æ—¶é—´è¿‡æœŸï¼ˆå¤±æ•ˆï¼‰æ—¶ï¼Œå¦‚æœæ­¤æ—¶æœ‰å¤§é‡çš„ç”¨æˆ·è¯·æ±‚ï¼Œéƒ½æ— æ³•åœ¨ Redis ä¸­å¤„ç†ï¼Œäºæ˜¯å…¨éƒ¨è¯·æ±‚éƒ½ç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œä»è€Œå¯¼è‡´æ•°æ®åº“çš„å‹åŠ›éª¤å¢ï¼Œä¸¥é‡çš„ä¼šé€ æˆæ•°æ®åº“å®•æœºï¼Œä»è€Œå½¢æˆä¸€ç³»åˆ—è¿é”ååº”ï¼Œé€ æˆæ•´ä¸ªç³»ç»Ÿå´©æºƒï¼Œè¿™å°±æ˜¯<strong>ç¼“å­˜é›ªå´©</strong>çš„é—®é¢˜ã€‚</p><ul><li><strong>å°†ç¼“å­˜å¤±æ•ˆæ—¶é—´éšæœºæ‰“æ•£ï¼š</strong> æˆ‘ä»¬å¯ä»¥åœ¨åŸæœ‰çš„å¤±æ•ˆæ—¶é—´åŸºç¡€ä¸Šå¢åŠ ä¸€ä¸ªéšæœºå€¼ï¼ˆæ¯”å¦‚ 1 åˆ° 10 åˆ†é’Ÿï¼‰è¿™æ ·æ¯ä¸ªç¼“å­˜çš„è¿‡æœŸæ—¶é—´éƒ½ä¸é‡å¤äº†ï¼Œä¹Ÿå°±é™ä½äº†ç¼“å­˜é›†ä½“å¤±æ•ˆçš„æ¦‚ç‡ã€‚</li><li><strong>è®¾ç½®ç¼“å­˜ä¸è¿‡æœŸï¼š</strong> æˆ‘ä»¬å¯ä»¥é€šè¿‡åå°æœåŠ¡æ¥æ›´æ–°ç¼“å­˜æ•°æ®ï¼Œä»è€Œé¿å…å› ä¸ºç¼“å­˜å¤±æ•ˆé€ æˆçš„ç¼“å­˜é›ªå´©ï¼Œä¹Ÿå¯ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šé¿å…ç¼“å­˜å¹¶å‘é—®é¢˜ã€‚</li></ul><h2 id="å¦‚ä½•é¿å…ç¼“å­˜å‡»ç©¿ï¼Ÿ"><a href="#å¦‚ä½•é¿å…ç¼“å­˜å‡»ç©¿ï¼Ÿ" class="headerlink" title="å¦‚ä½•é¿å…ç¼“å­˜å‡»ç©¿ï¼Ÿ"></a>å¦‚ä½•é¿å…ç¼“å­˜å‡»ç©¿ï¼Ÿ</h2><p>å¦‚æœç¼“å­˜ä¸­çš„<strong>æŸä¸ªçƒ­ç‚¹æ•°æ®è¿‡æœŸ</strong>äº†ï¼Œæ­¤æ—¶å¤§é‡çš„è¯·æ±‚è®¿é—®äº†è¯¥çƒ­ç‚¹æ•°æ®ï¼Œå°±æ— æ³•ä»ç¼“å­˜ä¸­è¯»å–ï¼Œç›´æ¥è®¿é—®æ•°æ®åº“ï¼Œæ•°æ®åº“å¾ˆå®¹æ˜“å°±è¢«é«˜å¹¶å‘çš„è¯·æ±‚å†²å®ï¼Œè¿™å°±æ˜¯<strong>ç¼“å­˜å‡»ç©¿</strong>çš„é—®é¢˜ã€‚</p><ul><li>äº’æ–¥é”æ–¹æ¡ˆï¼šä¿è¯åŒä¸€æ—¶é—´åªæœ‰ä¸€ä¸ªä¸šåŠ¡çº¿ç¨‹è¯·æ±‚ç¼“å­˜ï¼Œæœªèƒ½è·å–äº’æ–¥é”çš„è¯·æ±‚ï¼Œè¦ä¹ˆç­‰å¾…é”é‡Šæ”¾åé‡æ–°è¯»å–ç¼“å­˜ï¼Œè¦ä¹ˆå°±è¿”å›ç©ºå€¼æˆ–è€…é»˜è®¤å€¼ã€‚</li><li>ä¸ç»™çƒ­ç‚¹æ•°æ®è®¾ç½®è¿‡æœŸæ—¶é—´ï¼Œç”±åå°å¼‚æ­¥æ›´æ–°ç¼“å­˜ï¼Œæˆ–è€…åœ¨çƒ­ç‚¹æ•°æ®å‡†å¤‡è¦è¿‡æœŸå‰ï¼Œæå‰é€šçŸ¥åå°çº¿ç¨‹æ›´æ–°ç¼“å­˜ä»¥åŠé‡æ–°è®¾ç½®è¿‡æœŸæ—¶é—´ï¼›</li></ul><h2 id="å¦‚ä½•é¿å…ç¼“å­˜ç©¿é€ï¼Ÿ"><a href="#å¦‚ä½•é¿å…ç¼“å­˜ç©¿é€ï¼Ÿ" class="headerlink" title="å¦‚ä½•é¿å…ç¼“å­˜ç©¿é€ï¼Ÿ"></a>å¦‚ä½•é¿å…ç¼“å­˜ç©¿é€ï¼Ÿ</h2><p>å½“ç”¨æˆ·è®¿é—®çš„æ•°æ®ï¼Œ<strong>æ—¢ä¸åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿä¸åœ¨æ•°æ®åº“ä¸­</strong>ï¼Œå¯¼è‡´è¯·æ±‚åœ¨è®¿é—®ç¼“å­˜æ—¶ï¼Œå‘ç°ç¼“å­˜ç¼ºå¤±ï¼Œå†å»è®¿é—®æ•°æ®åº“æ—¶ï¼Œå‘ç°æ•°æ®åº“ä¸­ä¹Ÿæ²¡æœ‰è¦è®¿é—®çš„æ•°æ®ï¼Œæ²¡åŠæ³•æ„å»ºç¼“å­˜æ•°æ®ï¼Œæ¥æœåŠ¡åç»­çš„è¯·æ±‚ã€‚é‚£ä¹ˆå½“æœ‰å¤§é‡è¿™æ ·çš„è¯·æ±‚åˆ°æ¥æ—¶ï¼Œæ•°æ®åº“çš„å‹åŠ›éª¤å¢ï¼Œè¿™å°±æ˜¯<strong>ç¼“å­˜ç©¿é€</strong>çš„é—®é¢˜ã€‚</p><ul><li><strong>éæ³•è¯·æ±‚çš„é™åˆ¶</strong>ï¼šå½“æœ‰å¤§é‡æ¶æ„è¯·æ±‚è®¿é—®ä¸å­˜åœ¨çš„æ•°æ®çš„æ—¶å€™ï¼Œä¹Ÿä¼šå‘ç”Ÿç¼“å­˜ç©¿é€ï¼Œå› æ­¤åœ¨ API å…¥å£å¤„æˆ‘ä»¬è¦åˆ¤æ–­æ±‚è¯·æ±‚å‚æ•°æ˜¯å¦åˆç†ï¼Œè¯·æ±‚å‚æ•°æ˜¯å¦å«æœ‰éæ³•å€¼ã€è¯·æ±‚å­—æ®µæ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœåˆ¤æ–­å‡ºæ˜¯æ¶æ„è¯·æ±‚å°±ç›´æ¥è¿”å›é”™è¯¯ï¼Œé¿å…è¿›ä¸€æ­¥è®¿é—®ç¼“å­˜å’Œæ•°æ®åº“ã€‚</li><li><strong>è®¾ç½®ç©ºå€¼æˆ–è€…é»˜è®¤å€¼</strong>ï¼šå½“æˆ‘ä»¬çº¿ä¸Šä¸šåŠ¡å‘ç°ç¼“å­˜ç©¿é€çš„ç°è±¡æ—¶ï¼Œå¯ä»¥é’ˆå¯¹æŸ¥è¯¢çš„æ•°æ®ï¼Œåœ¨ç¼“å­˜ä¸­è®¾ç½®ä¸€ä¸ªç©ºå€¼æˆ–è€…é»˜è®¤å€¼ï¼Œè¿™æ ·åç»­è¯·æ±‚å°±å¯ä»¥ä»ç¼“å­˜ä¸­è¯»å–åˆ°ç©ºå€¼æˆ–è€…é»˜è®¤å€¼ï¼Œè¿”å›ç»™åº”ç”¨ï¼Œè€Œä¸ä¼šç»§ç»­æŸ¥è¯¢æ•°æ®åº“ã€‚</li><li><strong>ä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œé¿å…é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨</strong>ï¼šæˆ‘ä»¬å¯ä»¥åœ¨å†™å…¥æ•°æ®åº“æ•°æ®æ—¶ï¼Œä½¿ç”¨å¸ƒéš†è¿‡æ»¤å™¨åšä¸ªæ ‡è®°ï¼Œç„¶ååœ¨ç”¨æˆ·è¯·æ±‚åˆ°æ¥æ—¶ï¼Œä¸šåŠ¡çº¿ç¨‹ç¡®è®¤ç¼“å­˜å¤±æ•ˆåï¼Œå¯ä»¥é€šè¿‡æŸ¥è¯¢å¸ƒéš†è¿‡æ»¤å™¨å¿«é€Ÿåˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œå°±ä¸ç”¨é€šè¿‡æŸ¥è¯¢æ•°æ®åº“æ¥åˆ¤æ–­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå³ä½¿å‘ç”Ÿäº†ç¼“å­˜ç©¿é€ï¼Œå¤§é‡è¯·æ±‚åªä¼šæŸ¥è¯¢ Redis å’Œå¸ƒéš†è¿‡æ»¤å™¨ï¼Œè€Œä¸ä¼šæŸ¥è¯¢æ•°æ®åº“ï¼Œä¿è¯äº†æ•°æ®åº“èƒ½æ­£å¸¸è¿è¡Œï¼ŒRedis è‡ªèº«ä¹Ÿæ˜¯æ”¯æŒå¸ƒéš†è¿‡æ»¤å™¨çš„ã€‚</li></ul><h2 id="å¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜ç­–ç•¥ï¼Œå¯ä»¥åŠ¨æ€ç¼“å­˜çƒ­ç‚¹æ•°æ®å‘¢ï¼Ÿ"><a href="#å¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜ç­–ç•¥ï¼Œå¯ä»¥åŠ¨æ€ç¼“å­˜çƒ­ç‚¹æ•°æ®å‘¢ï¼Ÿ" class="headerlink" title="å¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜ç­–ç•¥ï¼Œå¯ä»¥åŠ¨æ€ç¼“å­˜çƒ­ç‚¹æ•°æ®å‘¢ï¼Ÿ"></a>å¦‚ä½•è®¾è®¡ä¸€ä¸ªç¼“å­˜ç­–ç•¥ï¼Œå¯ä»¥åŠ¨æ€ç¼“å­˜çƒ­ç‚¹æ•°æ®å‘¢ï¼Ÿ</h2><p>çƒ­ç‚¹æ•°æ®åŠ¨æ€ç¼“å­˜çš„ç­–ç•¥æ€»ä½“æ€è·¯ï¼š<strong>é€šè¿‡æ•°æ®æœ€æ–°è®¿é—®æ—¶é—´æ¥åšæ’åï¼Œå¹¶è¿‡æ»¤æ‰ä¸å¸¸è®¿é—®çš„æ•°æ®ï¼Œåªç•™ä¸‹ç»å¸¸è®¿é—®çš„æ•°æ®</strong>ã€‚</p><h2 id="è¯´è¯´å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥"><a href="#è¯´è¯´å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥" class="headerlink" title="è¯´è¯´å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥"></a>è¯´è¯´å¸¸è§çš„ç¼“å­˜æ›´æ–°ç­–ç•¥</h2><p>å®é™…å¼€å‘ä¸­ï¼ŒRedis å’Œ MySQL çš„æ›´æ–°ç­–ç•¥ç”¨çš„æ˜¯ Cache Asideï¼Œå¦å¤–ä¸¤ç§ç­–ç•¥åº”ç”¨ä¸äº†ã€‚</p><ul><li><p>Cache Asideï¼ˆæ—è·¯ç¼“å­˜ï¼‰ç­–ç•¥ï¼šåº”ç”¨ç¨‹åºç›´æ¥ä¸ã€Œæ•°æ®åº“ã€ç¼“å­˜ã€äº¤äº’ï¼Œå¹¶è´Ÿè´£å¯¹ç¼“å­˜çš„ç»´æŠ¤ï¼Œè¯¥ç­–ç•¥åˆå¯ä»¥ç»†åˆ†ä¸ºã€Œè¯»ç­–ç•¥ã€å’Œã€Œå†™ç­–ç•¥ã€ã€‚</p><ul><li>å†™ç­–ç•¥ï¼šå…ˆæ›´æ–°æ•°æ®åº“ä¸­çš„æ•°æ®ï¼Œå†åˆ é™¤ç¼“å­˜ä¸­çš„æ•°æ®ã€‚</li><li>è¯»ç­–ç•¥ï¼šå¦‚æœè¯»å–çš„æ•°æ®å‘½ä¸­äº†ç¼“å­˜ï¼Œåˆ™ç›´æ¥è¿”å›æ•°æ®ï¼›å¦‚æœè¯»å–çš„æ•°æ®æ²¡æœ‰å‘½ä¸­ç¼“å­˜ï¼Œåˆ™ä»æ•°æ®åº“ä¸­è¯»å–æ•°æ®ï¼Œç„¶åå°†æ•°æ®å†™å…¥åˆ°ç¼“å­˜ï¼Œå¹¶ä¸”è¿”å›ç»™ç”¨æˆ·ã€‚</li></ul><p>å†™ç­–ç•¥çš„æ­¥éª¤çš„é¡ºåºä¸èƒ½å€’è¿‡æ¥ï¼Œå³<strong>ä¸èƒ½å…ˆåˆ é™¤ç¼“å­˜å†æ›´æ–°æ•°æ®åº“</strong>ï¼ŒåŸå› æ˜¯åœ¨ã€Œè¯»+å†™ã€å¹¶å‘çš„æ—¶å€™ï¼Œä¼šå‡ºç°ç¼“å­˜å’Œæ•°æ®åº“çš„æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ã€‚</p></li><li><p>Read Through ç­–ç•¥ï¼šå…ˆæŸ¥è¯¢ç¼“å­˜ä¸­æ•°æ®æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æœå­˜åœ¨åˆ™ç›´æ¥è¿”å›ï¼Œå¦‚æœä¸å­˜åœ¨ï¼Œåˆ™ç”±ç¼“å­˜ç»„ä»¶è´Ÿè´£ä»æ•°æ®åº“æŸ¥è¯¢æ•°æ®ï¼Œå¹¶å°†ç»“æœå†™å…¥åˆ°ç¼“å­˜ç»„ä»¶ï¼Œæœ€åç¼“å­˜ç»„ä»¶å°†æ•°æ®è¿”å›ç»™åº”ç”¨ã€‚</p></li><li><p>Write Through ç­–ç•¥</p><ul><li>å¦‚æœç¼“å­˜ä¸­æ•°æ®å·²ç»å­˜åœ¨ï¼Œåˆ™æ›´æ–°ç¼“å­˜ä¸­çš„æ•°æ®ï¼Œå¹¶ä¸”ç”±ç¼“å­˜ç»„ä»¶åŒæ­¥æ›´æ–°åˆ°æ•°æ®åº“ä¸­ï¼Œç„¶åç¼“å­˜ç»„ä»¶å‘ŠçŸ¥åº”ç”¨ç¨‹åºæ›´æ–°å®Œæˆã€‚</li><li>å¦‚æœç¼“å­˜ä¸­æ•°æ®ä¸å­˜åœ¨ï¼Œç›´æ¥æ›´æ–°æ•°æ®åº“ï¼Œç„¶åè¿”å›ï¼›</li></ul></li><li><p>Write Backï¼ˆå†™å›ï¼‰ç­–ç•¥ï¼šåœ¨æ›´æ–°æ•°æ®çš„æ—¶å€™ï¼Œåªæ›´æ–°ç¼“å­˜ï¼ŒåŒæ—¶å°†ç¼“å­˜æ•°æ®è®¾ç½®ä¸ºè„çš„ï¼Œç„¶åç«‹é©¬è¿”å›ï¼Œå¹¶ä¸ä¼šæ›´æ–°æ•°æ®åº“ã€‚å¯¹äºæ•°æ®åº“çš„æ›´æ–°ï¼Œä¼šé€šè¿‡æ‰¹é‡å¼‚æ­¥æ›´æ–°çš„æ–¹å¼è¿›è¡Œã€‚</p></li></ul><h2 id="Rediså¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"><a href="#Rediså¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ" class="headerlink" title="Rediså¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ"></a>Rediså¦‚ä½•å®ç°å»¶è¿Ÿé˜Ÿåˆ—ï¼Ÿ</h2><p>å»¶è¿Ÿé˜Ÿåˆ—æ˜¯æŒ‡æŠŠå½“å‰è¦åšçš„äº‹æƒ…ï¼Œå¾€åæ¨è¿Ÿä¸€æ®µæ—¶é—´å†åšã€‚</p><ul><li>åœ¨ Redis å¯ä»¥ä½¿ç”¨æœ‰åºé›†åˆï¼ˆZSetï¼‰çš„æ–¹å¼æ¥å®ç°å»¶è¿Ÿæ¶ˆæ¯é˜Ÿåˆ—çš„ï¼ŒZSet æœ‰ä¸€ä¸ª Score å±æ€§å¯ä»¥ç”¨æ¥å­˜å‚¨å»¶è¿Ÿæ‰§è¡Œçš„æ—¶é—´ã€‚</li><li>ä½¿ç”¨ zadd score1 value1 å‘½ä»¤å°±å¯ä»¥ä¸€ç›´å¾€å†…å­˜ä¸­ç”Ÿäº§æ¶ˆæ¯ã€‚å†åˆ©ç”¨ zrangebysocre æŸ¥è¯¢ç¬¦åˆæ¡ä»¶çš„æ‰€æœ‰å¾…å¤„ç†çš„ä»»åŠ¡ï¼Œ é€šè¿‡å¾ªç¯æ‰§è¡Œé˜Ÿåˆ—ä»»åŠ¡å³å¯ã€‚</li></ul><h2 id="Redisç®¡é“æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"><a href="#Redisç®¡é“æœ‰ä»€ä¹ˆç”¨ï¼Ÿ" class="headerlink" title="Redisç®¡é“æœ‰ä»€ä¹ˆç”¨ï¼Ÿ"></a>Redisç®¡é“æœ‰ä»€ä¹ˆç”¨ï¼Ÿ</h2><p>ç®¡é“æŠ€æœ¯ï¼ˆPipelineï¼‰æ˜¯å®¢æˆ·ç«¯æä¾›çš„ä¸€ç§æ‰¹å¤„ç†æŠ€æœ¯ï¼Œç”¨äºä¸€æ¬¡å¤„ç†å¤šä¸ª Redis å‘½ä»¤ï¼Œä»è€Œæé«˜æ•´ä¸ªäº¤äº’çš„æ€§èƒ½ã€‚ä½¿ç”¨<strong>ç®¡é“æŠ€æœ¯å¯ä»¥è§£å†³å¤šä¸ªå‘½ä»¤æ‰§è¡Œæ—¶çš„ç½‘ç»œç­‰å¾…</strong>ï¼Œå®ƒæ˜¯æŠŠå¤šä¸ªå‘½ä»¤æ•´åˆåˆ°ä¸€èµ·å‘é€ç»™æœåŠ¡å™¨ç«¯å¤„ç†ä¹‹åç»Ÿä¸€è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè¿™æ ·å°±å…å»äº†æ¯æ¡å‘½ä»¤æ‰§è¡Œåéƒ½è¦ç­‰å¾…çš„æƒ…å†µï¼Œä»è€Œæœ‰æ•ˆåœ°æé«˜äº†ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚</p><h2 id="Redisäº‹åŠ¡æ”¯æŒå›æ»šå—ï¼Ÿ"><a href="#Redisäº‹åŠ¡æ”¯æŒå›æ»šå—ï¼Ÿ" class="headerlink" title="Redisäº‹åŠ¡æ”¯æŒå›æ»šå—ï¼Ÿ"></a>Redisäº‹åŠ¡æ”¯æŒå›æ»šå—ï¼Ÿ</h2><p><strong>Redis ä¸­å¹¶æ²¡æœ‰æä¾›å›æ»šæœºåˆ¶</strong></p><h2 id="å¦‚ä½•ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿ"><a href="#å¦‚ä½•ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿ" class="headerlink" title="å¦‚ä½•ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿ"></a>å¦‚ä½•ç”¨Rediså®ç°åˆ†å¸ƒå¼é”ï¼Ÿ</h2><p>é€šè¿‡ä½¿ç”¨ SET å‘½ä»¤å’Œ Lua è„šæœ¬åœ¨ Redis å•èŠ‚ç‚¹ä¸Šå®Œæˆäº†åˆ†å¸ƒå¼é”çš„åŠ é”å’Œè§£é”ã€‚</p><p><strong>ä¼˜ç‚¹</strong></p><ul><li>æ€§èƒ½é«˜æ•ˆ</li><li>å®ç°æ–¹ä¾¿</li><li>é¿å…å•ç‚¹æ•…éšœ</li></ul><p><strong>ç¼ºç‚¹</strong></p><ul><li><strong>è¶…æ—¶æ—¶é—´ä¸å¥½è®¾ç½®</strong>ã€‚å¦‚æœé”çš„è¶…æ—¶æ—¶é—´è®¾ç½®è¿‡é•¿ï¼Œä¼šå½±å“æ€§èƒ½ï¼Œå¦‚æœè®¾ç½®çš„è¶…æ—¶æ—¶é—´è¿‡çŸ­ä¼šä¿æŠ¤ä¸åˆ°å…±äº«èµ„æºã€‚<ul><li>è§£å†³æ–¹æ¡ˆï¼šå†™ä¸€ä¸ªå®ˆæŠ¤çº¿ç¨‹ï¼Œç„¶åå»åˆ¤æ–­é”çš„æƒ…å†µï¼Œå½“é”å¿«å¤±æ•ˆçš„æ—¶å€™ï¼Œå†æ¬¡è¿›è¡Œç»­çº¦åŠ é”ï¼Œå½“ä¸»çº¿ç¨‹æ‰§è¡Œå®Œæˆåï¼Œé”€æ¯ç»­çº¦é”å³å¯ï¼Œä¸è¿‡è¿™ç§æ–¹å¼å®ç°èµ·æ¥ç›¸å¯¹å¤æ‚ã€‚</li></ul></li><li><strong>Redis ä¸»ä»å¤åˆ¶æ¨¡å¼ä¸­çš„æ•°æ®æ˜¯å¼‚æ­¥å¤åˆ¶çš„ï¼Œè¿™æ ·å¯¼è‡´åˆ†å¸ƒå¼é”çš„ä¸å¯é æ€§</strong>ã€‚</li></ul><h2 id="Redis-å¤§-Key-å¯¹æŒä¹…åŒ–æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ"><a href="#Redis-å¤§-Key-å¯¹æŒä¹…åŒ–æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ" class="headerlink" title="Redis å¤§ Key å¯¹æŒä¹…åŒ–æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ"></a>Redis å¤§ Key å¯¹æŒä¹…åŒ–æœ‰ä»€ä¹ˆå½±å“ï¼Ÿ</h2><ul><li>å½“ AOF å†™å›ç­–ç•¥é…ç½®äº† Always ç­–ç•¥ï¼Œå¦‚æœå†™å…¥æ˜¯ä¸€ä¸ªå¤§ Keyï¼Œä¸»çº¿ç¨‹åœ¨æ‰§è¡Œ fsync() å‡½æ•°çš„æ—¶å€™ï¼Œé˜»å¡çš„æ—¶é—´ä¼šæ¯”è¾ƒä¹…ï¼Œå› ä¸ºå½“å†™å…¥çš„æ•°æ®é‡å¾ˆå¤§çš„æ—¶å€™ï¼Œæ•°æ®åŒæ­¥åˆ°ç¡¬ç›˜è¿™ä¸ªè¿‡ç¨‹æ˜¯å¾ˆè€—æ—¶çš„ã€‚</li><li>AOF é‡å†™æœºåˆ¶å’Œ RDB å¿«ç…§ï¼ˆbgsave å‘½ä»¤ï¼‰çš„è¿‡ç¨‹ï¼Œéƒ½ä¼šåˆ†åˆ«é€šè¿‡ <code>fork()</code> å‡½æ•°åˆ›å»ºä¸€ä¸ªå­è¿›ç¨‹æ¥å¤„ç†ä»»åŠ¡ã€‚ä¼šæœ‰ä¸¤ä¸ªé˜¶æ®µä¼šå¯¼è‡´é˜»å¡çˆ¶è¿›ç¨‹ï¼ˆä¸»çº¿ç¨‹ï¼‰<ul><li>åˆ›å»ºå­è¿›ç¨‹çš„é€”ä¸­ï¼Œç”±äºè¦å¤åˆ¶çˆ¶è¿›ç¨‹çš„é¡µè¡¨ç­‰æ•°æ®ç»“æ„ï¼Œé˜»å¡çš„æ—¶é—´è·Ÿé¡µè¡¨çš„å¤§å°æœ‰å…³ï¼Œé¡µè¡¨è¶Šå¤§ï¼Œé˜»å¡çš„æ—¶é—´ä¹Ÿè¶Šé•¿ï¼›</li><li>åˆ›å»ºå®Œå­è¿›ç¨‹åï¼Œå¦‚æœçˆ¶è¿›ç¨‹ä¿®æ”¹äº†å…±äº«æ•°æ®ä¸­çš„å¤§ Keyï¼Œå°±ä¼šå‘ç”Ÿå†™æ—¶å¤åˆ¶ï¼Œè¿™æœŸé—´ä¼šæ‹·è´ç‰©ç†å†…å­˜ï¼Œç”±äºå¤§ Key å ç”¨çš„ç‰©ç†å†…å­˜ä¼šå¾ˆå¤§ï¼Œé‚£ä¹ˆåœ¨å¤åˆ¶ç‰©ç†å†…å­˜è¿™ä¸€è¿‡ç¨‹ï¼Œå°±ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥æœ‰å¯èƒ½ä¼šé˜»å¡çˆ¶è¿›ç¨‹ã€‚</li></ul></li></ul><h2 id="å¤§-Key-è¿˜æœ‰å“ªäº›å½±å“ï¼Ÿ"><a href="#å¤§-Key-è¿˜æœ‰å“ªäº›å½±å“ï¼Ÿ" class="headerlink" title="å¤§ Key è¿˜æœ‰å“ªäº›å½±å“ï¼Ÿ"></a>å¤§ Key è¿˜æœ‰å“ªäº›å½±å“ï¼Ÿ</h2><ul><li>å®¢æˆ·ç«¯è¶…æ—¶é˜»å¡ã€‚ç”±äº Redis æ‰§è¡Œå‘½ä»¤æ˜¯å•çº¿ç¨‹å¤„ç†ï¼Œç„¶ååœ¨æ“ä½œå¤§ key æ—¶ä¼šæ¯”è¾ƒè€—æ—¶ï¼Œé‚£ä¹ˆå°±ä¼šé˜»å¡ Redisï¼Œä»å®¢æˆ·ç«¯è¿™ä¸€è§†è§’çœ‹ï¼Œå°±æ˜¯å¾ˆä¹…å¾ˆä¹…éƒ½æ²¡æœ‰å“åº”ã€‚</li><li>å¼•å‘ç½‘ç»œé˜»å¡ã€‚æ¯æ¬¡è·å–å¤§ key äº§ç”Ÿçš„ç½‘ç»œæµé‡è¾ƒå¤§ï¼Œå¦‚æœä¸€ä¸ª key çš„å¤§å°æ˜¯ 1 MBï¼Œæ¯ç§’è®¿é—®é‡ä¸º 1000ï¼Œé‚£ä¹ˆæ¯ç§’ä¼šäº§ç”Ÿ 1000MB çš„æµé‡ï¼Œè¿™å¯¹äºæ™®é€šåƒå…†ç½‘å¡çš„æœåŠ¡å™¨æ¥è¯´æ˜¯ç¾éš¾æ€§çš„ã€‚</li><li>é˜»å¡å·¥ä½œçº¿ç¨‹ã€‚å¦‚æœä½¿ç”¨ del åˆ é™¤å¤§ key æ—¶ï¼Œä¼šé˜»å¡å·¥ä½œçº¿ç¨‹ï¼Œè¿™æ ·å°±æ²¡åŠæ³•å¤„ç†åç»­çš„å‘½ä»¤ã€‚</li><li>å†…å­˜åˆ†å¸ƒä¸å‡ã€‚é›†ç¾¤æ¨¡å‹åœ¨ slot åˆ†ç‰‡å‡åŒ€æƒ…å†µä¸‹ï¼Œä¼šå‡ºç°æ•°æ®å’ŒæŸ¥è¯¢å€¾æ–œæƒ…å†µï¼Œéƒ¨åˆ†æœ‰å¤§ key çš„ Redis èŠ‚ç‚¹å ç”¨å†…å­˜å¤šï¼ŒQPS ä¹Ÿä¼šæ¯”è¾ƒå¤§ã€‚</li></ul><h2 id="å¦‚ä½•é¿å…å¤§-Keyï¼Ÿ"><a href="#å¦‚ä½•é¿å…å¤§-Keyï¼Ÿ" class="headerlink" title="å¦‚ä½•é¿å…å¤§ Keyï¼Ÿ"></a>å¦‚ä½•é¿å…å¤§ Keyï¼Ÿ</h2><p>æœ€å¥½åœ¨è®¾è®¡é˜¶æ®µï¼Œå°±æŠŠå¤§ key æ‹†åˆ†æˆä¸€ä¸ªä¸€ä¸ªå° keyã€‚æˆ–è€…ï¼Œå®šæ—¶æ£€æŸ¥ Redis æ˜¯å¦å­˜åœ¨å¤§ key ï¼Œå¦‚æœè¯¥å¤§ key æ˜¯å¯ä»¥åˆ é™¤çš„ï¼Œä¸è¦ä½¿ç”¨ DEL å‘½ä»¤åˆ é™¤ï¼Œå› ä¸ºè¯¥å‘½ä»¤åˆ é™¤è¿‡ç¨‹ä¼šé˜»å¡ä¸»çº¿ç¨‹ï¼Œè€Œæ˜¯ç”¨ unlink å‘½ä»¤åˆ é™¤å¤§ keyï¼Œå› ä¸ºè¯¥å‘½ä»¤çš„åˆ é™¤è¿‡ç¨‹æ˜¯å¼‚æ­¥çš„ï¼Œä¸ä¼šé˜»å¡ä¸»çº¿ç¨‹ã€‚</p><h2 id="å¦‚ä½•åˆ¤æ–­keyå·²è¿‡æœŸï¼Ÿ"><a href="#å¦‚ä½•åˆ¤æ–­keyå·²è¿‡æœŸï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ¤æ–­keyå·²è¿‡æœŸï¼Ÿ"></a>å¦‚ä½•åˆ¤æ–­keyå·²è¿‡æœŸï¼Ÿ</h2><p>Redis é¦–å…ˆæ£€æŸ¥è¯¥ key æ˜¯å¦å­˜åœ¨äºè¿‡æœŸå­—å…¸ä¸­ï¼Œå¦‚æœä¸åœ¨ï¼Œåˆ™æ­£å¸¸è¯»å–é”®å€¼ï¼›å¦‚æœå­˜åœ¨ï¼Œåˆ™ä¼šè·å–è¯¥ key çš„è¿‡æœŸæ—¶é—´ï¼Œç„¶åä¸å½“å‰ç³»ç»Ÿæ—¶é—´è¿›è¡Œæ¯”å¯¹ï¼Œå¦‚æœæ¯”ç³»ç»Ÿæ—¶é—´å¤§ï¼Œé‚£å°±æ²¡æœ‰è¿‡æœŸï¼Œå¦åˆ™åˆ¤å®šè¯¥ key å·²è¿‡æœŸã€‚</p><h2 id="Redisä¸»ä»èŠ‚ç‚¹æ˜¯é•¿è¿æ¥è¿˜æ˜¯çŸ­é“¾æ¥ï¼Ÿ"><a href="#Redisä¸»ä»èŠ‚ç‚¹æ˜¯é•¿è¿æ¥è¿˜æ˜¯çŸ­é“¾æ¥ï¼Ÿ" class="headerlink" title="Redisä¸»ä»èŠ‚ç‚¹æ˜¯é•¿è¿æ¥è¿˜æ˜¯çŸ­é“¾æ¥ï¼Ÿ"></a>Redisä¸»ä»èŠ‚ç‚¹æ˜¯é•¿è¿æ¥è¿˜æ˜¯çŸ­é“¾æ¥ï¼Ÿ</h2><p>é•¿è¿æ¥</p><h2 id="å¦‚ä½•åˆ¤æ–­-Redis-æŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ"><a href="#å¦‚ä½•åˆ¤æ–­-Redis-æŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ Redis æŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ"></a>å¦‚ä½•åˆ¤æ–­ Redis æŸä¸ªèŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼Ÿ</h2><p>Redis åˆ¤æ–­èŠ‚ç‚¹æ˜¯å¦æ­£å¸¸å·¥ä½œï¼ŒåŸºæœ¬éƒ½æ˜¯é€šè¿‡äº’ç›¸çš„ ping-pong å¿ƒæ€æ£€æµ‹æœºåˆ¶ï¼Œå¦‚æœæœ‰ä¸€åŠä»¥ä¸Šçš„èŠ‚ç‚¹å» ping ä¸€ä¸ªèŠ‚ç‚¹çš„æ—¶å€™æ²¡æœ‰ pong å›åº”ï¼Œé›†ç¾¤å°±ä¼šè®¤ä¸ºè¿™ä¸ªèŠ‚ç‚¹æŒ‚æ‰äº†ï¼Œä¼šæ–­å¼€ä¸è¿™ä¸ªèŠ‚ç‚¹çš„è¿æ¥ã€‚</p><h2 id="ä¸»ä»å¤åˆ¶æ¶æ„ä¸­ï¼Œè¿‡æœŸ-key-å¦‚ä½•å¤„ç†ï¼Ÿ"><a href="#ä¸»ä»å¤åˆ¶æ¶æ„ä¸­ï¼Œè¿‡æœŸ-key-å¦‚ä½•å¤„ç†ï¼Ÿ" class="headerlink" title="ä¸»ä»å¤åˆ¶æ¶æ„ä¸­ï¼Œè¿‡æœŸ key å¦‚ä½•å¤„ç†ï¼Ÿ"></a>ä¸»ä»å¤åˆ¶æ¶æ„ä¸­ï¼Œè¿‡æœŸ key å¦‚ä½•å¤„ç†ï¼Ÿ</h2><p>ä¸»èŠ‚ç‚¹å¤„ç†äº†ä¸€ä¸ªkeyæˆ–è€…é€šè¿‡æ·˜æ±°ç®—æ³•æ·˜æ±°äº†ä¸€ä¸ªkeyï¼Œè¿™ä¸ªæ—¶é—´ä¸»èŠ‚ç‚¹æ¨¡æ‹Ÿä¸€æ¡delå‘½ä»¤å‘é€ç»™ä»èŠ‚ç‚¹ï¼Œä»èŠ‚ç‚¹æ”¶åˆ°è¯¥å‘½ä»¤åï¼Œå°±è¿›è¡Œåˆ é™¤keyçš„æ“ä½œã€‚</p><h2 id="Redis-æ˜¯åŒæ­¥å¤åˆ¶è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Ÿ"><a href="#Redis-æ˜¯åŒæ­¥å¤åˆ¶è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Ÿ" class="headerlink" title="Redis æ˜¯åŒæ­¥å¤åˆ¶è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Ÿ"></a>Redis æ˜¯åŒæ­¥å¤åˆ¶è¿˜æ˜¯å¼‚æ­¥å¤åˆ¶ï¼Ÿ</h2><p>Redis ä¸»èŠ‚ç‚¹æ¯æ¬¡æ”¶åˆ°å†™å‘½ä»¤ä¹‹åï¼Œå…ˆå†™åˆ°å†…éƒ¨çš„ç¼“å†²åŒºï¼Œç„¶åå¼‚æ­¥å‘é€ç»™ä»èŠ‚ç‚¹ã€‚</p><h2 id="ä¸»ä»å¤åˆ¶ä¸­ä¸¤ä¸ª-Buffer-replication-buffer-ã€repl-backlog-buffer-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"><a href="#ä¸»ä»å¤åˆ¶ä¸­ä¸¤ä¸ª-Buffer-replication-buffer-ã€repl-backlog-buffer-æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ" class="headerlink" title="ä¸»ä»å¤åˆ¶ä¸­ä¸¤ä¸ª Buffer(replication buffer ã€repl backlog buffer)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ"></a>ä¸»ä»å¤åˆ¶ä¸­ä¸¤ä¸ª Buffer(replication buffer ã€repl backlog buffer)æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Ÿ</h2><ul><li>å‡ºç°çš„é˜¶æ®µä¸ä¸€æ ·<ul><li>repl backlog buffer æ˜¯åœ¨å¢é‡å¤åˆ¶é˜¶æ®µå‡ºç°ï¼Œ<strong>ä¸€ä¸ªä¸»èŠ‚ç‚¹åªåˆ†é…ä¸€ä¸ª repl backlog buffer</strong>ï¼›</li><li>replication buffer æ˜¯åœ¨å…¨é‡å¤åˆ¶é˜¶æ®µå’Œå¢é‡å¤åˆ¶é˜¶æ®µéƒ½ä¼šå‡ºç°ï¼Œ<strong>ä¸»èŠ‚ç‚¹ä¼šç»™æ¯ä¸ªæ–°è¿æ¥çš„ä»èŠ‚ç‚¹ï¼Œåˆ†é…ä¸€ä¸ª replication buffer</strong>ï¼›</li></ul></li><li>ä¸¤ä¸ªBufferéƒ½æœ‰å¤§å°é™åˆ¶ï¼Œå½“ç¼“å†²åŒºæ»¡äº†ä¹‹åï¼Œå‘ç”Ÿäº‹æƒ…ä¸ä¸€æ ·<ul><li>å½“ repl backlog buffer æ»¡äº†ï¼Œå› ä¸ºæ˜¯ç¯å½¢ç»“æ„ï¼Œä¼šç›´æ¥<strong>è¦†ç›–èµ·å§‹ä½ç½®æ•°æ®</strong>;</li><li>å½“ replication buffer æ»¡äº†ï¼Œä¼šå¯¼è‡´è¿æ¥æ–­å¼€ï¼Œåˆ é™¤ç¼“å­˜ï¼Œä»èŠ‚ç‚¹é‡æ–°è¿æ¥ï¼Œ<strong>é‡æ–°å¼€å§‹å…¨é‡å¤åˆ¶</strong>ã€‚</li></ul></li></ul><h2 id="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ</h2><p>ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Œå°±æ˜¯æŒ‡å®¢æˆ·ç«¯ä»ä»èŠ‚ç‚¹ä¸­è¯»å–åˆ°çš„å€¼å’Œä¸»èŠ‚ç‚¹ä¸­çš„æœ€æ–°å€¼å¹¶ä¸ä¸€è‡´ã€‚ä¹‹æ‰€ä»¥ä¼šå‡ºç°ä¸»ä»æ•°æ®ä¸ä¸€è‡´çš„ç°è±¡ï¼Œæ˜¯<strong>å› ä¸ºä¸»ä»èŠ‚ç‚¹é—´çš„å‘½ä»¤å¤åˆ¶æ˜¯å¼‚æ­¥è¿›è¡Œçš„</strong>ï¼Œæ‰€ä»¥æ— æ³•å®ç°å¼ºä¸€è‡´æ€§ä¿è¯ã€‚å…·ä½“æ¥è¯´ï¼Œåœ¨ä¸»ä»èŠ‚ç‚¹å‘½ä»¤ä¼ æ’­é˜¶æ®µï¼Œä¸»èŠ‚ç‚¹æ”¶åˆ°æ–°çš„å†™å‘½ä»¤åï¼Œä¼šå‘é€ç»™ä»èŠ‚ç‚¹ã€‚ä½†æ˜¯ï¼Œä¸»èŠ‚ç‚¹å¹¶ä¸ä¼šç­‰åˆ°ä»èŠ‚ç‚¹å®é™…æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå†æŠŠç»“æœè¿”å›ç»™å®¢æˆ·ç«¯ï¼Œè€Œæ˜¯ä¸»èŠ‚ç‚¹è‡ªå·±åœ¨æœ¬åœ°æ‰§è¡Œå®Œå‘½ä»¤åï¼Œå°±ä¼šå‘å®¢æˆ·ç«¯è¿”å›ç»“æœäº†ã€‚å¦‚æœä»èŠ‚ç‚¹è¿˜æ²¡æœ‰æ‰§è¡Œä¸»èŠ‚ç‚¹åŒæ­¥è¿‡æ¥çš„å‘½ä»¤ï¼Œä¸»ä»èŠ‚ç‚¹é—´çš„æ•°æ®å°±ä¸ä¸€è‡´äº†ã€‚</p><h2 id="å¦‚ä½•åº”å¯¹ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ"><a href="#å¦‚ä½•åº”å¯¹ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ" class="headerlink" title="å¦‚ä½•åº”å¯¹ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ"></a>å¦‚ä½•åº”å¯¹ä¸»ä»æ•°æ®ä¸ä¸€è‡´ï¼Ÿ</h2><ul><li>å°½é‡ä¿è¯ä¸»ä»èŠ‚ç‚¹é—´çš„ç½‘ç»œè¿æ¥çŠ¶å†µè‰¯å¥½ï¼Œé¿å…ä¸»ä»èŠ‚ç‚¹åœ¨ä¸åŒçš„æœºæˆ¿ã€‚</li><li>å¯ä»¥å¼€å‘ä¸€ä¸ªå¤–éƒ¨ç¨‹åºæ¥ç›‘æ§ä¸»ä»èŠ‚ç‚¹é—´çš„å¤åˆ¶è¿›åº¦ã€‚</li></ul><h2 id="ä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µæœºåˆ¶ï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µæœºåˆ¶ï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µæœºåˆ¶ï¼Ÿ"></a>ä¸ºä»€ä¹ˆä¼šæœ‰å“¨å…µæœºåˆ¶ï¼Ÿ</h2><p>åœ¨ Redis çš„ä¸»ä»æ¶æ„ä¸­ï¼Œç”±äºä¸»ä»æ¨¡å¼æ˜¯è¯»å†™åˆ†ç¦»çš„ï¼Œå¦‚æœä¸»èŠ‚ç‚¹ï¼ˆmasterï¼‰æŒ‚äº†ï¼Œé‚£ä¹ˆå°†æ²¡æœ‰ä¸»èŠ‚ç‚¹æ¥æœåŠ¡å®¢æˆ·ç«¯çš„å†™æ“ä½œè¯·æ±‚ï¼Œä¹Ÿæ²¡æœ‰ä¸»èŠ‚ç‚¹ç»™ä»èŠ‚ç‚¹ï¼ˆslaveï¼‰è¿›è¡Œæ•°æ®åŒæ­¥äº†ã€‚å®ƒçš„ä½œç”¨æ˜¯å®ç°<strong>ä¸»ä»èŠ‚ç‚¹æ•…éšœè½¬ç§»</strong>ã€‚å®ƒä¼šç›‘æµ‹ä¸»èŠ‚ç‚¹æ˜¯å¦å­˜æ´»ï¼Œå¦‚æœå‘ç°ä¸»èŠ‚ç‚¹æŒ‚äº†ï¼Œå®ƒå°±ä¼šé€‰ä¸¾ä¸€ä¸ªä»èŠ‚ç‚¹åˆ‡æ¢ä¸ºä¸»èŠ‚ç‚¹ï¼Œå¹¶ä¸”æŠŠæ–°ä¸»èŠ‚ç‚¹çš„ç›¸å…³ä¿¡æ¯é€šçŸ¥ç»™ä»èŠ‚ç‚¹å’Œå®¢æˆ·ç«¯ã€‚</p><p>å“¨å…µæœºåˆ¶ä¸»è¦è´Ÿè´£ä¸‰ä»¶äº‹æƒ…ï¼š<strong>ç›‘æ§ã€é€‰ä¸»ã€é€šçŸ¥</strong></p><h2 id="å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ"><a href="#å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ" class="headerlink" title="å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ"></a>å¦‚ä½•åˆ¤æ–­ä¸»èŠ‚ç‚¹çœŸçš„æ•…éšœäº†ï¼Ÿ</h2><p>å“¨å…µä¼šæ¯éš”1sç»™æ‰€æœ‰ä¸»ä»èŠ‚ç‚¹å‘é€PINGå‘½ä»¤ï¼Œå½“ä¸»ä»èŠ‚ç‚¹æ”¶åˆ°PINGå‘½ä»¤åï¼Œä¼šå‘é€å“åº”å‘½ä»¤ç»™å“¨å…µï¼Œå¦‚æœä¸»ä»èŠ‚ç‚¹æ²¡åœ¨è§„å®šæ—¶é—´å†…å“åº”å‘½ä»¤ï¼Œåˆ™è®¤ä¸ºå…¶ä¸»è§‚ä¸‹çº¿ï¼Œä½†æ˜¯å¯¹äºåˆ¤æ–­ä¸»èŠ‚ç‚¹æ˜¯å¦æ•…éšœé€šå¸¸æ˜¯éƒ¨ç½²å¤šä¸ªå“¨å…µèŠ‚ç‚¹ï¼Œè¿™æ ·ä¼šå‡å°‘è¯¯åˆ¤ï¼Œå½“å…¶ä¸­ä¸€ä¸ªå“¨å…µè®¤ä¸ºä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿æ—¶ï¼Œå°±ä¼šæŠ¥å‘Šç»™å…¶ä»–å“¨å…µï¼Œå…¶ä»–å“¨å…µå¯¹è¯¥ä¸»èŠ‚ç‚¹æ¥è¿›è¡Œåˆ¤æ–­æ˜¯å¦ä¸‹çº¿ï¼Œæœ€åæ ¹æ®æ€»çš„èµåŒç¥¨æ•°æ¥åˆ¤æ–­æ˜¯å¦å®¢è§‚ä¸‹çº¿ã€‚</p><h2 id="ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ"><a href="#ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ" class="headerlink" title="ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ"></a>ç”±å“ªä¸ªå“¨å…µè¿›è¡Œä¸»ä»æ•…éšœè½¬ç§»ï¼Ÿ</h2><p>é¦–å…ˆç”±å‘ç°ä¸»èŠ‚ç‚¹ä¸»è§‚ä¸‹çº¿çš„å“¨å…µä½œä¸ºå€™é€‰è€…ï¼Œç„¶åå‘èµ·æŠ•ç¥¨ï¼Œå½“åªæœ‰ä¸€ä¸ªå€™é€‰è€…æ—¶ï¼Œå®ƒå¯ä»¥æŠŠç¥¨æŠ•ç»™è‡ªå·±æˆ–è€…ä»–äººï¼Œç„¶åå¾è¯¢å…¶ä»–å“¨å…µçš„æŠ•ç¥¨ï¼Œè¦æˆåŠŸé€‰ä¸¾ä¸ºleaderï¼Œéœ€è¦æ»¡è¶³ä¸¤ä¸ªæ¡ä»¶</p><ul><li>æ‹¿åˆ°åŠæ•°ä»¥ä¸Šçš„èµæˆç¥¨ï¼›</li><li>æ‹¿åˆ°çš„ç¥¨æ•°åŒæ—¶è¿˜éœ€è¦å¤§äºç­‰äºå“¨å…µé…ç½®æ–‡ä»¶ä¸­çš„ quorum å€¼ã€‚</li></ul><p>å½“æœ‰å¤šä¸ªå€™é€‰è€…æ—¶ï¼Œå€™é€‰è€…ä¼šå…ˆç»™è‡ªå·±æŠ•ä¸€ç¥¨ï¼Œç„¶åå‘å…¶ä»–å“¨å…µå‘èµ·æŠ•ç¥¨è¯·æ±‚ã€‚å¦‚æœæŠ•ç¥¨è€…å…ˆæ”¶åˆ°ã€Œå€™é€‰è€… Aã€çš„æŠ•ç¥¨è¯·æ±‚ï¼Œå°±ä¼šå…ˆæŠ•ç¥¨ç»™å®ƒï¼Œå¦‚æœæŠ•ç¥¨è€…ç”¨å®ŒæŠ•ç¥¨æœºä¼šåï¼Œæ”¶åˆ°ã€Œå€™é€‰è€… Bã€çš„æŠ•ç¥¨è¯·æ±‚åï¼Œå°±ä¼šæ‹’ç»æŠ•ç¥¨ã€‚è¿™æ—¶ï¼Œå€™é€‰è€… A å…ˆæ»¡è¶³äº†ä¸Šé¢çš„é‚£ä¸¤ä¸ªæ¡ä»¶ï¼Œæ‰€ä»¥ã€Œå€™é€‰è€… Aã€å°±ä¼šè¢«é€‰ä¸¾ä¸º Leaderã€‚</p><h2 id="ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰3ä¸ªï¼Ÿ"><a href="#ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰3ä¸ªï¼Ÿ" class="headerlink" title="ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰3ä¸ªï¼Ÿ"></a>ä¸ºä»€ä¹ˆå“¨å…µèŠ‚ç‚¹è‡³å°‘è¦æœ‰3ä¸ªï¼Ÿ</h2><p>å¦‚æœè¦æ˜¯2ä¸ªå“¨å…µï¼Œå…¶ä¸­ä¸€ä¸ªå“¨å…µè¦æˆä¸ºleaderï¼Œå¿…é¡»è·å¾—2ç¥¨ï¼Œå¦‚æœä¸€ä¸ªå“¨å…µæŒ‚æ‰ï¼Œåˆ™æ— æ³•å®Œæˆä¸»ä»åˆ‡æ¢ã€‚</p><h2 id="ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"><a href="#ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ" class="headerlink" title="ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ"></a>ä¸»ä»æ•…éšœè½¬ç§»çš„è¿‡ç¨‹æ˜¯æ€æ ·çš„ï¼Ÿ</h2><ul><li>åœ¨å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹ï¼ˆæ—§ä¸»èŠ‚ç‚¹ï¼‰å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€é‡Œé¢ï¼ŒæŒ‘é€‰å‡ºä¸€ä¸ªä»èŠ‚ç‚¹ï¼Œå¹¶å°†å…¶è½¬æ¢ä¸ºä¸»èŠ‚ç‚¹<ul><li>è¿‡æ»¤æ‰å·²ç»ç¦»çº¿çš„ä»èŠ‚ç‚¹ï¼›</li><li>è¿‡æ»¤æ‰å†å²ç½‘ç»œè¿æ¥çŠ¶æ€ä¸å¥½çš„ä»èŠ‚ç‚¹ï¼›</li><li>å°†å‰©ä¸‹çš„ä»èŠ‚ç‚¹ï¼Œè¿›è¡Œä¸‰è½®è€ƒå¯Ÿï¼šä¼˜å…ˆçº§ï¼ˆè¶Šå°è¶Šé å‰ï¼‰ã€å¤åˆ¶è¿›åº¦ï¼ˆè¶Šå¤§è¶Šé å‰ï¼‰ã€ID å·ï¼ˆé€‰æ‹©å°çš„ï¼‰ã€‚åœ¨æ¯ä¸€è½®è€ƒå¯Ÿè¿‡ç¨‹ä¸­ï¼Œå¦‚æœæ‰¾åˆ°äº†ä¸€ä¸ªèƒœå‡ºçš„ä»èŠ‚ç‚¹ï¼Œå°±å°†å…¶ä½œä¸ºæ–°ä¸»èŠ‚ç‚¹ã€‚</li></ul></li><li>è®©å·²ä¸‹çº¿ä¸»èŠ‚ç‚¹å±ä¸‹çš„æ‰€æœ‰ã€Œä»èŠ‚ç‚¹ã€ä¿®æ”¹å¤åˆ¶ç›®æ ‡ï¼Œä¿®æ”¹ä¸ºå¤åˆ¶ã€Œæ–°ä¸»èŠ‚ç‚¹ã€ï¼›</li><li>å°†æ–°ä¸»èŠ‚ç‚¹çš„ IP åœ°å€å’Œä¿¡æ¯ï¼Œé€šè¿‡ã€Œå‘å¸ƒè€…&#x2F;è®¢é˜…è€…æœºåˆ¶ã€é€šçŸ¥ç»™å®¢æˆ·ç«¯ï¼›</li><li>ç»§ç»­ç›‘è§†æ—§ä¸»èŠ‚ç‚¹ï¼Œå½“è¿™ä¸ªæ—§ä¸»èŠ‚ç‚¹é‡æ–°ä¸Šçº¿æ—¶ï¼Œå°†å®ƒè®¾ç½®ä¸ºæ–°ä¸»èŠ‚ç‚¹çš„ä»èŠ‚ç‚¹ï¼›</li></ul><h2 id="æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•ä¿æŒä¸€è‡´æ€§ï¼Ÿ"><a href="#æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•ä¿æŒä¸€è‡´æ€§ï¼Ÿ" class="headerlink" title="æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•ä¿æŒä¸€è‡´æ€§ï¼Ÿ"></a>æ•°æ®åº“å’Œç¼“å­˜å¦‚ä½•ä¿æŒä¸€è‡´æ€§ï¼Ÿ</h2><ul><li>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜</li></ul><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/8febac10b14bed16cb96d1d944cd08da-17201898929203.png" alt="å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†æ›´æ–°ç¼“å­˜"></p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><ol><li>åœ¨æ›´æ–°ç¼“å­˜å‰å…ˆåŠ ä¸ª<strong>åˆ†å¸ƒå¼é”</strong>ï¼Œä¿è¯åŒä¸€æ—¶é—´åªè¿è¡Œä¸€ä¸ªè¯·æ±‚æ›´æ–°ç¼“å­˜ï¼Œå°±ä¼šä¸ä¼šäº§ç”Ÿå¹¶å‘é—®é¢˜äº†ï¼Œå½“ç„¶å¼•å…¥äº†é”åï¼Œå¯¹äºå†™å…¥çš„æ€§èƒ½å°±ä¼šå¸¦æ¥å½±å“ã€‚</li><li>åœ¨æ›´æ–°å®Œç¼“å­˜æ—¶ï¼Œç»™ç¼“å­˜åŠ ä¸Šè¾ƒçŸ­çš„<strong>è¿‡æœŸæ—¶é—´</strong>ï¼Œè¿™æ ·å³æ—¶å‡ºç°ç¼“å­˜ä¸ä¸€è‡´çš„æƒ…å†µï¼Œç¼“å­˜çš„æ•°æ®ä¹Ÿä¼šå¾ˆå¿«è¿‡æœŸï¼Œå¯¹ä¸šåŠ¡è¿˜æ˜¯èƒ½æ¥å—çš„ã€‚</li></ol><ul><li>å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</li></ul><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/454a8228a6549176ad7e0484fba3c92b-17201899143475.png" alt="å…ˆæ›´æ–°ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></p><p>ä»¥ä¸Šä¸¤ç§æ–¹æ³•éƒ½ä¼šå‡ºç°å¹¶å‘è¯·æ±‚å¯¼è‡´çš„æ•°æ®ä¸ä¸€è‡´é—®é¢˜ï¼</p><ul><li>å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“</li></ul><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/cc208c2931b4e889d1a58cb655537767-17201899364547.png" alt="å…ˆåˆ é™¤ç¼“å­˜ï¼Œå†æ›´æ–°æ•°æ®åº“"></p><ul><li>ã€Œå…ˆæ›´æ–°æ•°æ®åº“ + å†åˆ é™¤ç¼“å­˜ã€ï¼ˆ<strong>Cache Aside ç­–ç•¥</strong>ï¼‰çš„æ–¹æ¡ˆï¼Œæ˜¯å¯ä»¥ä¿è¯æ•°æ®ä¸€è‡´æ€§çš„ã€‚</li></ul><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/1cc7401143e79383ead96582ac11b615-17201899485609.png" alt="å…ˆæ›´æ–°æ•°æ®åº“ + å†åˆ é™¤ç¼“å­˜"></p><p>ç†è®ºä¸Šåˆ†æï¼Œå…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ é™¤ç¼“å­˜ä¹Ÿæ˜¯ä¼šå‡ºç°æ•°æ®ä¸ä¸€è‡´æ€§çš„é—®é¢˜ï¼Œ<strong>ä½†æ˜¯åœ¨å®é™…ä¸­ï¼Œè¿™ä¸ªé—®é¢˜å‡ºç°çš„æ¦‚ç‡å¹¶ä¸é«˜</strong>ã€‚<strong>å› ä¸ºç¼“å­˜çš„å†™å…¥é€šå¸¸è¦è¿œè¿œå¿«äºæ•°æ®åº“çš„å†™å…¥</strong>ï¼Œæ‰€ä»¥åœ¨å®é™…ä¸­å¾ˆéš¾å‡ºç°è¯·æ±‚ B å·²ç»æ›´æ–°äº†æ•°æ®åº“å¹¶ä¸”åˆ é™¤äº†ç¼“å­˜ï¼Œè¯·æ±‚ A æ‰æ›´æ–°å®Œç¼“å­˜çš„æƒ…å†µã€‚</p><h2 id="å¦‚ä½•è§£å†³å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜æƒ…å†µä¸‹ï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Ÿ"><a href="#å¦‚ä½•è§£å†³å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜æƒ…å†µä¸‹ï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Ÿ" class="headerlink" title="å¦‚ä½•è§£å†³å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜æƒ…å†µä¸‹ï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Ÿ"></a>å¦‚ä½•è§£å†³å…ˆæ›´æ–°æ•°æ®åº“å†åˆ é™¤ç¼“å­˜æƒ…å†µä¸‹ï¼Œåˆ é™¤ç¼“å­˜å¤±è´¥å¯¼è‡´æ•°æ®ä¸ä¸€è‡´çš„é—®é¢˜ï¼Ÿ</h2><p><img src="/2024/07/05/Redis%E5%85%AB%E8%82%A1%E6%96%87/2a2ea2854bbc3ae8ae86d7da45fa32ee-172018996851611.png" alt="å¤±è´¥æƒ…å†µ"></p><ul><li>é‡è¯•æœºåˆ¶ï¼šå¯ä»¥å¼•å…¥<strong>æ¶ˆæ¯é˜Ÿåˆ—</strong>ï¼Œå°†ç¬¬äºŒä¸ªæ“ä½œï¼ˆåˆ é™¤ç¼“å­˜ï¼‰è¦æ“ä½œçš„æ•°æ®åŠ å…¥åˆ°æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç”±æ¶ˆè´¹è€…æ¥æ“ä½œæ•°æ®ã€‚<ul><li>å¦‚æœåº”ç”¨<strong>åˆ é™¤ç¼“å­˜å¤±è´¥</strong>ï¼Œå¯ä»¥ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­é‡æ–°è¯»å–æ•°æ®ï¼Œç„¶åå†æ¬¡åˆ é™¤ç¼“å­˜ï¼Œè¿™ä¸ªå°±æ˜¯<strong>é‡è¯•æœºåˆ¶</strong>ã€‚å½“ç„¶ï¼Œå¦‚æœé‡è¯•è¶…è¿‡çš„ä¸€å®šæ¬¡æ•°ï¼Œè¿˜æ˜¯æ²¡æœ‰æˆåŠŸï¼Œæˆ‘ä»¬å°±éœ€è¦å‘ä¸šåŠ¡å±‚å‘é€æŠ¥é”™ä¿¡æ¯äº†ã€‚</li><li>å¦‚æœ<strong>åˆ é™¤ç¼“å­˜æˆåŠŸ</strong>ï¼Œå°±è¦æŠŠæ•°æ®ä»æ¶ˆæ¯é˜Ÿåˆ—ä¸­ç§»é™¤ï¼Œé¿å…é‡å¤æ“ä½œï¼Œå¦åˆ™å°±ç»§ç»­é‡è¯•ã€‚</li></ul></li><li>è®¢é˜… MySQL binlogï¼Œå†æ“ä½œç¼“å­˜ï¼šã€Œ<strong>å…ˆæ›´æ–°æ•°æ®åº“ï¼Œå†åˆ ç¼“å­˜</strong>ã€çš„ç­–ç•¥çš„ç¬¬ä¸€æ­¥æ˜¯æ›´æ–°æ•°æ®åº“ï¼Œé‚£ä¹ˆæ›´æ–°æ•°æ®åº“æˆåŠŸï¼Œå°±ä¼šäº§ç”Ÿä¸€æ¡å˜æ›´æ—¥å¿—ï¼Œè®°å½•åœ¨ binlog é‡Œã€‚äºæ˜¯æˆ‘ä»¬å°±å¯ä»¥é€šè¿‡è®¢é˜… binlog æ—¥å¿—ï¼Œæ‹¿åˆ°å…·ä½“è¦æ“ä½œçš„æ•°æ®ï¼Œç„¶åå†æ‰§è¡Œç¼“å­˜åˆ é™¤ã€‚</li></ul>]]></content>
    
    
    <categories>
      
      <category>å…«è‚¡</category>
      
      <category>Redis</category>
      
    </categories>
    
    
    <tags>
      
      <tag>å…«è‚¡</tag>
      
      <tag>Redis</tag>
      
    </tags>
    
  </entry>
  
  
  
  
</search>
